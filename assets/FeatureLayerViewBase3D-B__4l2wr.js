const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Feature3DPipeline-O0pA_ykt.js","assets/index-gvPOfpe8.js","assets/index-BKTKGLs8.css","assets/isFeatureGraphicOrigin-YA2hudPe.js","assets/AttributeBinsFeatureSet-D8hfXjPa.js","assets/utils-DoV9uudS.js","assets/LodRenderer-BwT4tsij.js","assets/highlightUtils-CDuu2yVo.js","assets/HeatmapDensity.glsl-Cizvuf-u.js","assets/timeSupport-YpXSoWpa.js","assets/utils-E8xwJrtL.js","assets/AttributeBinsQuery-B_LrLS1H.js","assets/FixedIntervalBinParameters-DQTiTS-j.js","assets/attributeUtils-Dc8--CBJ.js","assets/highlightOptionsUtils-8HK9kalC.js","assets/FeatureTileDescriptor-CPJ9qBU5.js","assets/dehydratedFeatureComparison-D_Wi1pQE.js","assets/utils-Jehaj4Bt.js","assets/cimSymbolUtils-UzhRupYx.js","assets/queryForSymbologySnapping-C9cdDi0D.js","assets/Graphics3DFeatureProcessor-B7rtHc0I.js","assets/hash-CcEbRgUF.js","assets/renderingInfoUtils-3nNCIsjd.js","assets/ExtentSet-mMwmcMgi.js","assets/optimizedFeatureQueryEngineAdapter-BgUzMm9N.js","assets/popupUtils-DJGMspKt.js","assets/Graphics3DObjectStates-Cv3yLdvv.js","assets/floorFilterUtils-DZ5C6FQv.js","assets/QueryEngine-zlJMaRhN.js","assets/WhereClauseCache-DoN6TNFc.js","assets/WhereClause-49uqwjfS.js","assets/utils-CgaMQJrF.js","assets/utils-BDkbrCUA.js","assets/utils-CDvai-ew.js","assets/ClassBreaksDefinition-OQ9--XKI.js","assets/SnappingCandidate-DGkpYqI6.js","assets/FeatureStore-BrLYI8Fu.js","assets/BoundsStore-DvwYzGbP.js","assets/LayerView3D-MdDXa7s2.js","assets/query-reBxiem4.js","assets/pbfQueryUtils-CVKUNXBw.js","assets/pbf-2RjY5TW8.js","assets/queryZScale-CpiyGFHR.js","assets/EventedSet-CJzpL0fS.js","assets/FeatureIdInfo-iL5WjyEH.js","assets/constants-SxxbBSOD.js","assets/featurePopupQueryUtils-BLcavpWW.js","assets/LayerView-DiMFVtue.js","assets/RefreshableLayerView-DwoqNLsz.js"])))=>i.map(i=>d[i]);
import{k as z,aL as Q,bd as B,gD as W,cq as J,q as M,o$ as K,bF as P,bZ as Y,s2 as U,u as q,_ as l,m as n,b,K as C,s3 as X,a as L,N as V,g as ee,s4 as te,s5 as re,dF as ie,c2 as E,Y as k,cc as se,s6 as ae,s7 as le,s8 as ne,ax as I,s9 as oe,bs as Z,cd as O,sa as ue,ox as j,sb as pe,oy as H,sc as de,sd as ce,qM as m,se as he,sf as ye,sg as x,b3 as fe,sh as me,l as ge,c as Fe,si as be,s as we,o as xe}from"./index-gvPOfpe8.js";import{V as _e,L as ve,v as Ie}from"./HeatmapDensity.glsl-Cizvuf-u.js";import{l as Re}from"./LayerView3D-MdDXa7s2.js";import{j as Ce,y as qe}from"./query-reBxiem4.js";import{s as Ee}from"./EventedSet-CJzpL0fS.js";import{e as Oe}from"./FeatureIdInfo-iL5WjyEH.js";import{E as Pe}from"./constants-SxxbBSOD.js";import{n as Me,s as Ve}from"./featurePopupQueryUtils-BLcavpWW.js";import{o as G}from"./floorFilterUtils-DZ5C6FQv.js";import{a as $e}from"./Graphics3DFeatureProcessor-B7rtHc0I.js";import{n as Te,p as Se}from"./popupUtils-DJGMspKt.js";import{d as De}from"./LayerView-DiMFVtue.js";import{i as Ne}from"./RefreshableLayerView-DwoqNLsz.js";let Qe=class extends z{constructor(e,s,r,i,a,o){super(e.usedMemory,e.displayedFeatures,e.totalFeatures,e.maximumFeatures,e.nodes,e.core),this.storedFeatures=s,this.totalVertices=r,this.partial=i,this.mode=a,this.symbolComplexity=o}};class Le{constructor(e){this._controller=e,this._handle=new Ze(s=>e.schedule(s))}destroy(){this._handle.destroy()}invoke(e,s){return e.buffer&&e.buffer.byteLength!==0?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof Q&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,s).then(r=>{let i=0,a=0;const o=Q.fromJSON(r.spatialReference);r.spatialReference=o;const p=async d=>{const u=r.fields;if(u){for(;i<u.length;)if(u[i]=B.fromJSON(u[i]),i++,d.madeProgress())return this._controller.reschedule(F=>p(F))}const h=r.features;for(;a<h.length;){const F=h[a];++a,F.uid=W();const w=F.geometry;if(w!=null&&(w.spatialReference=o,ke(w),d.madeProgress()))return this._controller.reschedule(v=>p(v))}return r};return this._controller.schedule(d=>p(d))})):Promise.resolve(null)}}function ke(t){switch(t.type){case"polyline":t.paths=t.hasZ&&t.hasM?t.paths.map(e=>e.map(s=>[s[0],s[1],s[2],s[3]])):t.hasZ||t.hasM?t.paths.map(e=>e.map(s=>[s[0],s[1],s[2]])):t.paths.map(e=>e.map(s=>[s[0],s[1]]));break;case"polygon":t.rings=t.hasZ&&t.hasM?t.rings.map(e=>e.map(s=>[s[0],s[1],s[2],s[3]])):t.hasZ||t.hasM?t.rings.map(e=>e.map(s=>[s[0],s[1],s[2]])):t.rings.map(e=>e.map(s=>[s[0],s[1]]))}}class Ze extends J{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:s=>[s.buffer]},e)}}let g=class extends M{constructor(t){super(t)}get implicitFields(){var r;if(!((r=this.layer.outFields)==null?void 0:r.includes("*")))return new Set;const e=new Set(this.layerView.requiredFields),s=new Set(this.layerView.availableFields);return K(s,e)}get queryFeaturesDehydrated(){var a;const{layer:t}=this,e=t.capabilities,s=e&&e.query,r=s&&s.supportsFormatPBF,i=t.parsedUrl;if(r){this._decoder==null&&(this._decoder=new Le(this.controller));const o={sourceSpatialReference:((a=t.spatialReference)==null?void 0:a.toJSON())??null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:A};return(p,d)=>Ce(i,p,"pbf",this._createRequestOptions(d)).then(u=>(P(d),this._decoder!=null?this._decoder.invoke({buffer:u.data,options:o},d.signal):Promise.reject(Y())))}return(o,p)=>qe(i,o,t.spatialReference,this._createRequestOptions(p)).then(d=>U(d.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:A}))}queryFeatureCount(t,e){return this.layer.queryFeatureCount(t,e)}destroy(){this._decoder=q(this._decoder)}_createRequestOptions(t){return{...t,query:{...this.layer.customParameters,token:this.layer.apiKey,...t==null?void 0:t.query}}}};l([n({constructOnly:!0})],g.prototype,"layer",void 0),l([n({constructOnly:!0})],g.prototype,"layerView",void 0),l([n({constructOnly:!0})],g.prototype,"controller",void 0),l([n({readOnly:!0})],g.prototype,"implicitFields",null),l([n({readOnly:!0})],g.prototype,"queryFeaturesDehydrated",null),g=l([b("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],g);let R=class extends M{constructor(e){super(e)}queryFeaturesDehydrated(e,s){return this.layer.queryFeatures(e,s)}};l([n({constructOnly:!0})],R.prototype,"layer",void 0),R=l([b("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileOGCServiceQuery3D")],R);let _=class extends M{constructor(t){super(t)}queryFeaturesDehydrated(t,e){return this.source.queryFeaturesJSON(t,e).then(U,s=>{if(s&&s.name==="query-features-json:unsupported")return this.layer.queryFeatures(t,e);throw s})}queryFeatureCount(t,e){return this.layer.queryFeatureCount(t,e)}};function je(t,e){const{layer:s}=t;return s.type==="feature"&&s.source.type==="feature-layer"||s.type==="catalog-footprint"?new g({layer:s,layerView:t,controller:e}):s.type==="feature"&&s.source.type==="memory"||s.type==="csv"||s.type==="geojson"||s.type==="oriented-imagery"||s.type==="wfs"?new _({layer:s,source:s.source}):s.type==="ogc-feature"?new R({layer:s}):null}l([n({constructOnly:!0})],_.prototype,"layer",void 0),l([n({constructOnly:!0})],_.prototype,"source",void 0),_=l([b("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],_);const A=1024;class He{constructor(e){this._memoryCache=null;const s=e.layerView.layer;this._layerView=e.layerView,this.objectIdField=s.objectIdField,this.globalIdField="globalIdField"in s?s.globalIdField:null,this._returnZ=e.returnZ,this._returnM=e.returnM;const r=this._layerView.view.resourceController;this.query=je(this._layerView,r.normal),r&&this._memoryCacheEnabled&&(this._memoryCache=r.memoryController.newCache(`fl-${s.uid}`))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"parquet":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=q(this._memoryCache),this.query.destroy()}createQuery(){var s;const e=this._layerView.layer.createQuery();return e.outFields=this._layerView.availableFieldsForQuery,e.returnZ=this._returnZ,e.returnM=this._returnM,e.outSpatialReference=((s=this.tilingScheme)==null?void 0:s.spatialReference)??this._layerView.view.spatialReference,e}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){var e;return(e=this._layerView.view.featureTiles)==null?void 0:e.tilingScheme}get scheduler(){var e;return(e=this._layerView.view.resourceController)==null?void 0:e.scheduler}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get standardMaxRecordCount(){return this._layerView.layer.capabilities.query.standardMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get isDraped(){var e;return((e=this._layerView.layer.elevationInfo)==null?void 0:e.mode)==="on-the-ground"}get effectiveDisplayFilter(){return this._layerView.displayFilterEnabled?this._layerView.effectiveDisplayFilter:null}get highlightIds(){return this._layerView.displayFilterEnabled?this._layerView.highlightIds:null}get capabilities(){return this._capabilities??(this._capabilities=Ge(this._layerView.layer)),this._capabilities}logFetchError(e,s){e.error("#fetchTile()",this._layerView.layer,(s==null?void 0:s.message)??s)}}function Ge(t){const e=t.capabilities.query;return{supportsMultipleResolutions:Ae(t),supportsPagination:!(!e||!e.supportsPagination),supportsResultType:!(!e||!e.supportsResultType),supportsCacheHint:!(!e||!e.supportsCacheHint),supportsQuantization:!(!e||!e.supportsQuantization),supportsQuantizationEditMode:!(!e||!e.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!e||!e.supportsMaxRecordCountFactor),supportsFormatPBF:!(!e||!e.supportsFormatPBF)}}function Ae(t){switch(t.geometryType){case"polyline":return!0;case"polygon":return t.capabilities&&t.capabilities.query&&t.capabilities.query.supportsQuantization;default:return!1}}let y=class extends _e{constructor(t){super(t),this._controllerTotal=0,this._processorTotal=0,this._needsRefresh=!1,this.suspendResumeExtentMode="data"}initialize(){this.addHandles(C(()=>({controller:this.controller,suspended:this.suspended}),({controller:t,suspended:e})=>{t&&!e&&this._needsRefresh&&(t.refetch(),this._needsRefresh=!1)}))}destroy(){this._fetcherContext=q(this._fetcherContext)}get maximumNumberOfFeatures(){var t;return((t=this.controller)==null?void 0:t.maximumNumberOfFeatures)??this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(t){this._set("maximumNumberOfFeatures",t),this.controller&&(this.controller.maximumNumberOfFeatures=t)}get snappingComplexityExceeded(){var t;return((t=this.controller)==null?void 0:t.snappingComplexityExceeded)??!0}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){var s,r;let t=0;if((s=this.controller)!=null&&s.updating){const i=this.controller.updatingRemaining,a=Math.max(this.controller.updatingTotal,this._controllerTotal);a>0&&(t=(a-i)/a,this._controllerTotal=a)}let e=0;if((r=this.processor)!=null&&r.updating){const i=this.processor.updatingRemaining,a=Math.max(i,this._processorTotal);a>0&&(e=(a-i)/a,this._processorTotal=a)}return .5*(t+e)}get updatePolicy(){if(!this.controller)return 0;switch(this.controller.mode){case"snapshot":{const t=Ue.get(this.layer.geometryType);return t==null||this.controller.serviceDataCount>t?0:1}case"tiles":return 0}}get usedMemory(){var t,e;return(((t=this.processor)==null?void 0:t.usedMemory)??0)+(((e=this.controller)==null?void 0:e.memoryForUnusedFeatures)??0)}get unloadedMemory(){var i,a,o,p;const t=((i=this.processor)==null?void 0:i.unprocessedMemoryEstimate)??0,e=((a=this.controller)==null?void 0:a.expectedFeatureDiff)??0,s=((o=this.processor)==null?void 0:o.loadedFeatures)??0,r=s+e>0?s/(s+e):1;return t+e*(((p=this.processor)==null?void 0:p.usedMemoryPerFeature)??0)*r}get ignoresMemoryFactor(){var t;return(t=this.controller)==null?void 0:t.hasMaximumNumberOfFeaturesOverride}get performanceInfo(){var r,i,a,o,p,d;const t=(r=this.controller)==null?void 0:r.displayFeatureLimit,e=t!=null?t.averageSymbolComplexity:void 0,s=e!=null?`f:${e.verticesPerFeature},v:${e.verticesPerCoordinate}`:"n/a";return new Qe(super.performanceInfo,((a=(i=this.controller)==null?void 0:i.performanceInfo)==null?void 0:a.storedFeatures)??0,((p=(o=this.controller)==null?void 0:o.performanceInfo)==null?void 0:p.totalVertices)??0,this.maximumNumberOfFeaturesExceeded,((d=this.controller)==null?void 0:d.mode)??"n/a",s)}async doRefresh(t){const{controller:e,processor:s,suspended:r}=this;t&&e&&(r?this._needsRefresh=!0:(e.refetch(),this._needsRefresh=!1)),s.refreshFilter()}setVisibility(t,e){var s;(s=this.processor)==null||s.setObjectIdVisibility(t,e)}getMissingAttributesForFeature(t){return this.controller.getMissingAttributesForFeature(t)}getHydratedGeometry(t){const e=this.graphics3DProcessor;if(e==null)return null;const s=e.graphics3DGraphicsByObjectID;if(s==null)return null;const r=s.get(t);return r==null?null:X(r.graphic.geometry)}createController(){this._fetcherContext=new He({layerView:this.layerView,returnZ:this.hasZ,returnM:this.hasM});const t=new ve({layerView:this.layerView,context:this._fetcherContext,graphics:new Ee,extent:this.clippingExtent});return this.updatingHandles.add(()=>t.serviceDataExtent,e=>{this.processor&&(this.processor.dataExtent=e)},L),this.addHandles(C(()=>this.suspended&&this.layerView.updateSuspended,e=>{e?t.suspend():t.resume()},V)),this.updatingHandles.add(()=>{var e;return(e=this.processor)==null?void 0:e.displayFeatureLimit},e=>t.displayFeatureLimit=e,L),this.addHandles(ee(()=>!this.updating,()=>{this._controllerTotal=0,this._processorTotal=0})),t}beforeSetController(t){t.maximumNumberOfFeatures=this.maximumNumberOfFeatures}get test(){return{controller:this.controller,graphics3DProcessor:this.graphics3DProcessor,heatmapProcessor:this.heatmapProcessor,loadedGraphics:this.loadedGraphics}}};l([n()],y.prototype,"layerView",void 0),l([n()],y.prototype,"controller",void 0),l([n()],y.prototype,"_controllerTotal",void 0),l([n()],y.prototype,"_processorTotal",void 0),l([n()],y.prototype,"_needsRefresh",void 0),l([n()],y.prototype,"maximumNumberOfFeatures",null),l([n()],y.prototype,"snappingComplexityExceeded",null),l([n()],y.prototype,"maximumNumberOfFeaturesExceeded",null),l([n()],y.prototype,"updatingProgressValue",null),l([n()],y.prototype,"updatePolicy",null),l([n()],y.prototype,"suspendResumeExtentMode",void 0),y=l([b("esri.views.3d.layers.graphics.FeatureGraphics3DGraphicsPipeline")],y);const Ue=new Map([["point",5e3],["polygon",500],["polyline",1e3]]);function ze(t,e){if(e.type!=="feature"&&e.type!=="subtype-group")return[];if(!e.url)return[];const s="utilityNetworks"in t.map?t.map.utilityNetworks??[]:[];for(const r of s)if(r.isUtilityLayer(e)){const i=e.fieldsIndex.get("assetgroup"),a=e.fieldsIndex.get("assettype");return[i==null?void 0:i.name,a==null?void 0:a.name].filter(o=>o!=null)}return[]}class Be{constructor(e){this._fieldsIndex=e,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(e=>e.currentUserRequired)}}visitClientWhereClause(e){e&&this._clauses.push(te(e,this._fieldsIndex))}visitFeatureReduction(e){if(e)switch(e.type){case"binning":case"cluster":this.visitLabelingInfo(e.labelsVisible,e.labelingInfo)}}visitLabelingInfo(e,s){if(e&&s!=null)for(const r of s)this.visitClientWhereClause(r.where)}visitDisplayFilter(e,s){if(e)for(const r of(s==null?void 0:s.filters)??[])this.visitClientWhereClause(r.where)}visitFilter(e){this.visitClientWhereClause(e==null?void 0:e.where)}visitTrackInfo(e){e!=null&&(this.visitLabelingInfo(e==null?void 0:e.latestObservations.labelsVisible,e==null?void 0:e.latestObservations.labelingInfo),this.visitLabelingInfo(e==null?void 0:e.previousObservations.labelsVisible,e==null?void 0:e.previousObservations.labelingInfo),this.visitLabelingInfo(e==null?void 0:e.trackLines.labelsVisible,e==null?void 0:e.trackLines.labelingInfo))}}const We=t=>{const e=t;let s=class extends e{constructor(...r){super(...r),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([C(()=>{var a,o,p,d,u;const r=this.layer,i=this.view;return[r&&"elevationInfo"in r?(a=r.elevationInfo)==null?void 0:a.featureExpressionInfo:null,r&&"displayField"in r?r.displayField:null,r&&"timeInfo"in r&&r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,((o=i==null?void 0:i.requiredFieldsOptions)==null?void 0:o.featureTitleFields)&&r&&"featureTitleFields"in r&&r.featureTitleFields,((p=i==null?void 0:i.requiredFieldsOptions)==null?void 0:p.utilityNetworkFields)&&ze(i,r),r.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,(r==null?void 0:r.type)==="knowledge-graph-sublayer"&&r.parentCompositeLayer.type==="link-chart"&&((u=(d=r.parentCompositeLayer.linkChart)==null?void 0:d.linkChartProperties.nonspatialDataDisplay)==null?void 0:u.mode)]},()=>this._handleChange(),V),E(()=>{var r;return(r=this.view)==null?void 0:r.floors},"change",()=>this._handleChange()),E(()=>{var r;return(r=this.layer.displayFilterInfo)==null?void 0:r.filters},"change",()=>this._handleChange()),E(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];const{layer:r,layer:{fieldsIndex:i},requiredFields:a}=this;return"outFields"in r&&r.outFields?k(i,[...se(i,r.outFields),...a]):k(i,a)}get displayFilterEnabled(){var r,i;return(((r=this.view)==null?void 0:r.displayFilterEnabled)??!0)&&(!("displayFilterEnabled"in this.layer)||(((i=this.layer)==null?void 0:i.displayFilterEnabled)??!0))}get effectiveDisplayFilter(){const r=this.layer;return this.displayFilterEnabled&&r.displayFilterInfo?ae(r.displayFilterInfo,this.view):null}get effectiveDisplayFilterClause(){var i;const r=((i=this.effectiveDisplayFilter)==null?void 0:i.where)??null;return r&&this.hasHighlight?le(r,ne(this.layer.objectIdField,this.highlightIds)):r}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){this._override("featureEffect",r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){I.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){var r;return(r=this.layer)!=null&&r.url?oe(this.layer.url):Promise.resolve(null)}highlight(r,i){throw new Error("missing implementation")}createQuery(){var a;const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},i=this.filter!=null?this.filter.createQuery(r):new Z(r);return"floorInfo"in this.layer&&this.layer.floorInfo&&(i.where=O(i.where,G(this))),this.displayFilterEnabled&&(i.where=O(i.where,(a=this.effectiveDisplayFilter)==null?void 0:a.where)),this.timeExtent!=null&&(i.timeExtent=i.timeExtent!=null?i.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),i}createAggregateQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new Z(r)}queryFeatures(r,i){throw new Error("missing implementation")}queryObjectIds(r,i){throw new Error("missing implementation")}queryFeatureCount(r,i){throw new Error("missing implementation")}queryExtent(r,i){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(r,i){const a=[],o=new Set;for(const d of r){const u=ue(d.origin),h=Te(u,{...i,checkPopupEnabled:!0});h&&(a.push(d),o.add(h))}if(a.length===0||o.size===0)return[];const p=await this._createPopupQuery(o,i);return await Me(this.layer,a,p,{hasRequiredFields:(d,u)=>this._popupFeatureHasRequiredFields(d,u),...i})}_handleChange(){const r=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",r),r.then(()=>{this._updatingRequiredPromise===r&&this._set("_updatingRequiredPromise",null)}),r}async _updateClientWhereClauseRequirements(){var a;if(!this.layer||!this.view)return;const{layer:r}=this,i=new Be(r.fieldsIndex);if(i.visitFilter(this.filter),"featureReduction"in r&&i.visitFeatureReduction(r.featureReduction),"labelingInfo"in r&&i.visitLabelingInfo(r.labelsVisible,r.labelingInfo),"trackInfo"in r&&i.visitTrackInfo(r.trackInfo),this.view.type==="2d"&&(i.visitFilter((a=this.featureEffect)==null?void 0:a.filter),i.visitDisplayFilter(this.displayFilterEnabled,r.displayFilterInfo),"featureReduction"in r&&i.visitFeatureReduction(r.featureReduction)),r.type==="subtype-group")for(const o of r.sublayers)i.visitLabelingInfo(o.labelsVisible,o.labelingInfo);try{const o=await i.finish();this._set("requiresCurrentUser",o.requiresCurrentUser)}catch(o){I.getLogger(this).error(o)}}async _updateRequiredFields(){var v,$,T,S;if(!this.layer||!this.view)return;const r=this.view.type==="3d",{layer:i,layer:{fieldsIndex:a}}=this,o="renderer"in i&&i.renderer,p="orderBy"in i&&i.orderBy,d="featureReduction"in i?i.featureReduction:null,u=new Set,h=[o?o.collectRequiredFields(u,a):null,j(u,i),r&&"elevationInfo"in i?pe(u,i):null,this.filter!=null?H(u,i,this.filter):null,r||this.featureEffect==null?null:H(u,i,this.featureEffect.filter),!r&&d?de(u,i,d):null,!r&&p?ce(u,i,p):null];if("timeInfo"in i&&i.timeInfo&&this.timeExtent&&m(u,i.fieldsIndex,[i.timeInfo.startField,i.timeInfo.endField]),"timeInfo"in i&&i.timeInfo&&"trackInfo"in i&&i.trackInfo){const{trackInfo:c}=i;m(u,i.fieldsIndex,[i.timeInfo.trackIdField]),i.type!=="feature"&&c.timeField!=="startTimeField"||m(u,i.fieldsIndex,[i.timeInfo.startField]),c.timeField==="endTimeField"&&m(u,i.fieldsIndex,[i.timeInfo.endField]),await he(u,i)}if("floorInfo"in i&&i.floorInfo&&m(u,i.fieldsIndex,[i.floorInfo.floorField]),"featureTitleFields"in i&&(($=(v=this.view)==null?void 0:v.requiredFieldsOptions)!=null&&$.featureTitleFields)&&i.featureTitleFields&&m(u,i.fieldsIndex,i.featureTitleFields),i.type==="feature"&&i.globalIdField&&((S=(T=this.view)==null?void 0:T.requiredFieldsOptions)!=null&&S.globalIdField)&&m(u,i.fieldsIndex,[i.globalIdField]),this.displayFilterEnabled&&h.push(ye(u,i,i.displayFilterInfo)),i.type==="feature"&&r&&i.infoFor3D!=null&&(i.globalIdField==null&&I.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),m(u,i.fieldsIndex,[i.globalIdField])),i.type==="subtype-group"){x(u,a,i.subtypeField);const c=i.sublayers.map(D=>{var N;return Promise.all([(N=D.renderer)==null?void 0:N.collectRequiredFields(u,a),j(u,D)])});h.push(Promise.all(c))}if(i.type==="catalog-footprint"&&i.parent){const c=i.parent;m(u,a,[c.itemNameField,c.itemSourceField,c.itemTypeField,c.maxScaleField,c.minScaleField])}i.type==="knowledge-graph-sublayer"&&i.parentCompositeLayer.type==="link-chart"&&x(u,a,Pe);const F=await Promise.allSettled(h);if(r)x(u,a,i.objectIdField);else for(const c of Oe($e(i)))x(u,a,c);r&&"displayField"in i&&i.displayField&&x(u,a,i.displayField);for(const c of F)c.status==="rejected"&&I.getLogger(this).error(c.reason);const w=Array.from(u).sort();this._set("requiredFields",w)}_popupFeatureHasRequiredFields(r,i){return fe(r,i)}async _createPopupQuery(r,i){const a=this.layer.createQuery(),o=new Set;let p=this.layer.geometryType==="point";for(const d of r){if(!p){const h=await Ve(d);P(i),p=(h&&h.arcadeUtils.hasGeometryOperations(d))??!1}const u=await Se(this.layer,d);P(i);for(const h of u)o.add(h)}return a.returnGeometry=p,a.returnZ=p,a.returnM=p,a.outFields=Array.from(o),a.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(a.where=O(a.where,G(this))),a}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return l([n()],s.prototype,"_updatingRequiredPromise",void 0),l([n({readOnly:!0})],s.prototype,"availableFields",null),l([n({readOnly:!0})],s.prototype,"displayFilterEnabled",null),l([n({readOnly:!0})],s.prototype,"effectiveDisplayFilter",null),l([n({readOnly:!0})],s.prototype,"effectiveDisplayFilterClause",null),l([n({type:re})],s.prototype,"featureEffect",null),l([n({type:ie})],s.prototype,"filter",void 0),l([n()],s.prototype,"layer",void 0),l([n({type:Number})],s.prototype,"maximumNumberOfFeatures",null),l([n({readOnly:!0,type:Boolean})],s.prototype,"maximumNumberOfFeaturesExceeded",null),l([n()],s.prototype,"requiresCurrentUser",void 0),l([n({readOnly:!0})],s.prototype,"requiredFields",void 0),l([n({readOnly:!0})],s.prototype,"signedInUser",null),l([n()],s.prototype,"suspended",void 0),l([n()],s.prototype,"view",void 0),s=l([b("esri.views.layers.FeatureLayerView")],s),s};let f=class extends Ne(Ie(We(Re(De)))){constructor(t){super(t)}initialize(){this.addHandles(C(()=>this._updatingRequiredPromise,t=>this._updatingHandles.addPromise(t),V))}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=q(this._fetcherContext)}get maximumNumberOfFeatures(){return this.graphicsPipeline.maximumNumberOfFeatures}set maximumNumberOfFeatures(t){this.graphicsPipeline.maximumNumberOfFeatures=t}get maximumNumberOfFeaturesExceeded(){return this.graphicsPipeline!=null&&!this.suspended&&this.graphicsPipeline.maximumNumberOfFeaturesExceeded}get updatingProgressValue(){var t;return((t=this.graphicsPipeline)==null?void 0:t.updatingProgressValue)??0}get updatePolicy(){var t;return((t=this.graphicsPipeline)==null?void 0:t.updatePolicy)??0}get snappingComplexityExceeded(){var t;return((t=this.graphicsPipeline)==null?void 0:t.snappingComplexityExceeded)??!0}get hasZ(){const t=this.layer,e=t.capabilities&&t.capabilities.data;return!(!e||!e.supportsZ)&&("returnZ"in t&&t.returnZ!=null?t.returnZ:e.supportsZ)}get hasM(){const t=this.layer,e=t.capabilities&&t.capabilities.data;return!(!e||!e.supportsM)&&"returnM"in t&&t.returnM!=null&&t.returnM}get availableFieldsForQuery(){return me(this.layer.fieldsIndex,this.availableFields)}setVisibility(t,e){var s;(s=this.graphicsPipeline)==null||s.setVisibility(t,e)}createQuery(){return super.createQuery()}queryFeatures(t,e){const s=()=>super.queryFeatures(t,e);return this.layer.geometryType==="mesh"?this._queryFeaturesMesh(this._ensureQuery(t),s):s()}async createGraphicsPipeline(){if(ge("feature-pipeline-3d-test")){const{Feature3DPipeline:t}=await Fe(()=>import("./Feature3DPipeline-O0pA_ykt.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48]));return new t({layerView:this})}return new y({layerView:this})}async doRefresh(t){return await this.graphicsPipeline.doRefresh(t)}_popupFeatureHasRequiredFields(t,e){if(!super._popupFeatureHasRequiredFields(t,e))return!1;const s=be(t,this.layer.objectIdField);if(s==null)return!0;const r=this.graphicsPipeline.getMissingAttributesForFeature(s);if(r==null)return!0;for(const i of e)if(r.has(i))return!1;return!0}get usedMemory(){var t;return((t=this.graphicsPipeline)==null?void 0:t.usedMemory)??0}get unloadedMemory(){var t;return((t=this.graphicsPipeline)==null?void 0:t.unloadedMemory)??0}get ignoresMemoryFactor(){var t;return((t=this.graphicsPipeline)==null?void 0:t.ignoresMemoryFactor)??!1}async _queryFeaturesMesh(t,e){this._validateQueryFeaturesMesh(t);const s=await e(),r=this.graphicsPipeline;if(t!=null&&t.outStatistics||r==null)return s;const i=this.layer.objectIdField,a=[];for(const o of s.features)if(o.geometry){const p=r.getHydratedGeometry(o.attributes[i]);p&&(o.geometry=p,a.push(o))}else a.push(o);return s.features=a,s}_validateQueryFeaturesMesh(t){if(!t)return;const e=r=>{throw new we("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${r}'`)},s=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const r of s)t[r]!=null&&e(r);"returnM"in t&&t.returnM&&e("returnM"),"returnCentroid"in t&&t.returnCentroid&&e("returnCentroid"),t.outSpatialReference==null||t.outSpatialReference.equals(this.view.spatialReference)||e("outSpatialReference")}get test(){}};l([n()],f.prototype,"layer",void 0),l([n()],f.prototype,"graphicsPipeline",void 0),l([n()],f.prototype,"maximumNumberOfFeatures",null),l([n()],f.prototype,"maximumNumberOfFeaturesExceeded",null),l([n(xe)],f.prototype,"updatingProgress",void 0),l([n({readOnly:!0})],f.prototype,"updatingProgressValue",null),l([n({readOnly:!0})],f.prototype,"updatePolicy",null),l([n()],f.prototype,"snappingComplexityExceeded",null),l([n({readOnly:!0})],f.prototype,"hasZ",null),l([n({readOnly:!0})],f.prototype,"hasM",null),l([n()],f.prototype,"availableFieldsForQuery",null),f=l([b("esri.views.3d.layers.FeatureLayerViewBase3D")],f);export{f,Qe as t};
