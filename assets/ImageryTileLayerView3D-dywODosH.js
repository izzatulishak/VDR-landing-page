import{K as R,U as z,oA as Z,oB as K,_ as m,m as c,b as P,oC as k,oD as O,oE as G,oF as A,oG as $,oH as y,oI as Y,s as B,w as Q,bR as X,oJ as ee,oK as te}from"./index-BiSWWdHA.js";import{v as re,u as L,I as ie}from"./rasterProjectionHelper-BtzfiohL.js";import{l as se}from"./LayerView3D-D7-E2zMU.js";import{p as ae}from"./TiledLayerView3D-C5qNnRVh.js";import{l as le}from"./throttle-C00eO2t5.js";import{y as ne}from"./dataUtils-DIkF8Q7d.js";import{r as oe,c as ue}from"./FlowSubView3D-DwS1pxdu.js";import{h as S,c as he}from"./loadUtils-BYPwHxsF.js";import{V as de,i as b,a as me}from"./rasterFieldUtils-BIjngs6Y.js";import{i as ce}from"./timeSupport-Brvg60eB.js";import{t as pe}from"./datasetUtils-Ce6P7t-y.js";import{n as fe}from"./popupUtils-CqQiS61M.js";import{d as ye}from"./LayerView-XxBSWkwC.js";import{i as ge}from"./RefreshableLayerView-ckigDJtR.js";import"./SubView3D--hgRgQAN.js";import"./line-BHJjCVlJ.js";import"./FeatureTileDescriptor-B30kDqXl.js";import"./utils-Cf8yv0hR.js";const g={type:"delete"},_e={type:"waiting"},Te={type:"on-worker",upsampled:!1},we={type:"on-worker",upsampled:!0};let v=class extends oe{constructor(e){super(e),this._resetTileData=!0,this._throttledTriggerLoad=null,this._throttling=!1}initialize(){this.addHandles([this.surface.on("tile-data-changed",({tile:e,layerIndex:t,layerClass:r})=>{this.renderedTiles!=null&&(this.loadByTileTreesAllowed||this._tileIsUpsampled(e))&&t===this._layerIndex&&r===1&&this._updateFlowDataTile(e)}),R(()=>this.renderedTiles,e=>{const t=this.frameTask.scheduleGenerator(r=>this._updateFlowDataTiles(e,r));this.updatingHandles.addPromise(t)},z),R(()=>this._pixelSize,()=>{this.invalidateTileData(),this._resetTileData=!0},z)]),this._throttledTriggerLoad=le(()=>{super.triggerLoad(),this._throttling=!1},()=>this._throttling=!0,ue,this),this.addHandles(this._throttledTriggerLoad)}async*_updateFlowDataTiles(e,t){var i;const r=F();for(const a of e??[]){const s=(i=this._flowDataTiles)==null?void 0:i.get(S(a)),l=s==null||s.type==="delete"||s.type==="waiting"?this._getLoadedState(a):s;l!=null&&r.set(S(a),l),t.madeProgress(),t.done&&(t=yield)}this._flowDataTiles=r,this._resetTileData=!0,this.triggerLoad()}abort(){super.abort(),this._throttling=!1}get _layerIndex(){return this.surface.getLayerIndexByUID(1,this.layerView.uid)}get loadByTileTreesAllowed(){return super.loadByTileTreesAllowed||!this._allTilesLoaded}get _pixelSize(){return this.surface.tilingScheme.pixelSize}doRefresh(){this.invalidateTileData(),super.doRefresh()}triggerLoad(){const{_throttledTriggerLoad:e}=this;this._allTilesLoaded?(e.hasPendingUpdates()||e(),e.forceUpdate()):e()}async fetchDataAndGenerateStreamlines(e,t){const{_flowDataTiles:r,needsMagnitude:i,workerHandle:a}=this,s=this.getSimulationSettings(e);if(s==null||a==null||r==null)return;const l=this._resetTileData;this._resetTileData=!1;const d=F();r.forEach((n,o)=>{n.type==="delete"?(d.set(o,g),r.delete(o)):(l||n.type!=="on-worker"&&n.type!=="waiting")&&(d.set(o,n),r.set(o,n.type!=="waiting"&&n.upsampled?we:Te))});const h={simulationSettings:s,flowExtentInfo:e.flowExtentInfo,flowDataTiles:d,reset:l,needsMagnitude:i,startPositions:this.startPositions(e)},{streamlines:u}=await a.generateTiledStreamlines(h,t);return u}getUpdating(){return super.getUpdating()||this._throttling}_getLoadedState(e){const{_layerIndex:t}=this,r=e.surface==null;if(t==null||r)return g;const i=e.getLayerInfo(t,1);if(i==null)return g;if(!e.visible&&i.requestAbort==null)return i.requestAbort=new AbortController,this.surface.requestTileData(e,t,1,i.requestAbort),g;const a=this._getRasterTile(i,e,t);return a==null?this._upsampleFlowData(t,i.upsampleInfo,e.lij,e.extent):{type:"loaded",data:this._createFlowDataTile(a,e.lij,e.extent,this._pixelSize),upsampled:!1}}_upsampleFlowData(e,t,r,i){if(t==null)return g;const a=t.tile;if(a==null)return g;const s=a.getLayerInfo(e,1);if(s==null)return g;const l=this._getRasterTile(s,a,e);if(l==null)return g;const{scale:d,offset:h}=t,u=Math.max(Math.floor(this._pixelSize*d),1),n=l.source,o=Math.floor(h[0]*n.width),f=Math.floor((1-h[1]-d)*n.height);return{type:"loaded",data:this._createFlowDataTile(l,r,i,u,o,f),upsampled:!0}}_getRasterTile(e,t,r){const{data:i}=e;return!e.dataMissing&&t.hasLayerData(r,1)&&Z(i)?i:null}_createFlowDataTile(e,t,r,i,a,s){const l=ne(this.layer.serviceRasterInfo.dataType,e.source,i,i,a,s),d=l.mask.slice();return new he(l.data,d,l.width,l.height,t,K(r))}_updateFlowDataTile(e){var a;const{renderedTiles:t,_layerIndex:r}=this;if(t==null||r==null)return;if(t.has(e)){const s=this._getLoadedState(e);return void(this._setTileData(e,s)&&this.triggerLoad())}let i=this._setTileData(e,g);for(const s of t.values()){const l=s.getLayerInfo(r,1);if(l==null||this._getRasterTile(l,s,r)!=null||((a=l.upsampleInfo)==null?void 0:a.tile)!==e)continue;const h=this._getLoadedState(s),u=this._setTileData(s,h);i||(i=u)}i&&this.triggerLoad()}_setTileData(e,t){const{_flowDataTiles:r}=this;if(r==null)return!1;const i=S(e);return(r.get(i)!=null||t.type!=="delete")&&(r.set(i,t),!0)}get _allTilesLoaded(){var t,r;let e=0;for(const i of((t=this._flowDataTiles)==null?void 0:t.values())??[])i.type!=="delete"&&i.type!=="waiting"&&e++;return e===((r=this.renderedTiles)==null?void 0:r.size)}invalidateTileData(){const{_flowDataTiles:e}=this;e==null||e.forEach((t,r)=>{e.set(r,_e)})}_tileIsUpsampled(e){var r;const t=(r=this._flowDataTiles)==null?void 0:r.get(S(e));return t!=null&&(t.type==="loaded"||t.type==="on-worker")&&t.upsampled}get usedMemory(){var r;const e=9*this._pixelSize**2,t=(((r=this._flowDataTiles)==null?void 0:r.size)??0)*e;return super.usedMemory+t}get test(){return{...super.test,loadedTiles:this._flowDataTiles??F()}}};function F(){return new Map}m([c()],v.prototype,"_throttling",void 0),v=m([P("esri.views.3d.support.flow.FlowSubViewTiles3D")],v);function xe(e,t,r="nearest",i=!1){const a=!(i&&t.pixelType==="u8"),s=a?G.FLOAT:G.UNSIGNED_BYTE,l=t.pixels==null||t.pixels.length===0?null:a?t.getAsRGBAFloat():t.getAsRGBA(),d=e.capabilities.textureFloatLinear,h=new O(t.width,t.height);return h.internalFormat=a?k.RGBA32F:6408,h.samplingMode=!d||r!=="bilinear"&&r!=="cubic"?9728:9729,h.dataType=s,h.wrapMode=33071,new A(e,h,l)}function be(e,t){const{spacing:r,offsets:i,coefficients:a,size:[s,l]}=t,d=r[0]>1,h=new O(d?4*s:s,l);h.internalFormat=k.RGBA32F,h.dataType=G.FLOAT,h.samplingMode=9728,h.wrapMode=33071;const u=new Float32Array(d?s*l*16:2*i.length);if(d&&a!=null)for(let n=0,o=0;n<a.length;n++)u[o++]=a[n],n%3==2&&(u[o++]=1);else for(let n=0;n<l;n++)for(let o=0;o<s;o++){const f=4*(n*s+o),w=2*(o*l+n);u[f]=i[w],u[f+1]=i[w+1],u[f+3]=i[w]===-1?0:1}return new A(e,h,u)}function U(e,t){const r=new O(t.length/4,1);return r.internalFormat=6408,r.samplingMode=9728,r.wrapMode=33071,new A(e,r,t)}function Ie(e,t,r,i=1,a=!0){return{u_flipY:a,u_applyTransform:!!e,u_opacity:i,u_transformSpacing:e?e.spacing:$,u_transformGridSize:e?e.size:$,u_targetImageSize:t,u_srcImageSize:r}}function Se(e,t){return{u_colormapOffset:t||0,u_colormapMaxIndex:e?e.length/4-1:0}}function ve(e){return{u_bandCount:e.bandCount,u_minOutput:e.minOutput,u_maxOutput:e.maxOutput,u_minCutOff:e.minCutOff,u_maxCutOff:e.maxCutOff,u_factor:e.factor,u_useGamma:e.useGamma,u_gamma:e.gamma,u_gammaCorrection:e.gammaCorrection}}function Re(e){return{u_hillshadeType:e.hillshadeType,u_sinZcosAs:e.sinZcosAs,u_sinZsinAs:e.sinZsinAs,u_cosZs:e.cosZs,u_weights:e.weights,u_factor:e.factor,u_minValue:e.minValue,u_maxValue:e.maxValue}}const j={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class ze{constructor(t,r,i=null,a=null){this.lij=t,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=r,this.width=i||r.width,this.height=a||r.height}get source(){return this._source}set source(t){this._source=t,this._rasterTexture=y(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...j,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||j}set symbolizerParameters(t){this._symbolizerParameters=t}get bandIds(){return this._bandIds}set bandIds(t){t!=null&&t.length>0?this._bandIds&&t.every((r,i)=>{var a;return!!((a=this._bandIds)!=null&&a[i])&&r===this._bandIds[i]})||(this._bandIds=t,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){if(this._interpolation=t,this._rasterTexture!=null){const r=this._getRasterTextureInterpolation(t);this._rasterTexture.setSamplingMode(r==="bilinear"?9729:9728)}}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid=t,this._transformGridTexture=y(this._transformGridTexture),this._memoryUsed=null}bind(t){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(t,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(t),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=be(t,this.transformGrid))),!0)}getUniforms(t){const{symbolizerParameters:r,transformGrid:i,width:a,height:s,opacity:l}=this,d=Ie(i,[a,s],[this.source.width,this.source.height],l),h=Se(r.colormap,r.colormapOffset),u=this.symbolizerParameters.type==="stretch"?ve(this.symbolizerParameters):null,n=this.symbolizerParameters.type==="hillshade"?Re(this.symbolizerParameters):null,o=t.emptyTexture;return new Y(d,h,u||n,this._rasterTexture??o,this._transformGridTexture??o,this._colormapTexture??o)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:t}=this;return this.interpolation==="bilinear"&&t.colormap!=null&&t.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const t=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=t.map(r=>r!=null?r.descriptor.width*r.descriptor.height*4:0).reduce((r,i)=>r+i,0)}return this._memoryUsed}release(){return this._rasterTexture=y(this._rasterTexture),this._transformGridTexture=y(this._transformGridTexture),this._colormapTexture=y(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(t,r){const i=this.source?this.source.extractBands(r):null;if(!(i!=null&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=y(this._rasterTexture));const a=r==null&&this.bandIds==null||r!=null&&this.bandIds!=null&&r.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&a)return;this._rasterTexture=y(this._rasterTexture);const s=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=xe(t,i,s,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(t){return this.symbolizerParameters.type==="lut"||t==="nearest"||t==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(t){const r=this._colormap,i=this.symbolizerParameters.colormap;return i?r?i.length!==r.length||i.some((a,s)=>a!==r[s])?(this._colormapTexture=y(this._colormapTexture),this._colormapTexture=U(t,i),void(this._colormap=i)):void 0:(this._colormapTexture=U(t,i),void(this._colormap=i)):(this._colormapTexture=y(this._colormapTexture),void(this._colormap=null))}}const De=e=>{const t=e;let r=class extends t{constructor(...i){super(...i),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){var i;return ce(this.layer,(i=this.view)==null?void 0:i.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){const{renderer:i}=this.layer;return!!((i==null?void 0:i.type)==="raster-stretch"&&i.dynamicRangeAdjustment&&!(i.stretchType==="min-max"||i.stretchType==="standard-deviation"))}get datumTransformation(){try{return this.layer.loaded?re(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(i){try{return!this.layer.loaded||!!L(this.layer.serviceRasterInfo,i)}catch{return!1}}async fetchPopupFeaturesAtLocation(i,a){var w,E;const{layer:s}=this;if(!i)throw new B("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:l}=s,d=fe(s,a);if(!l||d==null)return[];const h=[],{value:u,magdirValue:n,processedValue:o}=await s.identify(i,{timeExtent:this.timeExtent,signal:a==null?void 0:a.signal});let f="";if(u!=null&&u.length){f=s.type==="imagery-tile"&&s.hasStandardTime()&&u[0]!=null?u.map(D=>s.getStandardTimeValue(D)).join(", "):u.join(", ");const _={ObjectId:0};_[b.servicePixelValue]=s.type==="imagery-tile"&&pe(s.raster)?o==null?void 0:o.join(", "):f,_[b.rawServicePixelValue]=f;const x=((w=s.raster)==null?void 0:w.rasterInfo)??s.serviceRasterInfo,V=x==null?void 0:x.attributeTable;if(V!=null){const{fields:D,features:W}=V,M=D.find(({name:T})=>T.toLowerCase()==="value"),J=_[b.servicePixelValue],I=M?W.find(T=>String(T.attributes[M.name])===J):null;if(I)for(const T in I.attributes)I.attributes.hasOwnProperty(T)&&(_[me+T]=I.attributes[T])}const C=x==null?void 0:x.dataType;C!=="vector-magdir"&&C!=="vector-uv"||(_[b.magnitude]=n==null?void 0:n[0],_[b.direction]=n==null?void 0:n[1]);const{multidimensionalDefinition:H}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});de(s.rasterFields,_,H);const{graphicOrigin:N}=s,q=new Q({geometry:(E=this.fullExtent)==null?void 0:E.clone(),attributes:_,layer:s,origin:N,sourceLayer:s});h.push(q)}return h}async getSourceScale(){return await this.layer.load(),ie(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return L(this.layer.serviceRasterInfo,this.view.spatialReference)}};return m([c()],r.prototype,"fullExtent",null),m([c()],r.prototype,"layer",void 0),m([c({readOnly:!0})],r.prototype,"timeExtent",null),m([c()],r.prototype,"tileInfo",void 0),m([c({readOnly:!0})],r.prototype,"hasTilingEffects",null),m([c()],r.prototype,"datumTransformation",null),r=m([P("esri.views.layers.ImageryTileLayerView")],r),r};let p=class extends De(ge(ae(se(ye)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0,this._flowSubView=null,this.ignoresMemoryFactor=!1,this.unloadedMemory=0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new B("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const e=X(()=>{var t,r;return(r=(t=this.view)==null?void 0:t.basemapTerrain)==null?void 0:r.tilingSchemeLocked}).then(()=>{const t=this.view.basemapTerrain.tilingScheme,r=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(r.format)&&t.compatibleWith(r),this.tileInfo=this._isAlignedMapTile?r:t.toTileInfo(),this.addHandles([R(()=>this.layer.renderer,i=>{this._setSubView(i),this._updatingHandles.addPromise(this.doRefresh())},z),R(()=>[this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this._updatingHandles.addPromise(this.doRefresh()),z)])});this._setSubView(this.layer.renderer),this.addResolvingPromise(e)}destroy(){var e;this.layer.decreaseRasterJobHandlerUsage(),(e=this._flowSubView)==null||e.destroy()}_setSubView(e){if(this.layer.type==="wcs")return;const t=(e==null?void 0:e.type)==="flow",r=this._flowSubView;t&&r!=null||(r==null||r.destroy(),this._flowSubView=t?new v({layerView:this}):null)}get _blankTile(){const e=document.createElement("canvas"),t=e.getContext("2d"),[r,i]=this.tileInfo.size;return e.width=r,e.height=i,t.clearRect(0,0,r,i),t.getImageData(0,0,r,i)}get _hasFlow(){return this._flowSubView!=null}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){var i,a;const e=this.layer.tileInfo,t=(i=this.tileInfo.lodAt(0))==null?void 0:i.scale,r=(a=e.lodAt(e.lods.length-1))==null?void 0:a.scale;return this.levelRangeFromScaleRange(t,r)}get visibleAtCurrentScale(){var e;return((e=this._flowSubView)==null?void 0:e.visibleAtCurrentScale)??this.tilesVisibleAtCurrentScale()}_getFullExtent(){var e;return L(this.layer.serviceRasterInfo,((e=this.view.basemapTerrain)==null?void 0:e.spatialReference)??this.view.spatialReference)}async fetchTile(e,t){const r=this.tileInfo,i=this._canSymbolizeInWebGL(),a={tileInfo:r,requestRawData:i&&!this._hasFlow,signal:t.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,requestProjectedLocalDirections:this._hasFlow,noClip:!1},{layer:s}=this,[l,d,h]=e,u=await s.fetchTile(l,d,h,a);if(u instanceof HTMLImageElement)return u;let n=u==null?void 0:u.pixelBlock;if(n==null)return this._blankTile;if(!i&&!this._hasFlow&&(n=await s.applyRenderer(u),n==null))return this._blankTile;const o=new ze([l,d,h],n,r.size[0],r.size[1]);return i?(o.symbolizerRenderer=s.symbolizer.rendererJSON,o.symbolizerParameters=s.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(l)),o.transformGrid=u.transformGrid,o.bandIds=s.bandIds):(o.isRendereredSource=!0,o.bandIds=null),o.interpolation=s.interpolation,o}_getSymbolizerOptions(e){var r;const t=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:((r=this.view.basemapTerrain)==null?void 0:r.spatialReference)!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,t){return ee(e,t,this.view)}async doRefresh(){var e;this.suspended||((e=this._flowSubView)==null||e.doRefresh(),this.emit("data-changed"))}isUpdating(){var e;return((e=this._flowSubView)==null?void 0:e.updating)??!1}_canSymbolizeInWebGL(){var s,l;const e=te(),{symbolizer:t}=this.layer,r=(s=t.lookup.colormapLut)==null?void 0:s.indexedColormap,i=!!((l=this.layer.rasterFunction)!=null&&l.hasClipFunction),a=r&&r.length>4*(e.maxTextureSize||4096);return t.canRenderInWebGL&&!a&&!i}get usedMemory(){var e;return((e=this._flowSubView)==null?void 0:e.usedMemory)??0}get test(){}};m([c({readOnly:!0})],p.prototype,"_blankTile",null),m([c()],p.prototype,"_hasFlow",null),m([c({readOnly:!0})],p.prototype,"imageFormatIsOpaque",null),m([c({readOnly:!0})],p.prototype,"hasMixedImageFormats",null),m([c()],p.prototype,"_flowSubView",void 0),m([c({readOnly:!0})],p.prototype,"dataLevelRange",null),m([c({readOnly:!0})],p.prototype,"visibleAtCurrentScale",null),p=m([P("esri.views.3d.layers.ImageryTileLayerView3D")],p);const We=p;export{We as default};
