import{af as T,ao as zt,ag as Lt,ap as Mt,aq as j,$ as Ot,P as Rt,iG as $,iF as Q,iE as xt,ld as Ut,le as it,iR as rt,lf as Vt,lg as ot,bH as jt,au as J,lh as Ft,c7 as Tt,aa as P,iT as Bt,f0 as Z,f5 as Gt,jM as Ht,dm as Wt,li as kt,lj as qt,al as lt,j$ as Nt,lk as Jt,ll as Kt,lm as Zt,ln as Qt,lo as Xt,a9 as R,cO as ct,dy as wt,ab as Yt,dz as X,lp as te,lq as ee,lr as ne,ls as se,jd as ae,lt as ie,cJ as W,cK as re,cI as ut}from"./index-DfdgIpb3.js";import{e as St}from"./earcut-D9gy186-.js";import{t as oe,e as ht}from"./SnappingCandidate-DGkpYqI6.js";import{a as le}from"./renderingInfoUtils-D6DYm6Rg.js";import{h as Pt,i as ce}from"./triangulationUtils-LK4g8J0Z.js";function ue(n,t,e,s){const a=Pt(n.rings,!!n.hasZ&&s.mode!=="on-the-ground",1,n.spatialReference),i=T(a.position.length),r=zt(a.position,n.spatialReference,0,i,0,a.position,0,a.position.length/3,t,e,s),o=r!=null;return new de(a.position,i,Ct(a.polygons,a.position,i),vt(a.outlines,a.position,i),o,r)}function Le(n,t){const e=Pt(n.rings,!1,1),s=Lt(e.position,n.spatialReference,0,e.position,t,0);for(let a=2;a<e.position.length;a+=3)e.position[a]=Mt;return{position:e.position,polygons:Ct(e.polygons,e.position),outlines:vt(e.outlines,e.position),projectionSuccess:s}}function vt(n,t,e=null){return n.filter(({count:s})=>s>1).map(({index:s,count:a})=>{const i=3*s,r=3*a;return e!=null?new Et(s,a,j(t,i,r),j(e,i,r)):new Y(s,a,j(t,i,r))})}function Ct(n,t,e=null){const s=new Array;for(const{index:a,count:i,holeIndices:r,pathLengths:o}of n){if(i<=1)continue;const l=3*a,x=3*i,_=r.map(y=>y-a),m=e!=null?new he(a,i,j(t,3*a,3*i),j(e,l,x),_,o):new pe(a,i,j(t,3*a,3*i),_,o);s.push(m)}return s}let Y=class{constructor(t,e,s){this.index=t,this.count=e,this.position=s}};class Et extends Y{constructor(t,e,s,a){super(t,e,s),this.mapPositions=a}}class he extends Et{constructor(t,e,s,a,i,r){super(t,e,s,a),this.holeIndices=i,this.pathLengths=r}}class pe extends Y{constructor(t,e,s,a,i){super(t,e,s),this.holeIndices=a,this.pathLengths=i}}class de{constructor(t,e,s,a,i,r){this.position=t,this.mapPositions=e,this.polygons=s,this.outlines=a,this.projectionSuccess=i,this.sampledElevation=r}}function Oe(n,t,e){const s=(t.length>0?t[0]:n.length/3)-1,a=ce(n,s,e);if(a!==2){n=n.slice();for(let i=0;i<n.length;i+=3)n[i+a]=n[i+2]}return St(n,t,3)}function Re(n){const t=[["position",new $(n.attributeData.position,n.indices,3,!0)]],e=xt(n.indices.length);return n.attributeData.colorFeature!=null?t.push(["colorFeatureAttribute",new $([n.attributeData.colorFeature],e,1,!0)]):n.attributeData.color&&t.push(["color",new $(n.attributeData.color,e,4,!0)]),n.attributeData.uvMapSpace&&t.push(["uvMapSpace",new $(n.attributeData.uvMapSpace,n.indices,4,!0)]),n.attributeData.boundingRect&&t.push(["boundingRect",new $(n.attributeData.boundingRect,n.indices,9,!0)]),new Q(n.material,t,n.mapPositions,0,n.attributeData.olidColor)}function Ue(n,t=null){const e=[["position",new $(n.attributeData.position,n.indices,3,!0)],["uv0",new $(n.attributeData.uv0,n.indices,2,!0)]];return new Q(n.material,e,n.mapPositions,0,t)}function ge(n){switch(n.type){case"extent":if(n instanceof Ot)return Rt.fromExtent(n);break;case"polygon":return n}return null}class Ve{constructor(t,e,s){this.renderData=t,this.layerViewUid=e,this.graphicUid=s,this.outGeometries=new Array}}const me=["polygon","extent"];class je extends Ut{constructor(t,e,s,a){super(t,e,s,a,xe(e)),this.ensureDrapedStatus(!1)}async doLoad(){var _,m;const t=this.symbolLayer,e=t==null?void 0:t.material,s=(m=(_=this.symbolLayer.material)==null?void 0:_.color)==null?void 0:m.a,a=this.needsDrivenTransparentPass||s!=null&&s!==1,i=e==null?void 0:e.emissive,r=!this._hasDrivenColorOrOpacity&&(s==null||s===0),o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:rt,diffuse:rt,opacity:r?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:a,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:(i==null?void 0:i.strength)??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},l=new it(o,this._context),x=new it({...o,cullFace:2},this._context);this._materials[0]=l,this._materials[1]=x,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,me,this.symbolLayer.type))return null;const s=this._getDrivenUInt8ColorWithNaNSupport(t.renderingInfo,this._materialColor,!1);Vt(s,s);const a=this.createElevationContextForGraphic(e);return this._createAs3DShape(e,t.renderingInfo,s,a,e.uid)}layerOpacityChanged(t,e){var a,i;const s=this._getLayerOpacity();(a=this._materials[0])==null||a.setParameters({layerOpacity:s}),(i=this._materials[1])==null||i.setParameters({layerOpacity:s}),this._updateTransparentDepedentMaterialParameters(),t==null||t.forEach(r=>{var o;return(o=e(r))==null?void 0:o.layerOpacityChanged(s,this._context.isAsync)})}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,ot)}slicePlaneEnabledChanged(t,e){var s,a;return(s=this._materials[0])==null||s.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),(a=this._materials[1])==null||a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t==null||t.forEach(i=>{const r=e(i);r!=null&&r.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){var e,s;const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return(e=this._materials[0])==null||e.setParameters(t),(s=this._materials[1])==null||s.setParameters(t),!0}_getExtrusionSize(t){let e;return e=t.size&&this._drivenProperties.size?le(t.size,2)??0:this._getSymbolSize(),e/=this._context.renderCoordsHelper.unitInMeters,e}applyRendererDiff(t,e){return this._drivenPropertiesChanged(e)?0:1}async queryForSnapping(t,e,s,a){const i=this._getExtrusionSize(s)*this._context.renderCoordsHelper.unitInMeters/jt(e),{objectId:r,target:o}=t,l=J(o);switch(l.z=(l.z??0)+i,t.type){case"edge":{const{start:x,end:_}=t,m=J(x),y=J(_);return m.z=(m.z??0)+i,y.z=(y.z??0)+i,[ht(r,l,1/0,m,y)]}case"vertex":return[oe(r,l,1/0),ht(r,o,1/0,o,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,e,s,a,i){const r=ge(t.geometry);if(r==null)return null;if(r.rings.length===0||!r.rings.some(C=>C.length>0))return this._logGeometryValidationWarnings(r.rings,"rings","ExtrudeSymbol3DLayer"),null;const o=ue(r,this._context.elevationProvider,this._context.renderCoordsHelper,a);this._logGeometryCreationWarnings(o,r.rings,"rings","ExtrudeSymbol3DLayer");const l=Ft(r);if(l==null)return null;const x=new Array,_=new Array,m=Tt(),y=Z(),w=P(),p=this._context.renderCoordsHelper.viewingMode===1;p||this._context.renderCoordsHelper.worldUpAtPosition(null,w),Bt(r.spatialReference,[l.x,l.y,0],y,this._context.renderCoordsHelper.spatialReference);const b=Z();Gt(b,y);const g=Wt();Ht(g,b);const{polygons:f,mapPositions:c,position:d}=o,h=new Map,v=this._materials[0];for(const C of f){const L=C.count;if(this._context.clippingExtent&&(kt(C.mapPositions,m),!qt(m,this._context.clippingExtent)))continue;const M=St(C.mapPositions,C.holeIndices,3);if(M.length===0)continue;const O=M.length,D=6*L,U=lt(D+O),k=lt(O),B=T(3*D),tt=T(3*D),et=T(3*D),nt=T(D);ye(d,c,M,C,B,et,tt,nt,U,k,this._getExtrusionSize(e),w,p),Nt(B,B,b);const st=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid}),q=new Ce(B,et,Jt(tt),nt),N=pt(v,U,U.length-k.length,q,s,st),$t=L,At=L,It=2*C.count,at=new Ee($t,At,It,O/3);Dt(N,at,y),h.set(N,at),x.push(N,pt(this._materials[1],k,0,q,s,st)),_.push(q.heights)}if(x.length===0)return null;const u=new Kt({geometries:x,layerViewUid:this._context.layerViewUid,graphicUid:i,isElevationSource:!0});u.transformation=y;const A=Zt(this.symbolLayer,{opacity:this._getLayerOpacity()}),I=A?new Qt(this._materials[0],A,this._context.slicePlaneEnabled):null,z=new Xt(this,u,null,(C,L,M,O,D)=>be(C,L,M,O,D,_,h),a,I);return z.alignedSampledElevation=o.sampledElevation,z.needsElevationUpdates=ot(a.mode),z}get _materialColor(){var t;return(t=this.symbolLayer.material)==null?void 0:t.color}_updateTransparentDepedentMaterialParameters(){const t=this._materials[0];t&&t.setParameters({cullFace:t.transparent?0:2})}}function pt(n,t,e,s,a,i){const r=xt(t.length),o=[["position",new $(s.positions,t,3,!0)],["normalCompressed",new $(s.normals,t,2,!0)],["symbolColor",new $(a,r,4,!0)]];return new Q(n,o,s.elevation,0,i,e)}function ye(n,t,e,s,a,i,r,o,l,x,_,m,y){const w=e.length/3;let p=2*s.count;fe(n,t,s.index,s.count,e,0,w,a,i,r,o,l,x,p,_,m,y);let b=0,g=2*s.count;p=0;const f=s.pathLengths[0];dt(a,i,o,r,b,f,s.count,g,l,p,_),g+=4*f,p+=2*f,b+=f;for(let c=1;c<s.pathLengths.length;++c){const d=s.pathLengths[c];dt(a,i,o,r,b,d,s.count,g,l,p,_),g+=4*d,p+=2*d,b+=d}}function fe(n,t,e,s,a,i,r,o,l,x,_,m,y,w,p,b,g){re(E,b),l??(l=[]),x??(x=[]),_??(_=[]);const f=p>0?1:-1;let c=3*e,d=0,h=3*d,v=s,u=3*v;for(let z=0;z<s;++z){const C=n[c],L=n[c+1],M=n[c+2];g&&(E[0]=C,E[1]=L,E[2]=M,X(E,E)),o[h+0]=C,o[h+1]=L,o[h+2]=M;const O=t[c+0],D=t[c+1],U=t[c+2];l[h+0]=O,l[h+1]=D,l[h+2]=U,x[h+0]=-f*E[0],x[h+1]=-f*E[1],x[h+2]=-f*E[2],_[d]=0,o[u+0]=C+p*E[0],o[u+1]=L+p*E[1],o[u+2]=M+p*E[2],l[u+0]=O,l[u+1]=D,l[u+2]=U,_[v]=p,h+=3,u+=3,c+=3,d+=1,v+=1}c=3*i,h=0,u=3*w;const A=p<0?bt:_t,I=p<0?_t:bt;for(let z=0;z<r;++z)y[h]=a[c+A[0]],y[h+1]=a[c+A[1]],y[h+2]=a[c+A[2]],m[u]=a[c+I[0]]+s,m[u+1]=a[c+I[1]]+s,m[u+2]=a[c+I[2]]+s,h+=3,u+=3,c+=3}function G(n,t,e,s,a,i,r){s[i]=s[r],r*=3,n[i*=3]=n[r],n[i+1]=n[r+1],n[i+2]=n[r+2],t[i]=t[r],t[i+1]=t[r+1],t[i+2]=t[r+2],e[i]=a[0],e[i+1]=a[1],e[i+2]=a[2]}const F=P();function dt(n,t,e,s,a,i,r,o,l,x,_){t??(t=[]),e??(e=[]),s??(s=[]);let m=a,y=a+1,w=a+r,p=a+r+1,b=o,g=o+1,f=o+2*i,c=o+2*i+1;_<0&&(m=a+r+1,p=a);let d=3*x;for(let h=0;h<i;++h)h===i-1&&(y=a,_>0?p=a+r:m=a+r),_e(n,m,y,w,F),G(n,t,s,e,F,b,m),G(n,t,s,e,F,g,y),G(n,t,s,e,F,f,w),G(n,t,s,e,F,c,p),l[d]=b,l[d+1]=f,l[d+2]=c,l[d+3]=b,l[d+4]=c,l[d+5]=g,d+=6,m++,y++,w++,p++,b+=2,g+=2,f+=2,c+=2}const K=P(),gt=P(),mt=P(),yt=P(),ft=P();function _e(n,t,e,s,a){t*=3,e*=3,s*=3,R(K,n[t++],n[t++],n[t++]),R(gt,n[e++],n[e++],n[e++]),R(mt,n[s++],n[s++],n[s++]),ut(yt,gt,K),ut(ft,mt,K),wt(a,ft,yt),X(a,a)}const V=P();function be(n,t,e,s,a,i,r){const o=n.stageObject,l=o.geometries,x=l.length,_=t.mode!=="absolute-height";let m=0;const y=o.transformation,w=ee(Z(),y);for(let p=0;p<x;p+=2){const b=l[p];if(!ne(b))continue;const g=b.getMutableAttribute("position").data,f=i[p/2],c=new se(b.mapPositions),d=g.length/3;let h=!1,v=0;{let u=0;for(let A=0;A<d;A++){V[0]=g[u],V[1]=g[u+1],V[2]=g[u+2],s(c,H),_&&(v+=H.sampledElevation),ie.TESTS_DISABLE_OPTIMIZATIONS?(R(S,c.array[c.offset],c.array[c.offset+1],H.z+f[u/3]),e!=null&&a.toRenderCoords(S,e,S),W(S,S,w)):(R(S,g[u],g[u+1],g[u+2]),W(S,S,y),a.setAltitude(S,H.z+f[u/3]),W(S,S,w)),g[u]=S[0],g[u+1]=S[1],g[u+2]=S[2];const I=we/a.unitInMeters;(Math.abs(V[0]-g[u])>=I||Math.abs(V[1]-g[u+1])>=I||Math.abs(V[2]-g[u+2])>=I)&&(h=!0),c.offset+=3,u+=3}}if(h){const u=r.get(b);u&&Dt(b,u,y),o.geometryVertexAttributeUpdated(l[p],"normalCompressed"),b.invalidateBoundingInfo(),o.geometryVertexAttributeUpdated(l[p],"position"),l[p+1].invalidateBoundingInfo(),o.geometryVertexAttributeUpdated(l[p+1],"position")}m+=v/d}return m/x}function Dt(n,t,e){const s=n.getMutableAttribute("position"),a=n.getMutableAttribute("normalCompressed").data,i=s.data,r=n.attributes.get("position").indices,{topVertexStart:o,topVertexCount:l,topFaceStart:x,topFaceCount:_}=t,m=x+_,y=o+l,w=Se,p=Pe,b=ve,g=E,f=S;R(f,0,0,0);const c=(d,h)=>{const v=3*d;R(h,i[v+0],i[v+1],i[v+2]),W(h,h,e)};for(let d=x;d<m;++d){const h=3*d;c(r[h+0],w[0]),c(r[h+1],w[1]),c(r[h+2],w[2]),ct(p,w[1],w[0]),ct(b,w[2],w[0]),wt(g,p,b),Yt(f,f,g)}X(f,f);for(let d=o;d<y;++d){const h=f[0],v=f[1],u=f[2];te(a,d,h,v,u)}}function xe(n){var t,e;return(((e=(t=n.material)==null?void 0:t.color)==null?void 0:e.a)??0)===1}const S=P(),E=P(),H=new ae,_t=[0,2,1],bt=[0,1,2],we=.01,Se=[P(),P(),P()],Pe=P(),ve=P();class Ce{constructor(t,e,s,a){this.positions=t,this.elevation=e,this.normals=s,this.heights=a}}class Ee{constructor(t,e,s,a){this.topVertexStart=t,this.topVertexCount=e,this.topFaceStart=s,this.topFaceCount=a}}export{je as K,ye as X,Ve as a,Ue as c,ge as l,Le as p,ue as r,Re as s,Oe as u};
