const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/deleteForwardEdits-kkeP4SCx.js","assets/index-BMCdo1DP.js","assets/index-CUvnBExu.css","assets/DeleteForwardEditsParameters-DvROBygX.js"])))=>i.map(i=>d[i]);
import{iM as T,c as V,ce as k,_ as A,m as x,b as D,au as F,at as P,a4 as O}from"./index-BMCdo1DP.js";const W=T(),$=new Map,H=new Map;async function C(e,n,a){if(!e||!a)return!1;if(!n)return!0;const t=new URL(e).host;let s=$.get(t);if(!s){const o=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");s=(await k(o,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return s===n}async function G(e,n,a=!1){var o,r,d;if(!e||!n)return!0;const t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),s=(o=H.get(t))==null?void 0:o.entries();if(s){for(const[h,l]of s)if(l.name===n){const m=!((r=l.stack)!=null&&r.hasForwardEdits());if(!m&&a){const[{deleteForwardEdits:p},{default:f}]=await Promise.all([V(()=>import("./deleteForwardEdits-kkeP4SCx.js"),__vite__mapDeps([0,1,2])),V(()=>import("./DeleteForwardEditsParameters-DvROBygX.js"),__vite__mapDeps([3,1,2]))]),u=await p(t,h,new f({sessionId:W,moment:l.moment}));return u.success&&((d=l.stack)==null||d.clearForwardEdits()),u.success}return m}}return!0}function q(e,n){var s;if(!e)return!1;const a=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=(s=H.get(a))==null?void 0:s.entries();if(t){for(const[o,r]of t)if(r.name===n)return r.lockType==="edit"}return!1}const y=new O;function B(e){return y.on("apply-edits",new WeakRef(e))}function N(e){return y.on("update-moment",new WeakRef(e))}function J(e,n,a=null,t=!1){const s=P();return t=n==null||t,y.emit("apply-edits",{serviceUrl:e,layerId:n,gdbVersion:a,mayReceiveServiceEdits:t,result:s.promise}),s}const S=Symbol();function K(e){return e!=null&&typeof e=="object"&&S in e}function b(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function M(e,n,a){const t=new URL(e).host,s=$.get(t),o=r=>!r||r===s;return o(n)&&o(a)||n===a}const Q=e=>{var s;var n;const a=e;let t=(s=class extends a{constructor(...o){super(...o),this[n]=!0,this._applyEditsHandler=r=>{const{serviceUrl:d,layerId:h,gdbVersion:l,mayReceiveServiceEdits:m,result:p}=r,f=d===this.url,u=h!=null&&this.layerId!=null&&h===this.layerId,R=b(this),U=b(this)&&M(d,l,this.gdbVersion);if(!f||R&&!U||!u&&!m)return;const L=p.then(i=>{var v;if(this.lastEditsEventDate=new Date,u&&(i.addedFeatures.length||i.updatedFeatures.length||i.deletedFeatures.length||i.addedAttachments.length||i.updatedAttachments.length||i.deletedAttachments.length))return this.emit("edits",F(i)),i;const _=(v=i.editedFeatures)==null?void 0:v.find(({layerId:g})=>g===this.layerId);if(_){const{adds:g,updates:w,deletes:E}=_.editedFeatures,j={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:g?g.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],deletedFeatures:E?E.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],updatedFeatures:w?w.map(({current:{attributes:c}})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],editedFeatures:F(i.editedFeatures),exceededTransferLimit:!1,historicMoment:F(i.historicMoment)};return this.emit("edits",j),j}const I={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:F(i.editedFeatures),exceededTransferLimit:!1,historicMoment:F(i.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(d,l,I.historicMoment)&&this.emit("edits",I),I}).then(i=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(d,l,i.historicMoment)&&(this.historicMoment=i.historicMoment),i));this.emit("apply-edits",{result:L})},this._updateMomentHandler=r=>{const{serviceUrl:d,gdbVersion:h,moment:l}=r,m=d===this.url,p=b(this),f=b(this)&&M(d,h,this.gdbVersion),u=b(this)&&!M(d,this.gdbVersion,null);m&&p&&f&&u&&"historicMoment"in this&&this.historicMoment!==l&&(this.historicMoment=l)},this.when().then(()=>{this.addHandles(B(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(N(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(o,r,d){return"historicMoment"in this&&this.historicMoment!==d&&q(o,r)}},n=S,s);return A([x()],t.prototype,"lastEditsEventDate",void 0),t=A([D("esri.layers.mixins.EditBusLayer")],t),t};export{Q as F,q as a,J as c,G as i,C as o,K as p,W as t};
