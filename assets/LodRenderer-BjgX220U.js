import{kf as Q,p3 as K,p4 as N,p5 as X,f0 as k,p6 as ee,p7 as te,p8 as ne,p9 as se,pa as ae,fV as W,pb as ie,bB as j,bY as Y,bF as Z,dw as re,dx as A,pc as oe,aa as E,pd as le,pe as ce,n6 as he,pf as de,dE as ue,pg as _e,S as x,ph as me,lL as pe,lt as O,nb as ge,cI as w,u as fe,pi as L,dZ as B,s as V,fQ as ye,pj as be,pk as ve,pl as D,pm as Ie,pn as R,cJ as P,po as Ce,pp as Se,_ as f,m as y,b as De}from"./index-CG5kgmiA.js";class Re extends Q{constructor(e,n){super(s=>K(this._instanceData.view.boundingSphere.getVec(s,Ee)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=n,this._tmpSphere=X(),this._tmpMat4=k()}addInstance(e){const n=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);ee(this._tmpSphere,this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*te(s),n.setVec(e,ne(this._tmpSphere)),this.add([e])}removeInstance(e){this.remove([e])}}const Ee=N();class xe{constructor(e,n){this._worldSpaceRadius=e,this._minScreenSpaceRadii=n}selectLevel(e,n,s){const a=s.computeScreenPixelSizeAt(e),o=this._worldSpaceRadius*n/a;let i=0;for(let l=1;l<this._minScreenSpaceRadii.length;++l)o>=this._minScreenSpaceRadii[l]&&(i=l);return i}}class we{constructor(e,n){this.geometry=n;const s=e.renderContext.rctx,a=n.renderGeometry,{material:o,layout:i,buffer:l}=a;this._materials=e.materials,o.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new se(o,this._materials),this.vbo=new ae(s,W(i),l),this.vao=new ie(s,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,n,s,a,o,i,l,r){return this.geometry.intersect(e,n,s,a,o,i,l,r)}}class M{static async create(e,n,s){const a=await Promise.allSettled(n.components.map(i=>e.controller.schedule(()=>new we(e,i.geometry),s))),o=a.map(i=>i.status==="fulfilled"?i.value:null).filter(j);if(Y(s)||o.length!==a.length){o.forEach(i=>i.destroy()),Z(s);for(const i of a)if(i.status==="rejected")throw i.reason}return new M(n.minScreenSpaceRadius,o)}constructor(e,n){this.minScreenSpaceRadius=e,this.components=n}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,n,s,a,o,i,l){this.components.forEach(r=>r.intersect(e,n,s,a,o,i,this.boundingSphere,l))}get boundingBox(){if(this._boundingBox==null){const e=re();this.components.forEach(n=>{n.boundingInfo!=null&&(A(e,n.boundingInfo.bbMin),A(e,n.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){const e=this.boundingBox,n=E();oe(e,n),this._boundingSphere={center:n,radius:.5*le(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,n)=>e+n.numTriangles,0)}}const Le=t=>{const e=t.baseBoundingSphere.radius,n=t.levels.map(s=>s.minScreenSpaceRadius);return new xe(e,n)};let p=class extends ce{constructor(t,e){super(t),this.type=3,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new he,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,n=>this._produces(n)],[4,n=>!!this._hasTransparentLevels()&&this._produces(n)]]),this._instanceData=new de({shaderTransformation:t.shaderTransformation},t.symbol.materialParameters),this.addHandles(e.registerTask(ue.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=_e(this.symbol.materialParameters),this._glInstanceBufferLayout=W(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDatas)e[0]!==x&&t.push(e[1]);return t}hasHighlight(t){return this._highlightRenderInstanceDatas.has(t)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmitters(){return this._levels.some(t=>t.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((t,e)=>e.reduce((n,s)=>n+s.usedMemory,t),this._levels.reduce((t,e)=>t+e.components.reduce((n,s)=>n+s.usedMemory,0),0))}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach((n,s)=>{const a=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,o=n.triangleCount;e.push({renderedInstances:a,renderedTriangles:a*o,trianglesPerInstance:o})}),{totalInstances:t,renderedInstances:e.reduce((n,s)=>n+s.renderedInstances,0),renderedTriangles:e.reduce((n,s)=>n+s.renderedTriangles,0),levels:e}}_createRenderInstanceDataArray(){const{rctx:t}=this._context.renderContext;return this.symbol.levels.map(e=>new me(t,this._instanceBufferLayout))}async initializeRenderContext(t,e){this._context=t,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();const n=await Promise.allSettled(this.symbol.levels.map(a=>M.create(t,a,e))),s=n.map(a=>a.status==="fulfilled"?a.value:null).filter(j);if(Y(e)||s.length!==n.length){s.forEach(a=>a.destroy()),Z(e);for(const a of n)if(a.status==="rejected")throw a.reason}this._levels=s,this._levelSelector=Le(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceDatas.forEach(t=>t.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(t=>t.components.some(e=>{const n=e.material.produces.get(4);return n==null?void 0:n(0)}))}hasHighlights(){return pe(this._highlightRenderInstanceDatas,t=>t.some(e=>e.size>0))}_produces(t){return(t!==9||this.hasHighlights())&&(t!==5||this.hasHighlight(x))}prepareRender(t){if(!O.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(ge),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;const e=this._getInstanceDatas(t);if(!e)return null;const n=new Array,s=this.levels;return e.forEach(a=>s.forEach(({components:o},i)=>o.forEach(l=>n.push(this._beginComponent(t,a[i],l))))),n}render(t,e){const n=this._getInstanceDatas(t);if(!n||e==null)return;let s=0;const a=this.levels;n.forEach(o=>a.forEach(({components:i},l)=>i.forEach(r=>this._renderComponent(t,e[s++],o[l],r,l)))),t.rctx.unbindBuffer(34962),t.rctx.bindVAO(null)}_getInstanceDatas(t){var l;const{output:e,bind:n}=t,s=e===9,a=e===5,o=e!==6;if(!s&&!a)return o?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDatas:i}=this;if(o){if(s){const _=(l=n.highlight)==null?void 0:l.name;if(!_)return null;const h=i.get(_);return h?[h]:null}const r=i.get(x);return a?r?[r]:null:Array.from(i.values())}return null}intersect(t,e,n,s){if(!this.baseMaterial.visible||this._octree==null)return;const a=E();w(a,s,n);const o=i=>{this._instanceData.getCombinedModelTransform(i,q),t.transform.set(q),P(H,n,t.transform.inverse),P(z,s,t.transform.inverse);const l=this._instanceData.getState(i),r=this._instanceData.getLodLevel(i),_=this._levels.length;4&l&&(R(!!(18&l),"invalid instance state"),R(r>=0&&r<_,"invaid lod level"),this._levels[r].intersect(t,e,H,z,i,this.metadata,_))};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(o):this._octree.forEachAlongRay(n,a,o)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){var t;if(this._octreeCached==null){const e=this._instanceData,n=(t=e.view)==null?void 0:t.state;if(!n)return null;this._octreeCached=new Re(e,this.baseBoundingSphere);for(let s=0;s<e.capacity;++s)18&n.get(s)&&this._octreeCached.addInstance(s)}return this._octreeCached}_invalidateOctree(){this._octreeCached=fe(this._octreeCached)}queryDepthRange(t){if(this._octree==null)return new L;const e=t.viewForward,n=this._octree.findClosest(e,1,t.frustum),s=this._octree.findClosest(e,-1,t.frustum);if(n==null||s==null)return new L;const a=t.eye,o=this._instanceData.view;o.boundingSphere.getVec(n,g),w(g,g,a);const i=B(g,e)-g[3];o.boundingSphere.getVec(s,g),w(g,g,a);const l=B(g,e)+g[3];return new L(i,l)}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(t=>t.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){const{_enableLevelSelection:e,_camera:n,_levelSelector:s}=this;this._allRenderInstanceData.forEach(u=>u.forEach(c=>c.beginUpdate()));const a=this._instanceData,o=a.view;let i=a.size;const l=a.capacity;let r=this._instanceIndex;const _=Math.ceil(l/500),{_highlightRenderInstanceDatas:h}=this;for(let u=0;u<i&&!t.done;++u){r===this._cycleStartIndex&&this._startUpdateCycle();const c=o.state.get(r);let d=0;if(!(1&c)){r=r+1===l?0:r+1,i++;continue}const I=o.lodLevel.get(r);if(2&c&&this._defaultRenderInstanceData[I].freeTail(),16&c){const m=a.geHighlightOptionsPrev(r);if(m){const b=h.get(m);if(!b)throw new V("internal:lod-renderer","Internal error in lodRenderer");b[I].freeTail(),b.every(S=>S.isEmpty)&&(b.forEach(S=>S.destroy()),h.delete(m))}}if(32&c)a.freeInstance(r);else if(4&c){let m=0;if(e&&(o.modelOrigin.getVec(r,U),m=s.selectLevel(U,a.getCombinedMedianScaleFactor(r),n)),d=-83&c,m>=0)if(8&c){const b=a.getHighlightName(r);if(b){const S=()=>{const $=this._createRenderInstanceDataArray();return $.forEach(J=>J.beginUpdate()),$},T=ye(h,b,S);if(m>=T.length)throw new V("internal:lod-renderer",`LodRenderer internal error - missing lodLevel ${m}`);F(T[m],o,r)}d|=16}else F(this._defaultRenderInstanceData[m],o,r),d|=2;o.state.set(r,d),o.lodLevel.set(r,m)}else d=-83&c,o.state.set(r,d);const v=!!(18&c),C=!!(18&d);this._octreeCached!=null&&(!v&&C?this._octreeCached.addInstance(r):v&&!C?this._octreeCached.removeInstance(r):v&&C&&64&c&&(this._octreeCached.removeInstance(r),this._octreeCached.addInstance(r))),r=r+1===l?0:r+1,r%_===0&&t.madeProgress(),v!==C&&this.metadata.notifyGraphicVisibilityChanged(r),C&&64&c&&this.metadata.notifyGraphicGeometryChanged(r)}this._instanceIndex=r,this._allRenderInstanceData.forEach(u=>u.forEach(c=>c.endUpdate())),this._context.requestRender()}_beginComponent(t,e,n){if(e.size===0)return null;const s=n.glMaterials.load(t.rctx,t.bind.slot,t.output);return s==null?void 0:s.beginSlot(t.bind)}_renderComponent(t,e,n,s,a){if(!e)return;const{bind:o,rctx:i}=t;i.runAppleAmdDriverHelper();const l=i.bindTechnique(e,o,s.material.parameters,Te),r=this._glInstanceBufferLayout;l.assertCompatibleVertexAttributeLocations(s.vao,ve(r)),i.bindVAO(s.vao),O.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===0&&(l.setUniform4fv("externalColor",G[Math.min(a,G.length-1)]),l.setUniform1i("symbolColorMixMode",Ie.replace));const _=n.capacity,h=n.headIndex,u=n.tailIndex,c=n.firstIndex,d=(I,v)=>{Ce(i,l.locations,n.buffer,I),i.drawArraysInstanced(e.primitiveType,0,s.numVertices,v-I)};s.material.transparent&&c!=null?h>u?(R(c>=u&&c<=h,"invalid firstIndex"),d(c,h),d(u,c)):h<u&&(c<=h?(R(c>=0&&c<=h,"invalid firstIndex"),d(c,h),d(u,_),d(0,c)):(R(c>=u&&c<=_,"invalid firstIndex"),d(c,_),d(0,h),d(u,c))):h>u?d(u,h):h<u&&(d(0,h),d(u,_))}};function F(t,e,n){const s=t.allocateHead();Me(e,n,t.view,s)}function Me(t,e,n,s){Se(t.modelOrigin,e,n.modelOriginHi,n.modelOriginLo,s),n.model.copyFrom(s,t.model,e),n.modelNormal.copyFrom(s,t.modelNormal,e),t.color&&n.color&&n.color.copyFrom(s,t.color,e),t.olidColor&&n.olidColor&&n.olidColor.copyFrom(s,t.olidColor,e),t.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(s,t.featureAttribute,e)}f([y({constructOnly:!0})],p.prototype,"symbol",void 0),f([y({constructOnly:!0})],p.prototype,"metadata",void 0),f([y({constructOnly:!0})],p.prototype,"shaderTransformation",void 0),f([y()],p.prototype,"_instanceData",void 0),f([y()],p.prototype,"_cycleStartIndex",void 0),f([y({readOnly:!0})],p.prototype,"_enableLevelSelection",null),f([y()],p.prototype,"_updateCyclesWithStaticCamera",void 0),f([y({readOnly:!0})],p.prototype,"readyToRun",null),p=f([De("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],p);const U=E(),g=N(),q=k(),H=E(),z=E(),G=[D(1,0,1,1),D(0,0,1,1),D(0,1,0,1),D(1,1,0,1),D(1,0,0,1)],Te=new be;export{p as F};
