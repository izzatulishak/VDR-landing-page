import{x as b,q as Y,aa as y,ar as mt,jf as gt,je as ye,jh as fe,a9 as me,Ct as zt,lF as _t,_ as a,m as u,b as O,s as Ut,Cu as ae,dK as qt,Cv as yt,C1 as Ht,zU as Bt,zs as J,zt as ee,Bu as Pe,Bv as It,zE as I,zB as A,zF as te,zG as ie,c as se,BB as Fe,zH as re,zM as oe,lN as ft,dc as Nt,f0 as z,zv as Wt,Cw as Xt,Bt as De,rU as vt,Aa as Zt,Cx as Kt,Ae as Qt,BC as wt,BY as bt,BD as ge,l as Yt,oH as B,ks as H,rQ as Jt,wV as Se,n6 as ei,Cy as ti,c6 as Ct,pa as xt,fV as Vt,pb as Pt,h as Ft,a as S,K as w,g as ii,N,U as $t,jn as si,ax as ri,cH as Tt,ai as ve,aj as we,af as be,iT as Rt,j$ as Gt,cE as $e,e0 as oi,u as $,qT as ni,c9 as ai,Ar as li,uq as je,p4 as ui,zD as ci,Au as hi,A8 as di,A7 as pi,pk as mi,BX as gi,Cz as Ee,pj as _i,CA as ke,CB as le,Bn as _e,BZ as yi,cK as fi,ux as vi,h8 as wi,al as Ae,uy as ze,dz as W,cI as K,dy as Ue,rc as bi,Bf as Ci,dZ as qe,w8 as Ce,re as xi,eW as He,eF as ue,l_ as Vi,oT as Pi,y8 as Fi,cm as $i,eZ as Be,f8 as xe,mP as Ti,ek as Ie,v as Ri,f as Ne,bY as Gi,w as Mi,a1 as We}from"./index-C571AxL3.js";import{e as Oi}from"./getDefaultUnitForView-C7HNBH73.js";import{e as Li}from"./AnalysisView3D-BWHCL4Uw.js";import{e as Mt}from"./earcut-D9gy186-.js";import{a as Di,p as ce,w as Si}from"./ShadedColorMaterial.glsl-CpDVvm1l.js";import{r as Ve,X as ji}from"./Graphics3DExtrudeSymbolLayer-bKkZ9oel.js";import{a5 as Xe,ad as Ze}from"./euclideanLengthMeasurementUtils-Dz4SQOvQ.js";import{d as Ei}from"./quantityFormatUtils-n-IyDv3P.js";import{f as Ke,m as ki}from"./Segment-CtFwIS4A.js";import{R as Qe}from"./OutlineVisualElement-9botIYUb.js";import{h as Ai}from"./lineStippleUtils-C89mzWlO.js";import{s as Ye}from"./substitute-u7BJF9h0.js";import{_ as zi,S as Ui}from"./SlicePlaneMaterial.glsl-Bg7Cs6ka.js";import{T as qi}from"./dragEventPipeline3D-CeHRAqDg.js";import{r as Hi,p as Bi,j as Ii}from"./InteractiveToolBase-DZ60M1gf.js";import{l as Ot,a as Je}from"./SketchOptions-B3x10y5q.js";import{r as Ni,R as Wi,H as Xi}from"./SketchTooltipInfo-DDuwdTS-.js";import{h as Zi}from"./TooltipInfoWithCoordinates-B_HYfboG.js";import{s as Ki,d as Qi}from"./SketchViewModel-CTknulwl.js";import{a as Yi}from"./allLayerSnapping-BvzBJNzH.js";import"./VisualElement-EfjpWVkC.js";import"./line-C7kzMADi.js";import"./ColorMaterial.glsl-CxGPZSvV.js";import"./TriangleMaterial-V3G_wCf-.js";import"./SnappingCandidate-DGkpYqI6.js";import"./renderingInfoUtils-nx-rM7m1.js";import"./triangulationUtils-Cemdf1UU.js";import"./deduplicate-DMC37eq1.js";import"./utils-CS1S-yyX.js";import"./geometry2dUtils-CD4q089G.js";import"./geodeticLengthOperator-Ccpuuys5.js";import"./geodeticCurveType-CirnHLSB.js";import"./TextOverlayItem-B7kn4ppJ.js";import"./EngineVisualElement-szOwVtA2.js";import"./LaserlinePath.glsl-D3_vKfcz.js";import"./line-DSq2S5cb.js";import"./sliceToolConfig-nnGy4iG3.js";import"./DefaultLayouts-DzAiMwM3.js";import"./EditGeometryOperations-BYsyvbYA.js";import"./rotate-DVJcFOSW.js";import"./curveOperationUtils-B9M5Gqc0.js";import"./MeshTransform-CpIFa6T-.js";import"./a11yUtils-BPTXCvOe.js";import"./angularMeasurementUtils-DWA3z3Vr.js";import"./automaticAreaMeasurementUtils-CQcrIbLC.js";import"./geodesicAreaMeasurementUtils-CRXC3Rdq.js";import"./automaticLengthMeasurementUtils-CXp-tCzu.js";const et=new b("black");let Ji=class{constructor(){this.geometryOutlineWidth=1.5,this.geometryOutlineColor=new b("rgb(128,128,128)"),this.cutColor=new b("rgba(153, 198, 111, 0.75)"),this.fillColor=new b("rgba(200, 200, 230, 0.75)"),this.cutColorMuted=new b("rgba(176, 176, 176, 0.75)"),this.fillColorMuted=new b("rgba(194, 194, 194, 0.75)"),this.cutProjectionLineColor=b.blendColors(this.cutColor,et,.4),this.fillProjectionLineColor=b.blendColors(this.fillColor,et,.4),this.projectionLineWidth=2,this.projectionLineStippleSize=4,this.labelDistance=40,this.labelPrecisions={"cubic-millimeters":0,"cubic-centimeters":0,"cubic-decimeters":1,"cubic-meters":2,"cubic-kilometers":6,"cubic-inches":0,"cubic-feet":2,"cubic-yards":2,"cubic-miles":6,liters:2},this.maxVolumeExtentSizeVw=.7,this.minVolumeExtentSizePixels=250,this.minTargetElevation=-11e3,this.maxTargetElevation=9e3,this.targetElevationRange=this.maxTargetElevation-this.minTargetElevation,this.maxPerimeterLocalWebMercator=1e4,this.maxPerimeterGlobal=5e4}};const M=new Ji;let x=class extends Y{constructor(t){super(t),this.rawResult=null}get localOriginRenderSpace(){const{extent:t,localOrigin:i,renderCoordsHelper:s}=this,r=y();return s.toRenderCoords(i,t.spatialReference,r),r}get cameraPositionRenderSpace(){const{localOriginRenderSpace:t,renderCoordsHelper:i}=this,s=y(),r=1/i.unitInMeters;return i.setAltitude(s,ts*r,t),s}get boundingRect(){const{extent:t,renderCoordsHelper:i}=this,s=mt();return i.viewingMode===2?gt(t,s):(this._expandBoundingRect(t.xmin,t.ymin,s),this._expandBoundingRect(t.xmax,t.ymin,s),this._expandBoundingRect(t.xmin,t.ymax,s),this._expandBoundingRect(t.xmax,t.ymax,s)),s}get cameraDimensions(){const{boundingRect:t}=this;return{width:fe(t),height:ye(t)}}get cameraNearFar(){const{renderCoordsHelper:{unitInMeters:t}}=this,i=1/t;return{near:is*i,far:ss*i}}get upVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,2,y())}get northVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,1,y())}get eastVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,0,y())}_expandBoundingRect(t,i,s){const{extent:r,eastVector:l,northVector:n,upVector:c,renderCoordsHelper:h}=this,d=r.center.z??0;me(he,t,i,d),h.toRenderCoords(he,r.spatialReference,he),zt(he,l,n,c,tt),_t(s,tt,s)}};a([u()],x.prototype,"renderCoordsHelper",void 0),a([u()],x.prototype,"extent",void 0),a([u()],x.prototype,"localOrigin",void 0),a([u()],x.prototype,"localOriginRenderSpace",null),a([u()],x.prototype,"cameraPositionRenderSpace",null),a([u()],x.prototype,"boundingRect",null),a([u()],x.prototype,"cameraDimensions",null),a([u()],x.prototype,"upVector",null),a([u()],x.prototype,"northVector",null),a([u()],x.prototype,"eastVector",null),a([u()],x.prototype,"rawResult",void 0),x=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillComputation")],x);const he=y(),tt=y(),es=100,ts=M.maxTargetElevation,is=0,ss=M.targetElevationRange+es;let ne=class extends Ut{constructor(t,i,s){super(t,i,s),this.name="unknown",this.name=t}};class it extends ne{constructor(){super("perimeter-too-large","The input geometry's perimeter is too large for the current viewing mode and spatial reference.")}}let rs=class extends ne{constructor(){super("distance-too-far","The measurement geometry is too far from the camera.")}},os=class extends ne{constructor(){super("distance-too-close","The measurement geometry is too close to the camera.")}};class ns extends ne{constructor(){super("unsupported-coordinate-system","The coordinate system of the view (viewing mode and spatial reference) is not supported.")}}let as=class extends ne{constructor(){super("unsupported-layer-transparency","The volume measurement analysis does not support transparent layers.")}};function ls(e,t,i="cubic-meters"){const s=e-t,r=e+t;return{cutVolume:ae(e,i),fillVolume:ae(t,i),netVolume:ae(s,i),totalVolume:ae(r,i)}}function de(e,t){return e?qt(e,yt(e.value,e.unit,t)):null}let R=class extends Y{constructor(t){super(t)}get cutVolume(){return de(this.rawResult.cutVolume,this.unit)}get fillVolume(){return de(this.rawResult.fillVolume,this.unit)}get netVolume(){return de(this.rawResult.netVolume,this.unit)}get totalVolume(){return de(this.rawResult.totalVolume,this.unit)}};a([u({constructOnly:!0})],R.prototype,"measureType",void 0),a([u()],R.prototype,"cutVolume",null),a([u()],R.prototype,"fillVolume",null),a([u()],R.prototype,"netVolume",null),a([u()],R.prototype,"totalVolume",null),a([u({constructOnly:!0})],R.prototype,"rawResult",void 0),a([u({constructOnly:!0})],R.prototype,"unit",void 0),R=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementResult")],R);class Lt extends Ht{constructor(){super(...arguments),this.output=0}}a([Bt({count:11})],Lt.prototype,"output",void 0);let Te=class extends J{};function Dt(){const e=new ee;return e.include(Pe),e.fragment.include(It),e.fragment.uniforms.add(new I("cutFillReferenceDepthTexture",t=>t.referenceDepthTexture),new I("cutFillTargetDepthTexture",t=>t.targetDepthTexture)),e.fragment.code.add(A`bool outsideFar(float depth) {
return depth >= 1.0;
}`),e.fragment.main.add(A`float referenceDepth = depthFromTexture(cutFillReferenceDepthTexture, uv);
float targetDepth = depthFromTexture(cutFillTargetDepthTexture, uv);
if (outsideFar(targetDepth)) {
discard;
}
float depth = referenceDepth - targetDepth;
float cut = min(0.0, depth);
float fill = max(0.0, depth);
fragColor = vec4(cut, fill, 0.0, 0.0);`),e}const us=Object.freeze(Object.defineProperty({__proto__:null,CutFillDepthParameters:Te,build:Dt},Symbol.toStringTag,{value:"Module"}));let st=class extends te{constructor(t,i){super(t,i,new ie(us,()=>se(()=>Promise.resolve().then(()=>$s),void 0)),Fe)}initializePipeline(){return re({colorWrite:oe})}},Re=class extends J{};function St(){const e=new ee;return e.include(Pe),e.fragment.uniforms.add(new I("cutFillDepthTexture",t=>t.depthTexture)),e.fragment.main.add(A`ivec2 iuv = ivec2(gl_FragCoord.xy) * 2;
vec2 sum = vec2(0.0);
for (int dx = 0; dx < 2; dx++) {
for (int dy = 0; dy < 2; dy++) {
sum += texelFetch(cutFillDepthTexture, iuv + ivec2(dx, dy), 0).rg;
}
}
fragColor = vec4(sum.r, sum.g, 0.0, 0.0);`),e}const cs=Object.freeze(Object.defineProperty({__proto__:null,CutFillReductionParameters:Re,build:St},Symbol.toStringTag,{value:"Module"}));class rt extends te{constructor(t,i){super(t,i,new ie(cs,()=>se(()=>Promise.resolve().then(()=>Ts),void 0)),Fe)}initializePipeline(){return re({colorWrite:oe})}}let Ge=class extends J{constructor(){super(...arguments),this.origin=ft,this.cutFillCamera={projectionMatrix:z(),viewMatrix:z(),nearFar:Nt()}}};function jt(e){const t=new ee,{vertex:i,fragment:s,varyings:r,attributes:l}=t;return t.include(Wt),t.include(Xt,e),l.add("position","vec3"),r.add("depth","float",{invariant:!0}),i.uniforms.add(new De("proj",n=>n.cutFillCamera.projectionMatrix),new De("view",n=>vt(hs,n.cutFillCamera.viewMatrix,n.origin)),new Zt("nearFar",n=>n.cutFillCamera.nearFar)),i.main.add(A`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, depth);`),s.main.add(A`fragColor = vec4(1.0);
outputDepth(depth);`),t}const hs=z(),ds=Object.freeze(Object.defineProperty({__proto__:null,CutFillTargetDepthParameters:Ge,build:jt},Symbol.toStringTag,{value:"Module"}));let ot=class extends te{constructor(t,i){super(t,i,new ie(ds,()=>se(()=>Promise.resolve().then(()=>Rs),void 0)),Kt)}initializePipeline(){return re({colorWrite:oe,depthWrite:Qt,depthTest:{func:519}})}},j=class extends wt{constructor(t){super(t),this.consumes={required:[bt.TRANSPARENT]},this.produces=ge.CUTFILL_DEPTH,this._cutFillTargetDepthConfiguration=new Lt,this._cutFillTargetDepthParameters=new Ge,this._cutFillDepthParameters=new Te,this._cutFillReductionParameters=new Re,this.needsRender=!1,this.done=!0,this._localOrigin=y(),this._maxTextureSize=4096,this._width=0,this._height=0,this._reducedWidth=0,this._reducedHeight=0,this._depthFormat=13,this._colorFormat=10,this._targetVao=null}initialize(){this._maxTextureSize=Math.min(Yt("esri-mobile")?1024:this._maxTextureSize,this.fboCache.rctx.parameters.maxTextureSize),this._cutFillTargetDepthConfiguration.output=8}destroy(){this._targetVao=B(this._targetVao)}precompile(){this.techniques.precompile(ot,this._cutFillTargetDepthConfiguration),this.techniques.precompile(st),this.techniques.precompile(rt),this.view.stage.renderer.precompileCutFill()}render(t){var C;const i=t.find(({name:V})=>V===ge.CUTFILL_DEPTH);if(!this._orthographicCamera||!this._targetVao||!this.needsRender)return i;const s=this.techniques.get(ot,this._cutFillTargetDepthConfiguration),r=this.techniques.get(st),l=this.techniques.get(rt);if(!s.compiled||!r.compiled||!l.compiled)return this.requestRender(1),i;this.needsRender=!1;const n=this.renderingContext,c=this.fboCache,h=n.getViewport(),d=c.acquire(this._width,this._height,"cutfill reference depth",this._depthFormat);n.bindFramebuffer(d.fbo),n.setViewport(0,0,this._width,this._height),n.clear(1280),this.view.stage.renderer.renderCutFillReferenceDepth(this._orthographicCamera);const o=c.acquire(this._width,this._height,"cutfill target depth",this._depthFormat);n.bindFramebuffer(o.fbo),n.setViewport(0,0,this._width,this._height),n.setClearDepth(1),n.clear(256),this._cutFillTargetDepthParameters.origin=this._localOrigin,this._cutFillTargetDepthParameters.cutFillCamera=this._orthographicCamera,n.bindTechnique(s,this.bindParameters,this._cutFillTargetDepthParameters),n.bindVAO(this._targetVao),n.drawArrays(H.TRIANGLES,0,this._targetVao.vertexCount("geometry"));let p=c.acquire(this._width,this._height,"cutfill reduction even",this._colorFormat),m=c.acquire(this._width,this._height,"cutfill reduction odd",this._colorFormat);this._cutFillDepthParameters.referenceDepthTexture=d.depthTexture,this._cutFillDepthParameters.targetDepthTexture=o.depthTexture,n.bindFramebuffer(p.fbo),n.bindTechnique(r,this.bindParameters,this._cutFillDepthParameters),n.setClearColor(0,0,0,0),n.clear(16384),n.screen.draw(),d.release(),o.release();let f=this._width,v=this._height;const _=Math.ceil(Math.log2(Math.min(f,v)));for(let V=0;V<_;V++)f=Math.ceil(f/2),v=Math.ceil(v/2),this._cutFillReductionParameters.depthTexture=p.getTexture(),this._prepareFBO(m,f,v),n.bindTechnique(l,this.bindParameters,this._cutFillReductionParameters),n.screen.draw(),[p,m]=[m,p];return this._buffer=new Float32Array(f*v*2),(C=p.fbo)==null||C.readPixels(0,0,f,v,33319,Jt.FLOAT,this._buffer),this._reducedWidth=f,this._reducedHeight=v,p.release(),m.release(),n.setViewport(h.x,h.y,h.width,h.height),this.done=!0,i}setup(t,i){const s=this.renderingContext,{cameraDimensions:{width:r,height:l},localOriginRenderSpace:n}=t,c=this._maxTextureSize,h=l/r,d=r>l?c:c/h,o=r>l?c*h:c;this._width=Se(d),this._height=Se(o);const p=[this._width,this._height];this._orthographicCamera=this._createCamera(t,p),this._targetVao=B(this._targetVao),this._targetVao=ps(s,i),this._localOrigin=n,this.done=!1}start(){this._width!==0&&this._height!==0&&(this.needsRender=!0)}getDepth(){var s,r;let t=0,i=0;for(let l=0;l<this._reducedWidth;l++)for(let n=0;n<this._reducedHeight;n++){const c=l+n*this._reducedHeight;t+=((s=this._buffer)==null?void 0:s[2*c])??0,i+=((r=this._buffer)==null?void 0:r[2*c+1])??0}return{cut:t,fill:i}}get width(){return this._width}get height(){return this._height}get updating(){return this.needsRender||!this.done}_prepareFBO(t,i,s){const r=this.renderingContext;r.bindFramebuffer(t.fbo),r.setViewport(0,0,i,s),r.setClearColor(0,0,0,0),r.clear(16384)}_createCamera(t,i){const{cameraPositionRenderSpace:s,localOriginRenderSpace:r,northVector:l,cameraDimensions:{width:n,height:c},cameraNearFar:{near:h,far:d}}=t,o=new ei({eye:s,center:r,up:l,near:h,far:d});return o.viewport=[0,0,i[0],i[1]],ti(o.projectionMatrix,-n/2,n/2,-c/2,c/2,h,d),o}};a([u()],j.prototype,"consumes",void 0),a([u()],j.prototype,"produces",void 0),a([u()],j.prototype,"needsRender",void 0),a([u()],j.prototype,"done",void 0),a([u()],j.prototype,"updating",null),j=a([O("esri.views.3d.webgl-engine.lib.CutFillDepth")],j);const nt=Ct().vec3f("position").freeze();function ps(e,t){const{positions:i,indices:s}=t,r=nt.createBuffer(s.length),l=r.position;for(let c=0;c<s.length;++c){const h=3*s[c];l.set(c,0,i[h]),l.set(c,1,i[h+1]),l.set(c,2,i[h+2])}const n=new xt(e,Vt(nt),r.buffer);return new Pt(e,n)}let ms=class{constructor(t,i){this.positions=t,this.indices=i}},g=class extends Y{constructor(e){super(e),this._getElevationProvider=()=>this.view.elevationProvider,this._updatingHandles=new Ft,this._computationValue=null}initialize(){const e=this.view;this._renderer=new j({view:e}),this._updatingHandles.add(()=>({computation:this._computation,renderGeometry:this._targetGeometryRenderInfo}),({computation:t,renderGeometry:i})=>{t&&i&&(this._renderer.setup(t,i),this._renderer.start())},S),this.addHandles([this._createElevationUpdateHandle(),w(()=>this._targetGeometry,t=>this.analysisViewData.targetGeometry=t,N),w(()=>this._elevationAlignedGeometry,t=>this.analysisViewData.elevationAlignedGeometry=t,N),w(()=>{var t;return{computation:this._computation,extent:(t=this._projectedGeometry)==null?void 0:t.extent,localOrigin:this._localOrigin}},({computation:t,extent:i,localOrigin:s})=>{t&&i&&s&&(t.extent=i,t.localOrigin=s)},$t),ii(()=>this._renderer.done,()=>this._updateResult())])}destroy(){this._updatingHandles.destroy(),this._renderer.destroy()}get _projectedGeometry(){if(!this.analysis.valid)return null;const e=this.analysis.geometry,t=si(e,this.view.spatialReference);return t.pending?(this._updatingHandles.addPromise(t.pending),null):(e&&!t.geometry&&Di(this.analysis,e.spatialReference,ri.getLogger(this)),t.geometry)}get _localOrigin(){var t;const e=(t=this._projectedGeometry)==null?void 0:t.extent;return e?Tt(e.center.x,e.center.y,0):null}get _elevationAlignedGeometry(){const e=this._projectedGeometry;if(!e)return null;const t=e.clone();return gs(this._getElevationProvider(),t),t}get _targetGeometry(){const e=this._elevationAlignedGeometry;if(!e)return null;const t=this.analysis.measureType,{effectiveTargetElevation:i}=this.analysisViewData;if(t==="stockpile"||i==null)return e;const s=e.clone();return s.rings[0].forEach(r=>r[2]=i),s}get _targetGeometryRenderInfo(){var m;const e=this._targetGeometry,t=(m=this._projectedGeometry)==null?void 0:m.extent,i=this._localOrigin;if(!e||!t||!i)return null;const{elevationProvider:s,renderCoordsHelper:r}=this.view,l=Ve(e,s,r,ve.fromElevationInfo(new we({mode:"absolute-height"}))),{polygons:n}=l,c=n[0],h=Mt(c.position,c.holeIndices,3),d=be(3*c.count),o=z(),p=z();return Rt(t.spatialReference,i,o,r.spatialReference),p[12]=-o[12],p[13]=-o[13],p[14]=-o[14],Gt(d,c.position,p),new ms(d,h)}get updating(){return this._renderer.updating||this._updatingHandles.updating}get result(){var t;const e=(t=this._computation)==null?void 0:t.rawResult;return e?new R({measureType:this.analysis.measureType,rawResult:e,unit:this.analysisViewData.effectiveDisplayUnits.volume}):null}get error(){return this._unsupportedCoordinateSystemError??this._unsupportedLayerTransparencyError??this._perimeterTooLargeError??this._tooNearFarError}get _tooNearFarError(){const e=this._elevationAlignedGeometry;if(!e)return null;const{view:t}=this,{elevationProvider:i,renderCoordsHelper:s}=t,{camera:r}=t.state,l=Ve(e,i,s,ve.fromElevationInfo(new we({mode:"absolute-height"}))),{polygons:n}=l,c=n[0].position;$e(X);for(let m=0;m<c.length;m+=3)r.projectToScreen(me(vs,c[m],c[m+1],c[m+2]),ut),_t(X,ut,X);const h=fe(X),d=ye(X),{maxVolumeExtentSizeVw:o,minVolumeExtentSizePixels:p}=M;return h>r.width/r.pixelRatio*o||d>r.height/r.pixelRatio*o?new os:Math.max(h,d)<p?new rs:null}get _perimeterTooLargeError(){return this._perimeterTooLargeLocalError??this._perimeterTooLargeGlobalError}get _perimeterTooLargeLocalError(){const{spatialReference:e,state:{isLocal:t}}=this.view;if(!t||!e.isWebMercator)return null;const i=this._perimeter,{maxPerimeterLocalWebMercator:s}=M;return i!=null&&i>s?new it:null}get _perimeterTooLargeGlobalError(){if(!this.view.state.isGlobal)return null;const e=this._perimeter,{maxPerimeterGlobal:t}=M;return e!=null&&e>t?new it:null}get _unsupportedCoordinateSystemError(){return this.view.state.isLocal&&this.view.spatialReference.isGeographic?new ns:null}get _unsupportedLayerTransparencyError(){var e;return(((e=this.view.map)==null?void 0:e.ground.opacity)??1)<1?new as:null}get _perimeter(){var i;const e=(i=this._targetGeometryRenderInfo)==null?void 0:i.positions,t=e?ys(fs(e)):null;return t!=null?t/this.view.renderCoordsHelper.unitInMeters:null}get _enabled(){return!this.error}get _computation(){var s;const e=(s=this._projectedGeometry)==null?void 0:s.extent;if(!e||!this._enabled)return this._computationValue=$(this._computationValue),null;if(this._computationValue)return this._computationValue;const t=this._localOrigin;if(!t)return null;const{renderCoordsHelper:i}=this.view;return this._computationValue=new x({extent:e,localOrigin:t,renderCoordsHelper:i}),this._computationValue}_createElevationUpdateHandle(){const e=t=>{var s;const i=(s=this._projectedGeometry)==null?void 0:s.extent;t.context==="ground"&&i&&(ni(t.extent,t.spatialReference,at,this.view.spatialReference),gt(i,lt),ai(at,lt)&&(this._getElevationProvider=()=>this.view.elevationProvider))};return this.view.elevationProvider.on("elevation-change",t=>e(t))}_updateResult(){if(!this._computation)return;const{spatialReference:e,viewingMode:t}=this.view,{extent:i,boundingRect:s,cameraNearFar:{near:r,far:l}}=this._computation,{width:n,height:c}=this._renderer;let h,d;t==="local"&&e.isWebMercator?{width:h,height:d}=_s(i):(h=fe(s),d=ye(s));const o=h/n*(d/c),p=this._renderer.getDepth(),m=_=>_*(l-r)+r,f=m(p.cut)*o,v=m(p.fill)*o;this._computation.rawResult=ls(Math.abs(f),v)}};function gs(e,t){t.rings[0].forEach(i=>{i[2]=li(e,i,"ground")??0})}function _s(e){const t=Xe([e.xmin,e.ymin,0],[e.xmax,e.ymin,0],e.spatialReference),i=Xe([e.xmin,e.ymin,0],[e.xmin,e.ymax,0],e.spatialReference);return{width:(t==null?void 0:t.value)??0,height:(i==null?void 0:i.value)??0}}function ys(e){if(!e)return null;let t=null,i=null,s=0;for(const r of e)t||(t=[r[0],r[1],r[2]??0]),i?s+=je(i,r):i=[0,0,0],i[0]=r[0],i[1]=r[1],i[2]=r[2];return t&&i&&(s+=je(i,t)),Math.sqrt(s)}function*fs(e){const t=y();for(let i=0;i<e.length;i+=3)t[0]=e[i],t[1]=e[i+1],t[2]=e[i+2],yield t}a([u()],g.prototype,"_projectedGeometry",null),a([u()],g.prototype,"_localOrigin",null),a([u()],g.prototype,"_getElevationProvider",void 0),a([u()],g.prototype,"_elevationAlignedGeometry",null),a([u()],g.prototype,"_targetGeometry",null),a([u()],g.prototype,"_targetGeometryRenderInfo",null),a([u({constructOnly:!0})],g.prototype,"analysis",void 0),a([u({constructOnly:!0})],g.prototype,"analysisViewData",void 0),a([u({constructOnly:!0})],g.prototype,"view",void 0),a([u()],g.prototype,"updating",null),a([u()],g.prototype,"result",null),a([u()],g.prototype,"error",null),a([u()],g.prototype,"_tooNearFarError",null),a([u()],g.prototype,"_perimeterTooLargeError",null),a([u()],g.prototype,"_perimeterTooLargeLocalError",null),a([u()],g.prototype,"_perimeterTooLargeGlobalError",null),a([u()],g.prototype,"_unsupportedCoordinateSystemError",null),a([u()],g.prototype,"_unsupportedLayerTransparencyError",null),a([u()],g.prototype,"_perimeter",null),a([u()],g.prototype,"_enabled",null),a([u()],g.prototype,"_renderer",void 0),a([u({readOnly:!0})],g.prototype,"_updatingHandles",void 0),a([u()],g.prototype,"_computation",null),g=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillController")],g);const at=$e(),lt=$e(),vs=y(),X=mt(),ut=oi();let Me=class extends J{constructor(){super(...arguments),this.borderColor=ui()}};function Et(){const e=new ee;return e.include(Pe),e.outputs.add("fragColor","vec4",0),e.fragment.uniforms.add(new I("colorTexture",t=>t.color),new I("cutFillVolumes",t=>t.cutFillVolumes),new I("cutFillMask",t=>t.cutFillMask),new ci("pixelRatio",(t,i)=>i.camera.pixelRatio),new hi("borderColor",t=>t.borderColor)).main.add(A`vec4 color = texture(colorTexture, uv, 0.0);
vec4 volumesColor = texture(cutFillVolumes, uv, 0.0);
ivec2 iuv = ivec2(uv * vec2(textureSize(cutFillMask, 0)));
vec2 m0 = texelFetch(cutFillMask, iuv, 0).rg;
vec2 m1 = texelFetch(cutFillMask, iuv + ivec2(-1, 0), 0).rg;
vec2 m2 = texelFetch(cutFillMask, iuv + ivec2(1, 0), 0).rg;
vec2 m3 = texelFetch(cutFillMask, iuv + ivec2(0, -1), 0).rg;
vec2 m4 = texelFetch(cutFillMask, iuv + ivec2(0, 1), 0).rg;
float d = (
step(1.5, abs(m0.r - m1.r) + abs(m0.g - m1.g))
+ step(1.5, abs(m0.r - m2.r) + abs(m0.g - m2.g))
+ step(1.5, abs(m0.r - m3.r) + abs(m0.g - m3.g))
+ step(1.5, abs(m0.r - m4.r) + abs(m0.g - m4.g))
) * 0.25 * pixelRatio;
vec4 base = mix(color, volumesColor, max(m0.r, m0.g) * volumesColor.a);
fragColor = mix(base, borderColor, d);`),e}const ws=Object.freeze(Object.defineProperty({__proto__:null,CutFillCompositionPassParameters:Me,build:Et},Symbol.toStringTag,{value:"Module"}));let ct=class extends te{constructor(t,i){super(t,i,new ie(ws,()=>se(()=>Promise.resolve().then(()=>Gs),void 0)),Fe)}initializePipeline(){return re({colorWrite:oe})}};class Oe extends J{constructor(){super(...arguments),this.origin=ft}}function kt(){const e=new ee;return e.attributes.add("position","vec3"),e.outputs.add("fragColor","vec4",0),e.vertex.uniforms.add(new di("proj",t=>t.camera.projectionMatrix),new pi("view",(t,i)=>vt(bs,i.camera.viewMatrix,t.origin))).main.add(A`gl_Position = proj * view * vec4(position, 1.0);
gl_Position.z = min(gl_Position.z, gl_Position.w);`),e.fragment.main.add(A`fragColor = vec4(1, 1, 0, 0);`),e}const bs=z(),Cs=Object.freeze(Object.defineProperty({__proto__:null,CutFillMaskDrawParameters:Oe,build:kt},Symbol.toStringTag,{value:"Module"}));class ht extends te{constructor(t,i){super(t,i,new ie(Cs,()=>se(()=>Promise.resolve().then(()=>Ms),void 0)),mi(gi))}initializePipeline(){return re({colorWrite:oe,depthTest:{func:515}})}}let E=class extends wt{constructor(e){super(e),this.consumes={required:[bt.OPAQUE]},this.produces=ge.CUTFILL_COLOR,this._vaoCut=null,this._vaoFill=null,this._countCut=0,this._countFill=0,this._maskParameters=new Oe,this._cutVolumeParameters=new Ee,this._fillVolumeParameters=new Ee,this._compositeParameters=new Me,this._drawParameters=new _i;const t=e.view.state.viewingMode===1;this._cutVolumeTechniqueConfiguration=new ke(t),this._cutVolumeTechniqueConfiguration.customDepthTest=2,this._cutVolumeTechniqueConfiguration.writeDepth=!1,this._cutVolumeTechniqueConfiguration.cullFace=1,this._cutVolumeTechniqueConfiguration.doubleSidedMode=1,this._fillVolumeTechniqueConfiguration=new ke(t),this._fillVolumeTechniqueConfiguration.cullFace=2}initialize(){this.addHandles([w(()=>[this.cutColor,this.fillColor],()=>this._updateColors(),N)])}destroy(){this._vaoCut=B(this._vaoCut),this._vaoFill=B(this._vaoFill)}precompile(){this.techniques.precompile(le,this._cutVolumeTechniqueConfiguration),this.techniques.precompile(le,this._fillVolumeTechniqueConfiguration),this.techniques.precompile(ht),this.techniques.precompile(ct)}render(e){const t=this.techniques.get(le,this._cutVolumeTechniqueConfiguration),i=this.techniques.get(le,this._fillVolumeTechniqueConfiguration),s=this.techniques.get(ht),r=this.techniques.get(ct),l=e.find(({name:_})=>_===this.produces);if(!this._vaoCut||!this._vaoFill)return l;if(!(t&&i&&s.compiled&&r.compiled))return this.requestRender(1),l;const n=this.bindParameters,c=n.camera,h=c.fullViewport[2],d=c.fullViewport[3],o=this.renderingContext,p=this.fboCache,m=p.acquire(h,d,"cutfill color mask",2);m.attachDepth(l.getAttachment(_e)),o.bindFramebuffer(m.fbo),o.setClearColor(0,0,0,1),o.clear(17408),o.setViewport(0,0,h,d),o.bindTechnique(s,n,yi,this._maskParameters),o.setFaceCullingEnabled(!1),o.setStencilTestEnabled(!0),o.setStencilOpSeparate(1028,7680,34055,7680),o.setStencilOpSeparate(1029,7680,34056,7680),o.setDepthWriteEnabled(!1),o.bindVAO(this._vaoCut),o.setDepthTestEnabled(!0),o.setStencilWriteMask(255),o.setStencilFunction(519,0,255),o.setColorMask(!1,!1,!1,!1),o.drawArrays(H.TRIANGLES,0,this._countCut),o.setDepthTestEnabled(!1),o.setStencilWriteMask(0),o.setStencilFunction(517,0,255),o.setColorMask(!0,!1,!1,!1),o.drawArrays(H.TRIANGLES,0,this._countCut),o.bindVAO(this._vaoFill),o.setDepthTestEnabled(!0),o.setStencilWriteMask(255),o.setStencilFunction(519,0,255),o.setColorMask(!1,!0,!1,!1),o.drawArrays(H.TRIANGLES,0,this._countFill);const f=p.acquire(h,d,"cutfill color volumes",5);f.attachDepth(l.getAttachment(_e)),o.bindFramebuffer(f.fbo),o.setClearColor(0,0,0,0),o.clear(16384),o.setColorMask(!0,!0,!0,!0),o.bindTechnique(t,this.bindParameters,this._cutVolumeParameters,this._drawParameters),o.setPolygonOffset(1,1),o.setPolygonOffsetFillEnabled(!0),o.bindVAO(this._vaoCut),o.drawArrays(H.TRIANGLES,0,this._countCut),o.bindTechnique(i,this.bindParameters,this._fillVolumeParameters,this._drawParameters),o.setPolygonOffset(0,0),o.setPolygonOffsetFillEnabled(!1),o.bindVAO(this._vaoFill),o.drawArrays(H.TRIANGLES,0,this._countFill);const v=this.fboCache.acquire(h,d,this.produces);return o.bindFramebuffer(v.fbo),this._compositeParameters.color=l.getTexture(),this._compositeParameters.cutFillVolumes=f.getTexture(),this._compositeParameters.cutFillMask=m.getTexture(),b.toUnitRGBA(this.borderColor,this._compositeParameters.borderColor),o.bindTechnique(r,n,this._compositeParameters),o.screen.draw(),m.release(),f.release(),v.attachDepth(l.getAttachment(_e)),v}enable(){this.produces=ge.CUTFILL_COLOR,this.requestRender(1)}disable(){this.produces="disabled",this.requestRender(1)}updateGeometries(e,t,i){this._vaoCut=B(this._vaoCut),this._vaoCut=this._createVao(e),this._countCut=e.indicesBottom.length+e.indicesExtruded.length,this._vaoFill=B(this._vaoFill),this._vaoFill=this._createVao(t),this._countFill=t.indicesBottom.length+t.indicesExtruded.length,this._maskParameters.origin=i,fi(this._drawParameters.origin,i),this.requestRender(1)}_updateColors(){this._cutVolumeParameters.diffuse=b.toUnitRGB(this.cutColor),this._cutVolumeParameters.opacity=this.cutColor.a,this._fillVolumeParameters.diffuse=b.toUnitRGB(this.fillColor),this._fillVolumeParameters.opacity=this.fillColor.a,this.requestRender(1)}_createVao(e){const t=this.renderingContext,{vertices:i,normals:s,indicesBottom:r,indicesExtruded:l}=e,n=dt.createBuffer(r.length+l.length),{position:c,normal:h}=n;for(let o=0;o<r.length;o++){const p=3*r[o];c.set(o,0,i[p]),c.set(o,1,i[p+1]),c.set(o,2,i[p+2]),h.set(o,0,s[p]),h.set(o,1,s[p+1]),h.set(o,2,s[p+2])}for(let o=0;o<l.length;o++){const p=o+r.length,m=3*l[o];c.set(p,0,i[m]),c.set(p,1,i[m+1]),c.set(p,2,i[m+2]),h.set(p,0,s[m]),h.set(p,1,s[m+1]),h.set(p,2,s[m+2])}const d=new xt(t,Vt(dt),n.buffer);return new Pt(t,d)}};a([u()],E.prototype,"consumes",void 0),a([u()],E.prototype,"produces",void 0),a([u()],E.prototype,"cutColor",void 0),a([u()],E.prototype,"fillColor",void 0),a([u()],E.prototype,"borderColor",void 0),E=a([O("esri.views.3d.webgl-engine.lib.CutFillColor")],E);const dt=Ct().vec3f("position").vec3f("normal").freeze();class xs{constructor(t,i,s,r){this.vertices=t,this.indicesBottom=i,this.indicesExtruded=s,this.normals=r}}let F=class extends Y{get visible(){return this.analysisViewData.visible&&this.analysisViewData.elevationAlignedGeometry!=null&&this.analysisViewData.targetGeometry!=null}get updating(){return this.loadingMessages}get hasUnsupportedError(){const{error:e}=this.analysisViewData;return!!e&&["unsupported-coordinate-system","unsupported-layer-transparency"].includes(e.name)}constructor(e){super(e),this.unitsMessages=null,this.messages=null,this.loadingMessages=!0,this._elevationContext=ve.fromElevationInfo(new we({mode:"absolute-height"})),this._extrusionHeight=M.targetElevationRange,this._projectionLines=[]}initialize(){const{view:e}=this,t={view:e,isDecoration:!0},i=M,s={...t,width:i.geometryOutlineWidth};this._elevationAlignedGeometry=new Qe({...s,isDraped:!0,color:b.toUnitRGBA(i.geometryOutlineColor)}),this._targetGeometry=new Qe(s);const r={...t,attached:!0,width:i.projectionLineWidth,renderOccluded:4,polygonOffset:!0},l={...r,stipplePattern:Ai(i.projectionLineStippleSize)},n=b.toUnitRGBA(i.cutProjectionLineColor),c=b.toUnitRGBA(i.fillProjectionLineColor);this._cutProjectionLines=new ce({...r,color:n}),this._occludedCutProjectionLines=new ce({...l,color:n}),this._fillProjectionLines=new ce({...r,color:c}),this._occludedFillProjectionLines=new ce({...l,color:c});const h={...t,attached:!0};this._cutVolumeLabel=new Ke(h),this._fillVolumeLabel=new Ke(h),this._cutFillRenderNode=new E({view:e,cutColor:i.cutColor,fillColor:i.fillColor,borderColor:i.geometryOutlineColor}),this.addHandles([w(()=>({elevationAlignedGeometry:this.analysisViewData.elevationAlignedGeometry,targetGeometry:this.analysisViewData.targetGeometry}),({elevationAlignedGeometry:d,targetGeometry:o})=>{this._elevationAlignedGeometry.geometry=d,this._targetGeometry.geometry=o},S),w(()=>({interactive:this.analysisViewData.interactive,measureType:this.analysis.measureType,visible:this.visible}),({visible:d,interactive:o,measureType:p})=>{this._elevationAlignedGeometry.visible=d&&!o,this._targetGeometry.visible=d&&p==="cut-fill"},S),w(()=>({elevationAlignedGeometry:this.analysisViewData.elevationAlignedGeometry,targetGeometry:this.analysisViewData.targetGeometry,visible:this.visible}),({elevationAlignedGeometry:d,targetGeometry:o,visible:p})=>this._updateProjectionLines(d,o,p),S),w(()=>({interactive:this.analysisViewData.interactive,accentColor:this.view.effectiveTheme.accentColor,hasResult:!!this.analysisViewData.result}),({interactive:d,accentColor:o,hasResult:p})=>{this._updateColors(d,o,p)},S),w(()=>this.analysisViewData.targetGeometry,()=>this._updateCutFillGeometry(),S),w(()=>this.visible&&!this.hasUnsupportedError,d=>this._updateCutFillVisibility(d),S),w(()=>{const{messages:d,unitsMessages:o,visible:p,analysisViewData:m}=this;return{labelAnchors:m.labelAnchors,effectiveDisplayUnits:m.effectiveDisplayUnits,messages:d,unitsMessages:o,result:m.result,visible:p&&!!m.result}},d=>this._updateLabels(d)),w(()=>this.view.state.camera,d=>this._updateProjectionLineOcclusion(d),S),vi(()=>this._updateMessageBundle())]),this._updateMessageBundle()}destroy(){this._elevationAlignedGeometry=$(this._elevationAlignedGeometry),this._targetGeometry=$(this._targetGeometry),this._cutProjectionLines=$(this._cutProjectionLines),this._occludedCutProjectionLines=$(this._occludedCutProjectionLines),this._fillProjectionLines=$(this._fillProjectionLines),this._occludedFillProjectionLines=$(this._occludedFillProjectionLines),this._cutVolumeLabel=$(this._cutVolumeLabel),this._fillVolumeLabel=$(this._fillVolumeLabel),this._cutFillRenderNode.destroy()}_updateProjectionLines(e,t,i){if(this._cutProjectionLines.visible=i,this._occludedCutProjectionLines.visible=i,this._fillProjectionLines.visible=i,this._occludedFillProjectionLines.visible=i,!e||!t)return;const{renderCoordsHelper:s}=this.view,r=[],l=e.spatialReference,n=e.rings[0],c=n.length>1&&wi(n[0],n[n.length-1]),h=n.length-(c?1:0);for(let _=0;_<h;++_){const C=n[_],V=me(y(),C[0],C[1],C[2]);s.toRenderCoords(V,l,V);const L=t.rings[0][_],T=me(y(),L[0],L[1],L[2]);s.toRenderCoords(T,l,T);const q=new ki(V,T);r.push(q)}e.isClockwise(n)||r.reverse();const d=[],o=[],p=[],m=[],f=[],v=this.view.state.camera;for(let _=0;_<r.length;++_){const C=r[_],V=r[_===0?r.length-1:_-1],L=r[_===r.length-1?0:_+1],T=e.rings[0][_],q=t.rings[0][_],U=T[2]>q[2],D=new Vs(C,V,L,U);d.push(D),D.updateOccluded(v);const Le=D.isOccluded;U?(Le?p:o).push(C):(Le?f:m).push(C)}this._projectionLines=d,this._cutProjectionLines.setGeometryFromSegments(o),this._occludedCutProjectionLines.setGeometryFromSegments(p),this._fillProjectionLines.setGeometryFromSegments(m),this._occludedFillProjectionLines.setGeometryFromSegments(f)}_updateProjectionLineOcclusion(e){const t=[],i=[],s=[],r=[];let l=!1,n=!1;for(const c of this._projectionLines){c.updateOccluded(e)&&(l||(l=c.isCut),n||(n=!c.isCut));const h=c.isOccluded;(c.isCut?h?i:t:h?r:s).push(c.segment)}n&&(this._fillProjectionLines.setGeometryFromSegments(s),this._occludedFillProjectionLines.setGeometryFromSegments(r)),l&&(this._cutProjectionLines.setGeometryFromSegments(t),this._occludedCutProjectionLines.setGeometryFromSegments(i))}_updateColors(e,t,i){const{geometryOutlineColor:s,cutColor:r,fillColor:l,cutColorMuted:n,fillColorMuted:c,cutProjectionLineColor:h,fillProjectionLineColor:d}=M;if(this._cutFillRenderNode.cutColor=i?r:n,this._cutFillRenderNode.fillColor=i?l:c,e){const o=b.toUnitRGBA(t);this._targetGeometry.color=o,this._cutProjectionLines.color=o,this._occludedCutProjectionLines.color=o,this._fillProjectionLines.color=o,this._occludedFillProjectionLines.color=o,this._cutFillRenderNode.borderColor=t}else{this._targetGeometry.color=b.toUnitRGBA(s);const o=b.toUnitRGBA(i?h:n);this._cutProjectionLines.color=o,this._occludedCutProjectionLines.color=o;const p=b.toUnitRGBA(i?d:c);this._fillProjectionLines.color=p,this._occludedFillProjectionLines.color=p,this._cutFillRenderNode.borderColor=s}}_updateLabels(e){const{labelDistance:t}=M,{effectiveDisplayUnits:i,labelAnchors:s,messages:r,unitsMessages:l,result:n,visible:c}=e;if(this._cutVolumeLabel.visible=c,this._fillVolumeLabel.visible=c,this._cutVolumeLabel.geometry=s.cut?{type:"point",point:s.cut,callout:{distance:t,offset:0}}:null,this._fillVolumeLabel.geometry=s.fill?{type:"point",point:s.fill,callout:{distance:-t,offset:0}}:null,n==null||r==null||l==null)return this._cutVolumeLabel.text="-",void(this._fillVolumeLabel.text="-");const h=i.volume,d=Ye(r.labels.cut,{volume:pt(l,n.cutVolume,h)}),o=Ye(r.labels.fill,{volume:pt(l,n.fillVolume,h)});this._cutVolumeLabel.text=d,this._fillVolumeLabel.text=o}_updateCutFillVisibility(e){e?this._cutFillRenderNode.enable():this._cutFillRenderNode.disable()}_updateCutFillGeometry(){const{renderCoordsHelper:e}=this.view,{targetGeometry:t}=this.analysisViewData;if(!(t!=null&&t.extent))return;const{center:i}=t.extent,s=Tt(i.x,i.y,0),r=y();e.toRenderCoords(s,t.spatialReference,r);const l=this._getExtrudedVolumes(t,this._extrusionHeight,s),n=this._getExtrudedVolumes(t,-this._extrusionHeight,s);this._cutFillRenderNode.updateGeometries(l,n,r)}_getExtrudedVolumes(e,t,i){const{renderCoordsHelper:s,spatialReference:r,elevationProvider:l}=this.view,n=y(),c=s.viewingMode===1;c||s.worldUpAtPosition([0,0,0],n);const h=Ve(e,l,s,this._elevationContext),{polygons:d,mapPositions:o,position:p}=h,m=d[0],f=m.count,v=Mt(m.mapPositions,m.holeIndices,3),_=v.length,C=6*f,V=Ae(C+_),L=Ae(_),T=be(3*C),q=be(3*C);ji(p,o,v,m,T,null,q,null,V,L,t,n,c);const U=z(),D=z();return Rt(r,i,U,s.spatialReference),D[12]=-U[12],D[13]=-U[13],D[14]=-U[14],Gt(T,T,D),new xs(T,L,V,q)}async _updateMessageBundle(){this.loadingMessages=!0;try{this.unitsMessages=await ze("esri/core/t9n/Units"),this.messages=await ze("esri/views/3d/analysis/VolumeMeasurement/t9n/VolumeMeasurementAnalysis")}finally{this.loadingMessages=!1}}};function pt(e,t,i){if(!t||!e)return null;const s=yt(t.value,t.unit,i),r=M.labelPrecisions[s];return Ei(e,t,s,r)}a([u({constructOnly:!0})],F.prototype,"view",void 0),a([u({constructOnly:!0})],F.prototype,"analysis",void 0),a([u({constructOnly:!0})],F.prototype,"analysisViewData",void 0),a([u()],F.prototype,"unitsMessages",void 0),a([u()],F.prototype,"messages",void 0),a([u()],F.prototype,"loadingMessages",void 0),a([u({readOnly:!0})],F.prototype,"visible",null),a([u()],F.prototype,"updating",null),a([u()],F.prototype,"hasUnsupportedError",null),F=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillVisualization")],F);class Vs{constructor(t,i,s,r){this.segment=t,this.previous=i,this.next=s,this.isCut=r,this._isOccluded=!1,this._n1=y(),this._n2=y();const l=W(Z,K(Z,t.endRenderSpace,t.startRenderSpace));W(this._n1,Ue(this._n1,l,W(pe,K(pe,i.startRenderSpace,t.startRenderSpace)))),W(this._n2,Ue(this._n2,l,W(pe,K(pe,t.startRenderSpace,s.startRenderSpace)))),this._isConvex=bi.normalize(Ci(this._n1,this._n2,l))<0}get isOccluded(){return this._isOccluded}updateOccluded(t){K(Z,this.segment.startRenderSpace,t.eye);const i=qe(this._n1,Z)<0,s=qe(this._n2,Z)<0,r=this._isOccluded;return this._isOccluded=this._isConvex?i&&s:i||s,this._isOccluded!==r}}const Z=y(),pe=y();function Ps(e){return At(e==null?void 0:e.geometry)}function At(e){return e!=null&&e.type==="polygon"}let Q=class extends Zi(Ni){constructor(e){super(e),this.type="elevation",this.allFields.forEach(t=>{t.lockable=!1,t.setActual(null)})}get allFields(){return[this.elevation]}};a([u()],Q.prototype,"type",void 0),a([u()],Q.prototype,"allFields",null),Q=a([O("esri.views.interactive.tooltip.infos.ElevationTooltipInfo")],Q);let k=class extends Hi{constructor(e){super(e),this.sketchOptions=new Ot}initialize(){const{view:e}=this;this._shiftManipulator=new zi(e,0),this._shiftManipulator.state|=Ui,this.manipulators.add(this._shiftManipulator),this.addHandles([this._createDragPipeline(),w(()=>this.analysisViewData.targetGeometry,()=>this._updateManipulatorPosition(),$t),w(()=>[this.analysisViewData.interactive,this.analysisViewData.targetGeometry,this.analysis.measureType],()=>this._updateManipulatorVisibility(),N)]),this._initializeTooltip(),this.finishToolCreation()}_initializeTooltip(){const{view:e}=this;this.tooltip=Wi(()=>({view:e,options:this.sketchOptions.tooltips})),this._tooltipInfo=new Q({sketchOptions:this.sketchOptions}),this.sketchOptions.tooltips.placement="trailing",this._updateSketchOptions(),this.addHandles([w(()=>this.analysisViewData.effectiveTargetElevation,()=>this._updateTooltip()),w(()=>this._shouldShowTooltip,t=>{t?this._showTooltip():this._hideTooltip()}),this.tooltip.on("commit",()=>{const t=this._tooltipInfo.elevation.actual,i=Ce(this.view.spatialReference);if(t==null||i==null)return;const s=xi(t,i);this._updateValue(s,{recordUndo:this.analysis.cutFillOptions.targetElevation})}),w(()=>[this.analysis.displayUnits.elevation,this.analysis.inputUnits.elevation],()=>this._updateSketchOptions(),N)])}destroy(){this._shiftManipulator.destroy(),this.tooltip.destroy()}onInputEvent(e){if(!this.destroyed&&!Xi(e,this.tooltip))return super.onInputEvent(e)}get _shouldShowTooltip(){return this.hasFocusedManipulators||this.tooltip.mode==="input"}_createDragPipeline(){return Bi(this._shiftManipulator,(e,t,i)=>{const s=Be(e.renderLocation),r=this.analysis.inputUnits.elevation??"meters",l=Ce(this.view.spatialReference);let n;t.next(qi(this.view,s,this.view.spatialReference)).next(Ii()).next(c=>{if(c.action==="start"){const{targetElevation:h}=this.analysis.cutFillOptions;n=h&&l?xe(h,r,l):void 0}return this._updateValue(n!=null?n+c.translationZ:c.mapEnd.z,c.action==="end"?{recordUndo:n}:void 0),c}),i.next(()=>{this._updateValue(n)})})}_updateManipulatorPosition(){const{targetGeometry:e}=this.analysisViewData,{renderCoordsHelper:t}=this.view;if(!e)return;const i=.5,s=e.rings[0],r=He(s[0]),l=He(s[1]);t.toRenderCoords(r,e.spatialReference,r),t.toRenderCoords(l,e.spatialReference,l);const n=ue.get();K(n,l,r);const c=ue.get();Vi(c,r,l,i);const h=t.worldBasisAtPosition(c,1,ue.get()),d=t.worldBasisAtPosition(c,0,ue.get()),o=Si(h,d,c,Pi.get()),p=t.headingAtPosition(c,n),m=e.isClockwise(e.rings[0])?-Math.PI/2:Math.PI/2;Fi(o,o,$i(p)+m),o[12]=0,o[13]=0,o[14]=0,this._shiftManipulator.renderLocation=Be(c),this._shiftManipulator.modelTransform=o}_updateManipulatorVisibility(){const{interactive:e,targetGeometry:t}=this.analysisViewData,{measureType:i}=this.analysis,s=e&&t!=null&&i==="cut-fill";this._shiftManipulator.available=s}_updateValue(e,t){const i=Ze(e,this.view.spatialReference);if(i==null)return;const s=this.analysis.inputUnits.elevation??"meters",r=xe(i.value,i.unit,s),l=n=>{this.analysis.cutFillOptions.targetElevation=n};if(l(r),t&&"recordUndo"in t){const n=t.recordUndo;this.emit("record-undo",{apply:()=>l(r),undo:()=>l(n)})}}_getUpdatedTooltipInfo(){const{effectiveTargetElevation:e}=this.analysisViewData;return e?(this._tooltipInfo.elevation.actual=Ze(e,this.view.spatialReference),this._tooltipInfo):this._tooltipInfo}_updateTooltip(){this._shouldShowTooltip&&(this.tooltip.info=this._getUpdatedTooltipInfo())}_showTooltip(){this._updateTooltip()}_hideTooltip(){var e;(e=this.tooltip)==null||e.clear()}_updateSketchOptions(){const{analysis:e}=this,{displayUnits:t,inputUnits:i}=e;this.sketchOptions.values.inputUnits=new Je({verticalLength:i.elevation}),this.sketchOptions.values.displayUnits=new Je({verticalLength:t.elevation})}};a([u({constructOnly:!0})],k.prototype,"analysis",void 0),a([u({constructOnly:!0})],k.prototype,"view",void 0),a([u({constructOnly:!0})],k.prototype,"analysisViewData",void 0),a([u({constructOnly:!0,type:Ot})],k.prototype,"sketchOptions",void 0),a([u()],k.prototype,"_shouldShowTooltip",null),k=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementShiftTool")],k);let G=class extends Y{constructor(e){super(e),this._updatingHandles=new Ft,this._operationManager=new Ki,this._onUndoRedo=()=>{this._updateGeometryFromSketchGraphic()}}initialize(){const{analysis:e,analysisViewData:t,view:i}=this;this._graphicsLayer=new Ti({listMode:"hide",internal:!0,elevationInfo:{mode:"on-the-ground"}});const s=Yi(i,{selfEnabled:!0,excludeInternal:!0});this._sketchViewModel=new Qi({layer:this._graphicsLayer,view:i,updateOnGraphicClick:!1,defaultUpdateOptions:{reshapeOptions:{shapeOperation:"none"},enableRotation:!1,enableScaling:!1,enableMoveAllGraphics:!1,enableZ:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1,tool:"reshape"},polygonSymbol:this._polygonSymbol,snappingOptions:s.options}),this.addHandles([this._sketchViewModel.on(["undo","redo"],this._onUndoRedo),w(()=>({map:i.map,internalGraphicsLayer:this._graphicsLayer,state:this.state}),({map:r,internalGraphicsLayer:l,state:n})=>{switch(Fs(r,l),n){case"idle":case"reshaping-disabled":this._operationManager.stop(),this._graphicsLayer.removeAll(),this._ensureUpdatedSketchGraphic();break;case"reshaping":Ie(this._startReshape());break;case"awaiting-sketch":this.analysisViewData.interactive=!0}},N),s]),this._shiftTool=new k({analysis:e,view:i,analysisViewData:t}),this.addHandles(this._shiftTool.on("record-undo",r=>{const l=this._sketchViewModel.activeComponent;(l==null?void 0:l.type)==="reshape-3d"&&l.recordUndo(r.apply,r.undo)})),i.tools.add(this._shiftTool),this.addHandles({remove:()=>i.tools.remove(this._shiftTool)})}destroy(){this._operationManager.destroy(),this._sketchViewModel.destroy();const e=this._graphicsLayer;this.view.map.remove(e),e.destroy()}get sketchGraphic(){return this._get("sketchGraphic")}set sketchGraphic(e){e!==this._get("sketchGraphic")&&(this._set("sketchGraphic",e),this._updateGeometryFromSketchGraphic())}get state(){const{geometry:e}=this.analysis,{interactive:t,visible:i}=this.analysisViewData;return i?this._sketchViewModel.createGraphic?this._sketchViewModel.createGraphic===this.sketchGraphic?"sketching":"awaiting-sketch":e?t?"reshaping":"reshaping-disabled":"idle":"idle"}get updating(){return this._sketchViewModel.updating||this._updatingHandles.updating}get _polygonSymbol(){return new Ri({color:[0,0,0,0],outline:{color:[0,0,0,0]}})}place(e){return this._operationManager.start("place",async t=>{const i=this.analysis.clone();this._ensureUpdatedSketchGraphic();const s=this._sketchViewModel.on("create",r=>{switch(r.state){case"start":this._graphicsLayer.removeAll(),this.sketchGraphic=r.graphic;break;case"active":this._updateGeometryFromSketchGraphic();break;case"complete":this._updateGeometryFromSketchGraphic(),t.stop();break;case"cancel":t.stop()}});t.handles.push(s,Ne(()=>(s.remove(),this._sketchViewModel.cancel(),this._updateGeometryFromSketchGraphic(),this.analysis.valid?Gi(e)||i.equals(this.analysis)?t.reject():void t.resolve({}):(this._clearGeometry(),t.reject())))),await this._updatingHandles.addPromise(this._sketchViewModel.create("polygon"))},e)}_startReshape(){return this._operationManager.start("reshape",async e=>{const t=()=>{const s=this._ensureUpdatedSketchGraphic();return s?(this._graphicsLayer.removeAll(),this._graphicsLayer.add(s),this._updatingHandles.addPromise(this._sketchViewModel.update(s,{tool:"reshape"}))):Promise.resolve()};if(!this._ensureUpdatedSketchGraphic())return;const i=this._sketchViewModel.on("update",s=>{this._updateGeometryFromSketchGraphic(),s.state==="complete"&&(this.state==="reshaping"?Ie(t()):e.resolve())});e.handles.push(i,Ne(()=>{i.remove(),this._sketchViewModel.cancel(),e.resolve()})),await t()})}_ensureUpdatedSketchGraphic(){const{geometry:e}=this.analysis;return At(e)?(this.sketchGraphic??(this.sketchGraphic=new Mi({geometry:e,symbol:this._polygonSymbol})),this.sketchGraphic.geometry=e,this.sketchGraphic):(this.sketchGraphic=null,null)}_clearGeometry(){this.sketchGraphic=null,this.analysis.geometry=null}_updateGeometryFromSketchGraphic(){const e=this.sketchGraphic;this.analysis.geometry=Ps(e)?e.geometry:null}get test(){}};function Fs(e,t){t&&(t.removeFromParent(),e==null||e.add(t))}a([u({constructOnly:!0})],G.prototype,"analysisViewData",void 0),a([u({constructOnly:!0})],G.prototype,"view",void 0),a([u({constructOnly:!0})],G.prototype,"analysis",void 0),a([u()],G.prototype,"sketchGraphic",null),a([u({nonNullable:!0})],G.prototype,"state",null),a([u()],G.prototype,"updating",null),a([u()],G.prototype,"_polygonSymbol",null),G=a([O("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementTool")],G);let P=class extends Li{constructor(e){super(e),this.type="volume-measurement-view-3d",this.analysis=null,this.elevationAlignedGeometry=null,this.targetGeometry=null}initialize(){const{analysis:e,view:t}=this;this._analysisController=new g({view:t,analysis:e,analysisViewData:this}),this._analysisTool=new G({analysis:e,view:t,analysisViewData:this}),this._analysisVisualization=new F({view:t,analysis:e,analysisViewData:this})}destroy(){this._analysisController=$(this._analysisController),this._analysisVisualization=$(this._analysisVisualization),this._analysisTool.destroy()}get error(){var e;return((e=this._analysisController)==null?void 0:e.error)??null}get result(){var e;return(e=this._analysisController)==null?void 0:e.result}get interactive(){return super.interactive}set interactive(e){super.interactive=e}get visible(){return super.visible}set visible(e){super.visible=e}get effectiveTargetElevation(){var n;const{cutFillOptions:e,inputUnits:t}=this.analysis,{targetElevation:i}=e,s=(t==null?void 0:t.elevation)??"meters",r=Ce(this.view.spatialReference);if(i!=null&&r!=null)return xe(i,s,r);const l=(n=this.elevationAlignedGeometry)==null?void 0:n.extent;return(l==null?void 0:l.zmin)==null||(l==null?void 0:l.zmax)==null?null:(l.zmax+l.zmin)/2}get effectiveDisplayUnits(){const{displayUnits:e}=this.analysis,t=Oi(this.view);return{elevation:e.elevation??t,volume:e.volume??t}}get labelAnchors(){const{elevationAlignedGeometry:e,view:t}=this,{renderCoordsHelper:i}=t;if(!e)return{cut:null,fill:null};let s=e.rings[0][0],r=e.rings[0][0];e.rings[0].forEach(o=>{o[2]>s[2]&&(s=o),o[2]<r[2]&&(r=o)});const{spatialReference:l}=e,n=new We({x:s[0],y:s[1],z:s[2],spatialReference:l}),c=new We({x:r[0],y:r[1],z:r[2],spatialReference:l}),h=y(),d=y();return i.toRenderCoords(n,h),i.toRenderCoords(c,d),{cut:h,fill:d}}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisTool.updating||this._analysisVisualization.updating}place(e){return this._analysisTool.place(e)}get test(){}};a([u()],P.prototype,"error",null),a([u({readOnly:!0})],P.prototype,"type",void 0),a([u({constructOnly:!0,nonNullable:!0})],P.prototype,"analysis",void 0),a([u({readOnly:!0})],P.prototype,"result",null),a([u()],P.prototype,"elevationAlignedGeometry",void 0),a([u({type:Number})],P.prototype,"effectiveTargetElevation",null),a([u()],P.prototype,"targetGeometry",void 0),a([u()],P.prototype,"effectiveDisplayUnits",null),a([u()],P.prototype,"labelAnchors",null),a([u()],P.prototype,"updating",null),P=a([O("esri.views.3d.analysis.VolumeMeasurementAnalysisView3D")],P);const Ur=P,$s=Object.freeze(Object.defineProperty({__proto__:null,CutFillDepthParameters:Te,build:Dt},Symbol.toStringTag,{value:"Module"})),Ts=Object.freeze(Object.defineProperty({__proto__:null,CutFillReductionParameters:Re,build:St},Symbol.toStringTag,{value:"Module"})),Rs=Object.freeze(Object.defineProperty({__proto__:null,CutFillTargetDepthParameters:Ge,build:jt},Symbol.toStringTag,{value:"Module"})),Gs=Object.freeze(Object.defineProperty({__proto__:null,CutFillCompositionPassParameters:Me,build:Et},Symbol.toStringTag,{value:"Module"})),Ms=Object.freeze(Object.defineProperty({__proto__:null,CutFillMaskDrawParameters:Oe,build:kt},Symbol.toStringTag,{value:"Module"}));export{Ur as default};
