import{hZ as S,g6 as g,bJ as E,av as b,ce as j,bK as I}from"./index-BiSWWdHA.js";import{t as R}from"./pbfQueryUtils-CQDoR75n.js";import{t as q}from"./queryZScale-CHct0r8A.js";function x(n){const t={};for(const i in n){if(i==="declaredClass")continue;const a=n[i];if(a!=null&&typeof a!="function")if(Array.isArray(a)){t[i]=[];for(let u=0;u<a.length;u++)t[i][u]=x(a[u])}else typeof a=="object"?a.toJSON&&(t[i]=JSON.stringify(a)):t[i]=a}return t}function F(n,t){if(t&&n.type==="extent")return`${n.xmin},${n.ymin},${n.xmax},${n.ymax}`;if(t&&n.type==="point")return`${n.x},${n.y}`;const i=n.toJSON();return delete i.spatialReference,JSON.stringify(i)}function J(n,t,i){var d,p;const{geometry:a}=n,u=n.compactGeometryEnabled??!1,e=n.toJSON();delete e.compactGeometryEnabled,delete e.defaultSpatialReferenceEnabled;const r=e;let s,o,l;if(a&&(o=a.spatialReference,l=S(o),r.geometryType=g(a),r.geometry=F(a,u),r.inSR=l),e.groupByFieldsForStatistics&&(r.groupByFieldsForStatistics=e.groupByFieldsForStatistics.join(",")),e.objectIds)switch((d=i==null?void 0:i.uniqueIdFields)==null?void 0:d.length){case void 0:r.objectIds=e.objectIds.join(",");break;case 1:r.uniqueIds=JSON.stringify(e.objectIds),delete r.objectIds;break;default:r.uniqueIds=JSON.stringify(e.objectIds.map(f=>JSON.parse(f))),delete r.objectIds}if(e.orderByFields&&(r.orderByFields=e.orderByFields.join(",")),!e.outFields||!e.returnDistinctValues&&(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly)?delete r.outFields:e.outFields.includes("*")?r.outFields="*":r.outFields=e.outFields.join(","),e.outSR?(r.outSR=S(e.outSR),s=n.outSpatialReference):a&&(e.returnGeometry||e.returnCentroid)&&(r.outSR=r.inSR,s=o),e.returnGeometry&&delete e.returnGeometry,e.outStatistics&&(r.outStatistics=JSON.stringify(e.outStatistics)),e.fullText&&(r.fullText=JSON.stringify(e.fullText)),e.pixelSize&&(r.pixelSize=JSON.stringify(e.pixelSize)),e.quantizationParameters&&(n.defaultSpatialReferenceEnabled&&o!=null&&((p=n.quantizationParameters)==null?void 0:p.extent)!=null&&o.equals(n.quantizationParameters.extent.spatialReference)&&delete e.quantizationParameters.extent.spatialReference,r.quantizationParameters=JSON.stringify(e.quantizationParameters)),e.parameterValues&&(r.parameterValues=JSON.stringify(e.parameterValues)),e.rangeValues&&(r.rangeValues=JSON.stringify(e.rangeValues)),e.dynamicDataSource&&(r.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e.timeExtent){const f=e.timeExtent,{start:y,end:m}=f;y==null&&m==null||(r.time=y===m?y:`${y??"null"},${m??"null"}`),delete e.timeExtent}return n.defaultSpatialReferenceEnabled&&o!=null&&s!=null&&o.equals(s)&&(r.defaultSR=r.inSR,delete r.inSR,delete r.outSR),r}const O="Layer does not support extent calculation.";function N(n,t,i){return J(n,t,i)}async function v(n,t,i,a,u){var r;const e=(r=t.timeExtent)!=null&&r.isEmpty?{data:{features:[]}}:await c(n,t,"json",a,void 0,u);return q(t,i,e.data),e}async function B(n,t,i,a,u){var s;if((s=t.timeExtent)!=null&&s.isEmpty)return{data:i.createFeatureResult()};const e=await $(n,t,a,u),r=e;return r.data=R(e.data,i),r}function $(n,t,i,a){return c(n,t,"pbf",i,void 0,a)}function C(n,t,i,a){var u;return(u=t.timeExtent)!=null&&u.isEmpty?Promise.resolve({data:{objectIds:[]}}):c(n,t,"json",i,{returnIdsOnly:!0},a)}function D(n,t,i,a){var u;return(u=t.timeExtent)!=null&&u.isEmpty?Promise.resolve({data:{count:0}}):c(n,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0},a)}async function G(n,t,i){var e;if((e=t.timeExtent)!=null&&e.isEmpty)return{data:{count:0,extent:null}};const a=await c(n,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}),u=a.data;if(u.hasOwnProperty("extent"))return a;if(u.features)throw new Error(O);if(u.hasOwnProperty("count"))throw new Error(O);return a}function w(n,t){if(!n.returnIdsOnly||!t.uniqueIdFields)return n;const i={...n,returnUniqueIdsOnly:!0};return delete i.returnIdsOnly,i}async function c(n,t,i,a={},u={},e={}){const r=typeof n=="string"?E(n):n,s=t.geometry?[t.geometry]:[],o=await b(s,null,{signal:a.signal}),l=o==null?void 0:o[0];l!=null&&((t=t.clone()).geometry=l);const d=x({...r.query,f:i,...w(u,e),...N(t,u,e)});return j(I(r.path,P(t,u)?"query3d":"query"),{...a,responseType:i==="pbf"?"array-buffer":"json",query:{...d,...a.query}})}function P(n,t){return n.formatOf3DObjects!=null&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}export{$ as c,G as d,B as f,c as j,C as m,D as p,J as r,x as t,v as y};
