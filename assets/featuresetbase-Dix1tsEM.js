import{aJ as q,_ as h,m as v,b as ae,bw as Ne,bx as Te,a2 as $e,aH as we,br as Me,gW as Re,gV as Oe,ce as Ve,rA as Ge,ax as ze,gX as He,fM as y,i4 as Z,bg as We,i6 as U,rB as _e,dH as Ee,fu as Be,mk as Je,bd as M,rr as Ke,w as Qe}from"./index-CeBxY8tu.js";import{t as qe,l as le}from"./arcade-FAV8q-G-.js";import{o as k,w as Ye,m as ue,B as C,p as R,g as S,Z as Xe,c as De,l as ve,X as ke,z as P,T as Y,H as te,t as J,L as et,S as X,Y as tt,a0 as ne}from"./Dictionary-CD9j9drc.js";import{I as nt}from"./Feature-BmNjXMzS.js";import{v as it,R as Se,y as rt,h as de,e as ot,i as at,s as st,F as re,E as lt,k as ut,O as dt,a as B,I as ct,D as ie,b as $,x as ce}from"./featureSetUtils-Bs8Y_Z3w.js";import{t as ft}from"./ImmutableArray-BPVd6ESQ.js";import{l as mt}from"./portalUtils-CCrCrHz2.js";import{s as pt,v as xe}from"./SpatialFilter-DAdvP4OT.js";import{N as Ae,o as fe}from"./shared-C0KM7YDX.js";import{L as T}from"./WhereClause-BmRnThNm.js";import Le from"./FeatureLayer-CWsU0ttf.js";import{s as Q}from"./NetworkElement-DUp8Fe6Y.js";import"./arcadeEnvironment-CWmsLCWz.js";import"./aiServices-DNR7nqvH.js";import"./commonProperties-DHiB1uzW.js";import"./streamLayerUtils-DFlbJ4P1.js";import"./unitConversion-B-YJ2vcK.js";import"./number-BHYeAxft.js";import"./hash-CcEbRgUF.js";import"./FeatureType-ChjOHbol.js";import"./operatorsWorkerConnection-DqALQcTN.js";import"./FormTemplate-CRyiF9TK.js";import"./isFeatureGraphicOrigin-YA2hudPe.js";import"./editsZScale-UIVFjXVp.js";import"./queryZScale-CmghsP4K.js";import"./APIKeyMixin-yPXqkuNT.js";import"./ArcGISService-BDg18Jme.js";import"./EditBusLayer-Cn6t6Uxp.js";import"./FeatureLayerBase-B1iOgPwc.js";import"./LayerFloorInfo-DBuTfyEZ.js";import"./multiLayerServiceUtils-CXycnytB.js";import"./Relationship-BOxl_7P6.js";import"./serviceCapabilitiesUtils-Bk-hmOU8.js";import"./infoFor3D-dHKPbXlj.js";import"./TitleCreator-CrPmO3BA.js";import"./versionUtils-vXOiVmor.js";import"./styleUtils-BWiLJzdy.js";new q({Clean:"clean",Dirty:"dirty"});new q({Physical:"physical",Virtual:"virtual"});new q({"Start and end":"start-and-end",Start:"start",Midspan:"midspan",End:"end"});new q({startingPoint:"starting-point",barrier:"barrier",stoppingPoint:"stopping-point"});new q({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation",path:"path",circuit:"circuit"});const Ue="{00000000-0000-0000-0000-000000000000}",z=new q({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new q({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let K=class extends Q{constructor(i){super(i),this.type="telecomNetworkElement",this.firstUnit=null,this.numUnits=null}};h([v({json:{write:!1}})],K.prototype,"type",void 0),h([v({json:{write:!0}})],K.prototype,"firstUnit",void 0),h([v({json:{write:!0}})],K.prototype,"numUnits",void 0),K=h([ae("esri.rest.networks.support.TelecomNetworkElement")],K);let A=class extends we{constructor(u){super(u),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(u,t){return t.fromFirstUnit||t.fromNumUnits?new K({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId,firstUnit:t.fromFirstUnit,numUnits:t.fromNumUnits}):new Q({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId})}writeFromNetworkElement(u,t){if(u&&(t.fromGlobalId=u.globalId,t.fromNetworkSourceId=u.networkSourceId,t.fromTerminalId=u.terminalId,u.type==="telecomNetworkElement")){const r=u;t.fromFirstUnit=r.firstUnit,t.fromNumUnits=r.numUnits}}readToNetworkElement(u,t){return t.toFirstUnit||t.toNumUnits?new K({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId,firstUnit:t.toFirstUnit,numUnits:t.toNumUnits}):new Q({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId})}writeToNetworkElement(u,t){if(u&&(t.toGlobalId=u.globalId,t.toNetworkSourceId=u.networkSourceId,t.toTerminalId=u.terminalId,u.type==="telecomNetworkElement")){const r=u;t.toFirstUnit=r.firstUnit,t.toNumUnits=r.numUnits}}equals(u){if(this.globalId===Ue&&u.globalId===Ue){let t=function(s,p){return s.networkSourceId===p.networkSourceId&&s.globalId===p.globalId&&s.terminalId===p.terminalId&&s.firstUnit===p.firstUnit&&s.numUnits===p.numUnits};const r=this.fromNetworkElement,w=this.toNetworkElement,I=u.fromNetworkElement,e=u.toNetworkElement,n=t(r,I),a=t(w,e);return n&&a&&this.associationType===u.associationType}return this.globalId!=null&&u.globalId!=null&&this.globalId===u.globalId}};h([v({type:String,json:{write:!0}})],A.prototype,"globalId",void 0),h([v({type:z.apiValues,json:{type:z.jsonValues,read:z.read,write:z.write}})],A.prototype,"associationType",void 0),h([v({type:Q,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number},fromFirstUnit:{type:Number},fromNumUnits:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId","fromFirstUnit","fromNumUnits"]}}})],A.prototype,"fromNetworkElement",void 0),h([Ne("fromNetworkElement")],A.prototype,"readFromNetworkElement",null),h([Te("fromNetworkElement")],A.prototype,"writeFromNetworkElement",null),h([v({type:Q,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number},toFirstUnit:{type:Number},toNumUnits:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId","toFirstUnit","toNumUnits"]}}})],A.prototype,"toNetworkElement",void 0),h([Ne("toNetworkElement")],A.prototype,"readToNetworkElement",null),h([Te("toNetworkElement")],A.prototype,"writeToNetworkElement",null),h([v({type:$e,json:{write:!0}})],A.prototype,"geometry",void 0),h([v({type:String,json:{write:!0}})],A.prototype,"errorMessage",void 0),h([v({type:Number,json:{write:!0}})],A.prototype,"percentAlong",void 0),h([v({type:Number,json:{write:!0}})],A.prototype,"errorCode",void 0),h([v({type:Boolean,json:{write:!0}})],A.prototype,"isContentVisible",void 0),h([v({type:Number,json:{write:!0}})],A.prototype,"status",void 0),A=h([ae("esri.rest.networks.support.Association")],A);let oe=class extends we{constructor(u){super(u),this.associations=[]}};h([v({type:[A],json:{write:!0}})],oe.prototype,"associations",void 0),oe=h([ae("esri.rest.networks.support.QueryAssociationsResult")],oe);function yt(i){const{returnDeletes:u,elements:t,gdbVersion:r,moment:w}=i.toJSON();return{returnDeletes:u,elements:JSON.stringify(t.map(I=>({globalId:I.globalId,networkSourceId:I.networkSourceId,terminalId:I.terminalId}))),types:JSON.stringify(i.types.map(I=>z.toJSON(I))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:r,moment:w??Date.now()}}async function wt(i,u,t){const r=Me(i),w={...yt(u),f:"json"},I=Re({...r.query,...w}),e=Oe(I,{...t,method:"post"}),n=`${r.path}/associations/query`,{data:a}=await Ve(n,e),s=oe.fromJSON(a);return u.types.includes("connectivity")&&Ge(ze.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://arcg.is/11Tr8a#types",version:"4.29",warnOnce:!0}),s}var pe;let _=pe=class extends we{static from(i){return He(pe,i)}constructor(i){super(i),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};h([v({type:Boolean,json:{write:!0}})],_.prototype,"returnDeletes",void 0),h([v({type:[Q],json:{write:!0}})],_.prototype,"elements",void 0),h([v({type:[z.apiValues],json:{type:z.jsonValues,read:z.read,write:z.write}})],_.prototype,"types",void 0),h([v({type:String,json:{write:!0}})],_.prototype,"gdbVersion",void 0),h([v({type:Date,json:{type:Number,write:{writer:(i,u)=>{u.moment=i==null?void 0:i.getTime()}}}})],_.prototype,"moment",void 0),_=pe=h([ae("esri.rest.networks.support.QueryAssociationsParameters")],_);function It(i){if(i.length===1){if(U(i[0]))return le("distinct",i[0],-1);if(J(i[0]))return le("distinct",i[0].toArray(),-1)}return le("distinct",i,-1)}function me(i,u,t){const r=i.getVariables();if(r.length>0){const w={};for(const I of r)w[I]=u.evaluateIdentifier(t,{name:I});i.parameters=w}return i}function f(i,u,t=null){for(const r in i)if(r.toLowerCase()===u.toLowerCase())return i[r];return t}function Ce(i){if(i===null)return null;const u={type:f(i,"type",""),name:f(i,"name","")};if(u.type==="range")u.range=f(i,"range",[]);else{u.codedValues=[];for(const t of f(i,"codedValues",[]))u.codedValues.push({name:f(t,"name",""),code:f(t,"code",null)})}return u}function ye(i){if(i===null)return null;const u={},t=f(i,"wkt");t!==null&&(u.wkt=t);const r=f(i,"wkid");return r!==null&&(u.wkid=r),u}function je(i){if(i===null)return null;const u={hasZ:f(i,"hasz",!1),hasM:f(i,"hasm",!1)},t=f(i,"spatialreference");t!=null&&(u.spatialReference=ye(t));const r=f(i,"x",null);if(r!==null)return u.x=r,u.y=f(i,"y",null),u.hasZ&&(u.z=f(i,"z",null)),u.hasM&&(u.m=f(i,"m",null)),u;const w=f(i,"rings",null);if(w!==null)return u.rings=w,u;const I=f(i,"paths",null);if(I!==null)return u.paths=I,u;const e=f(i,"points",null);if(e!==null)return u.points=e,u;for(const n of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const a=f(i,n,null);a!==null&&(u[n]=a)}return u}function gt(i,u){for(const t of u)if(t===i)return!0;return!1}function ht(i){return!!i.layerDefinition&&!!i.featureSet&&gt(i.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&U(i.layerDefinition.fields)!==!1&&U(i.featureSet.features)!==!1}function ee(i){return(i==null?void 0:i.toLowerCase())==="utc"?"UTC":(i==null?void 0:i.toLowerCase())==="unknown"?"Unknown":i}async function bt(i,u,t,r,w,I,e){var d,m,E;const n=await i.getFeatureSetInfo();if(((n==null?void 0:n.layerId)??null)===null||!w.layerIdLookup.get(n.layerId))return null;const a=i.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),s=[];switch(t){case"connected":s.push("connectivity"),s.push("junction-edge-from-connectivity"),s.push("junction-edge-to-connectivity"),s.push("junction-edge-midspan-connectivity"),s.push("junction-junction-connectivity");break;case"container":case"content":s.push("containment");break;case"structure":case"attached":s.push("attachment");break;case"junctionedge":s.push("junction-edge-from-connectivity"),s.push("junction-edge-to-connectivity");break;case"midspan":s.push("junction-edge-midspan-connectivity");break;default:throw new y(I,"InvalidParameter",e)}let p=null,c=!1;if(r!==null&&r!==""&&r!==void 0){for(const g of w.terminals)g.terminalName===r&&(p=g.terminalId);p===null&&(c=!0)}const l=[];if(!c){const g=new Q({globalId:u.field(i.globalIdField),networkSourceId:w.layerIdLookup.get(n.layerId).sourceId,...p?{terminalId:p}:""}),N=await wt(a,new _({types:s,elements:[g]}));let D=0;for(const x of N.associations){let O=null,V="",j="";if(((d=x.fromNetworkElement)==null?void 0:d.globalId)===g.globalId?(O=x.toNetworkElement,j="to"):((m=x.toNetworkElement)==null?void 0:m.globalId)===g.globalId&&(O=x.fromNetworkElement,j="from"),!O)continue;switch(t){case"attached":if(x.associationType!=="attachment"||j!=="to")continue;break;case"structure":if(x.associationType!=="attachment"||j!=="from")continue;break;case"container":if(x.associationType!=="containment"||j!=="from")continue;break;case"content":if(x.associationType!=="containment"||j!=="to")continue;break;case"connected":break;case"junctionedge":x.associationType==="junction-edge-to-connectivity"?V="to":x.associationType==="junction-edge-from-connectivity"&&(V="from");break;case"midspan":if(x.associationType!=="junction-edge-midspan-connectivity")continue}const G=((E=w.sourceIdLookup.get(O.networkSourceId))==null?void 0:E.className)??"";l.push(new Qe({geometry:null,attributes:{objectId:D++,globalId:O.globalId,percentAlong:x.percentAlong??0,isContentVisible:x.isContentVisible?0:1,className:G,side:V}}))}}const o=new Le({source:l,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new M({name:"objectId",alias:"objectId",type:"oid"}),new M({name:"globalId",alias:"globalId",type:"global-id"}),new M({name:"percentAlong",alias:"percentAlong",type:"double"}),new M({name:"side",alias:"side",type:"string"}),new M({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new M({name:"className",alias:"className",type:"string"})]});return re(o)}function sn(i){if(i.mode==="async"){i.functions.timezone=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{var s,p;if(k(e,1,2,t,r),Ye(e[0])||ue(e[0]))return"Unknown";if(C(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?ee("unknown"):ee(e[0].dateFieldsTimeZone);if(!(e[1]instanceof R)||e[1].hasField("type")===!1)throw new y(t,"InvalidParameter",r);const c=e[1].field("type");if(Z(c)===!1)throw new y(t,"InvalidParameter",r);switch(S(c).toLowerCase()){case"preferredtimezone":return ee(e[0].preferredTimeZone);case"editfieldsinfo":return ee(((s=e[0].editFieldsInfo)==null?void 0:s.timeZone)??null);case"timeinfo":return ee(((p=e[0].timeInfo)==null?void 0:p.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&Z(e[1].field("fieldname")))return ee(e[0].fieldTimeZone(S(e[1].field("fieldname"))))}throw new y(t,"InvalidParameter",r)}const n=Xe(e[0],De(t));if(n===null)return null;const a=n.timeZone;return a==="system"?We.systemTimeZoneCanonicalName:a.toLowerCase()==="utc"?"UTC":a.toLowerCase()==="unknown"?"Unknown":a})},i.functions.sqltimestamp=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{k(e,1,3,t,r);const n=e[0];if(ve(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(S(e[1])).toSQLWithKeyword();throw new y(t,"InvalidParameter",r)}if(ue(n))return n.toSQLWithKeyword();if(C(n)){if(e.length!==3)throw new y(t,"InvalidParameter",r);await n.load();const a=S(e[1]);if(ue(e[2]))return e[2].toSQLWithKeyword();if(ve(e[2])===!1)throw new y(t,"InvalidParameter",r);const s=n.fieldTimeZone(a);return s==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(s).toSQLWithKeyword()}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"sqltimestamp",min:2,max:4}),i.functions.featuresetbyid=function(t,r){return i.standardFunctionAsync(t,r,(w,I,e)=>{if(k(e,2,4,t,r),ke(e[0])){const n=S(e[1]);let a=P(e[2],null);const s=Y(P(e[3],!0));if(a===null&&(a=["*"]),U(a)===!1)throw new y(t,"InvalidParameter",r);return e[0].featureSetById(n,s,a)}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"featuresetbyid",min:2,max:4});const u=new _e(["datasource","parent","root"]);i.functions.getfeatureset=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{if(k(e,1,2,t,r),te(e[0])){const n=e[1]==null?"datasource":u.lookup(S(e[1]));return it(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference)}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"getfeatureset",min:1,max:2}),i.functions.featuresetbyportalitem=function(t,r){return i.standardFunctionAsync(t,r,(w,I,e)=>{var c,l;if(k(e,2,5,t,r),e[0]===null)throw new y(t,"PortalRequired",r);if(e[0]instanceof qe){const o=S(e[1]),d=S(e[2]);let m=P(e[3],null);const E=Y(P(e[4],!0));if(m===null&&(m=["*"]),U(m)===!1)throw new y(t,"InvalidParameter",r);let g;return g=(c=t.services)!=null&&c.portal?t.services.portal:Ee.getDefault(),g=mt(e[0],g),Se(o,d,t.spatialReference,m,E,g,t.lrucache,t.interceptor)}if(Z(e[0])===!1)throw new y(t,"PortalRequired",r);const n=S(e[0]),a=S(e[1]);let s=P(e[2],null);const p=Y(P(e[3],!0));if(s===null&&(s=["*"]),U(s)===!1)throw new y(t,"InvalidParameter",r);return Se(n,a,t.spatialReference,s,p,((l=t.services)==null?void 0:l.portal)??Ee.getDefault(),t.lrucache,t.interceptor)})},i.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),i.functions.featuresetbyname=function(t,r){return i.standardFunctionAsync(t,r,(w,I,e)=>{if(k(e,2,4,t,r),ke(e[0])){const n=S(e[1]);let a=P(e[2],null);const s=Y(P(e[3],!0));if(a===null&&(a=["*"]),U(a)===!1)throw new y(t,"InvalidParameter",r);return e[0].featureSetByName(n,s,a)}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"featuresetbyname",min:2,max:4}),i.functions.featureset=function(t,r){return i.standardFunction(t,r,(w,I,e)=>{k(e,1,1,t,r);const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(Z(e[0])){const a=JSON.parse(e[0]);a.layerDefinition!==void 0?(n.layerDefinition=a.layerDefinition,n.featureSet=a.featureSet,a.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=a.layerDefinition.spatialReference)):(n.featureSet.features=a.features,n.featureSet.geometryType=a.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=a.objectIdFieldName??"",n.layerDefinition.typeIdField=a.typeIdFieldName,n.layerDefinition.globalIdField=a.globalIdFieldName,n.layerDefinition.fields=a.fields,a.spatialReference&&(n.layerDefinition.spatialReference=a.spatialReference))}else{if(!(e[0]instanceof R))throw new y(t,"InvalidParameter",r);{const a=JSON.parse(e[0].castToText(!0)),s=f(a,"layerdefinition");if(s!==null){n.layerDefinition.geometryType=f(s,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=f(s,"globalidfield",""),n.layerDefinition.objectIdField=f(s,"objectidfield",""),n.layerDefinition.typeIdField=f(s,"typeidfield",""),n.layerDefinition.hasZ=f(s,"hasz",!1)===!0,n.layerDefinition.hasM=f(s,"hasm",!1)===!0;const p=f(s,"spatialreference");p&&(n.layerDefinition.spatialReference=ye(p));const c=[];for(const o of f(s,"fields",[])){const d={name:f(o,"name",""),alias:f(o,"alias",""),type:f(o,"type",""),nullable:f(o,"nullable",!0),editable:f(o,"editable",!0),length:f(o,"length",null),domain:Ce(f(o,"domain"))};c.push(d)}n.layerDefinition.fields=c;const l=f(a,"featureset");if(l){const o={};for(const d of c)o[d.name.toLowerCase()]=d.name;for(const d of f(l,"features",[])){const m={},E=f(d,"attributes",{});for(const g in E)m[o[g.toLowerCase()]]=E[g];n.featureSet.features.push({attributes:m,geometry:je(f(d,"geometry"))})}}}else{n.layerDefinition.hasZ=f(a,"hasz",!1)===!0,n.layerDefinition.hasM=f(a,"hasm",!1)===!0,n.layerDefinition.geometryType=f(a,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=f(a,"objectidfieldname",""),n.layerDefinition.typeIdField=f(a,"typeidfieldname","");const p=f(a,"spatialreference");p&&(n.layerDefinition.spatialReference=ye(p));const c=[],l=f(a,"fields",null);if(!U(l))throw new y(t,"InvalidParameter",r);for(const m of l){const E={name:f(m,"name",""),alias:f(m,"alias",""),type:f(m,"type",""),nullable:f(m,"nullable",!0),editable:f(m,"editable",!0),length:f(m,"length",null),domain:Ce(f(m,"domain"))};c.push(E)}n.layerDefinition.fields=c;const o={};for(const m of c)o[m.name.toLowerCase()]=m.name;let d=f(a,"features",null);if(U(d))for(const m of d){const E={},g=f(m,"attributes",{});for(const N in g)E[o[N.toLowerCase()]]=g[N];n.featureSet.features.push({attributes:E,geometry:je(f(m,"geometry",null))})}else d=null,n.featureSet.features=d}}}if(ht(n)===!1)throw new y(t,"InvalidParameter",r);return n.layerDefinition.geometryType||(n.layerDefinition.geometryType="esriGeometryNull"),rt.create(n,t.spatialReference)})},i.signatures.push({name:"featureset",min:1,max:1}),i.functions.filter=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{if(k(e,2,2,t,r),U(e[0])||J(e[0])){const n=[];let a,s=e[0];if(s instanceof ft&&(s=s.toArray()),!et(e[1]))throw new y(t,"InvalidParameter",r);a=e[1].createFunction(t);for(const p of s){const c=a(p);Be(c)?await c===!0&&n.push(p):c===!0&&n.push(p)}return n}if(C(e[0])){const n=await e[0].load(),a=T.create(e[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),s=a.getVariables();if(s.length>0){const p={};for(const c of s)p[c]=i.evaluateIdentifier(t,{name:c});a.parameters=p}return new de({parentfeatureset:e[0],whereclause:a})}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"filter",min:2,max:2}),i.functions.orderby=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{if(k(e,2,2,t,r),C(e[0])){const n=new ot(e[1]);return new at({parentfeatureset:e[0],orderbyclause:n})}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"orderby",min:2,max:2}),i.functions.top=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{if(k(e,2,2,t,r),C(e[0]))return new st({parentfeatureset:e[0],topnum:e[1]});if(U(e[0]))return X(e[1])>=e[0].length?e[0].slice():e[0].slice(0,X(e[1]));if(J(e[0]))return X(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,X(e[1]));throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"top",min:2,max:2}),i.functions.first=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{if(k(e,1,1,t,r),C(e[0])){const n=await e[0].first(w.abortSignal);if(n!==null){const a=nt.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return a._underlyingGraphic=n,a}return n}return U(e[0])?e[0].length===0?null:e[0][0]:J(e[0])?e[0].length()===0?null:e[0].get(0):null})},i.signatures.push({name:"first",min:1,max:1}),i.functions.attachments=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{k(e,1,2,t,r);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof R){if(e[1].hasField("minsize")&&(n.minsize=X(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=Y(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=X(e[1].field("maxsize"))),e[1].hasField("types")){const a=tt(e[1].field("types"),!1);a.length>0&&(n.types=a)}}else if(e[1]!==null)throw new y(t,"InvalidParameter",r)}if(te(e[0])){const a=e[0]._layer;let s;if(C(a))s=a;else{if(a==null||!Ae(a))return[];s=re(a,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await s.load(),s.queryAttachments(e[0].field(s.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata)}if(e[0]===null)return[];throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"attachments",min:1,max:2}),i.functions.featuresetbyrelationshipname=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{k(e,2,4,t,r);const n=e[0],a=S(e[1]);let s=P(e[2],null);const p=Y(P(e[3],!0));if(s===null&&(s=["*"]),U(s)===!1)throw new y(t,"InvalidParameter",r);if(e[0]===null)return null;if(!te(e[0]))throw new y(t,"InvalidParameter",r);const c=n._layer;let l;if(C(c))l=c;else{if(c==null||!Ae(c))return null;l=re(c,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}l=await l.load();const o=l.relationshipMetaData().filter(N=>N.name===a);if(o.length===0)return null;if(o[0].relationshipTableId!==void 0&&o[0].relationshipTableId!==null&&o[0].relationshipTableId>-1)return lt(l,o[0],n.field(l.objectIdField),l.spatialReference,s,p,t.lrucache,t.interceptor);let d=l.serviceUrl();if(!d)return null;d=d.endsWith("/")?d+o[0].relatedTableId.toString():d+"/"+o[0].relatedTableId.toString();const m=await ut(d,l.spatialReference,s,p,t.lrucache,t.interceptor);await m.load();let E=m.relationshipMetaData();if(E=E.filter(N=>N.id===o[0].id),n.hasField(o[0].keyField)===!1||n.field(o[0].keyField)===null){const N=await l.getFeatureByObjectId(n.field(l.objectIdField),[o[0].keyField]);if(N){const D=T.create(E[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return D.parameters={id:N.attributes[o[0].keyField]},m.filter(D)}return new pt({parentfeatureset:m})}const g=T.create(E[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return g.parameters={id:n.field(o[0].keyField)},m.filter(g)})},i.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),i.functions.featuresetbyassociation=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{k(e,2,3,t,r);const n=e[0],a=Je(S(P(e[1],""))),s=Z(e[2])?S(e[2]):null;if(e[0]===null)return null;if(!te(e[0]))throw new y(t,"InvalidParameter",r);let p=n._layer;if(p instanceof Le&&(p=re(p,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),p===null||C(p)===!1)return null;await p.load();const c=p.serviceUrl(),l=await dt(c,t.spatialReference,!0);if(l.unVersion>=8)return await bt(p,n,a,s,l,t,r);const o=l.associations;let d=null,m=null,E=!1;if(s!==null&&s!==""&&s!==void 0){for(const F of l.terminals)F.terminalName===s&&(m=F.terminalId);m===null&&(E=!0)}const g=o.getFieldsIndex(),N=g.get("TOGLOBALID").name,D=g.get("FROMGLOBALID").name,x=g.get("TOTERMINALID").name,O=g.get("FROMTERMINALID").name,V=g.get("FROMNETWORKSOURCEID").name,j=g.get("TONETWORKSOURCEID").name,G=g.get("ASSOCIATIONTYPE").name,Ze=g.get("ISCONTENTVISIBLE").name,Pe=g.get("OBJECTID").name;for(const F of p.fields)if(F.type==="global-id"){d=n.field(F.name);break}let H=null,Ie=new B(new M({name:"percentalong",alias:"percentalong",type:"double"}),T.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),ge=new B(new M({name:"side",alias:"side",type:"string"}),T.create("''",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));const L="globalid",he="globalId",be={};for(const F in l.lkp)be[F]=l.lkp[F].sourceId;const W=new ct(new M({name:"classname",alias:"classname",type:"string"}),null,be);let b="";switch(a){case"midspan":{b=`((${N}='${d}') OR ( ${D}='${d}')) AND (${G} IN (5))`,W.codefield=T.create(`CASE WHEN (${N}='${d}') THEN ${V} ELSE ${j} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const F=fe($.findField(o.fields,D));F.name=L,F.alias=L,H=new B(F,T.create(`CASE WHEN (${D}='${d}') THEN ${N} ELSE ${D} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),Ie=l.unVersion>=4?new ce($.findField(o.fields,g.get("PERCENTALONG").name)):new B(new M({name:"percentalong",alias:"percentalong",type:"double"}),T.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{b=`((${N}='${d}') OR ( ${D}='${d}')) AND (${G} IN (4,6))`,W.codefield=T.create(`CASE WHEN (${N}='${d}') THEN ${V} ELSE ${j} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const F=fe($.findField(o.fields,D));F.name=L,F.alias=L,H=new B(F,T.create(`CASE WHEN (${D}='${d}') THEN ${N} ELSE ${D} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),ge=new B(new M({name:"side",alias:"side",type:"string"}),T.create(`CASE WHEN (${G}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let F=`${N}='@T'`,Fe=`${D}='@T'`;m!==null&&(F+=` AND ${x}=@A`,Fe+=` AND ${O}=@A`),b="(("+F+") OR ("+Fe+"))",b=ne(b,"@T",d??""),F=ne(F,"@T",d??""),m!==null&&(F=ne(F,"@A",m.toString()),b=ne(b,"@A",m.toString())),W.codefield=T.create("CASE WHEN "+F+` THEN ${V} ELSE ${j} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const se=fe($.findField(o.fields,D));se.name=L,se.alias=L,H=new B(se,T.create("CASE WHEN "+F+` THEN ${D} ELSE ${N} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"container":b=`${N}='${d}' AND ${G} = 2`,m!==null&&(b+=` AND ${x} = `+m.toString()),W.codefield=V,b="( "+b+" )",H=new ie($.findField(o.fields,D),L,L);break;case"content":b=`(${D}='${d}' AND ${G} = 2)`,m!==null&&(b+=` AND ${O} = `+m.toString()),W.codefield=j,b="( "+b+" )",H=new ie($.findField(o.fields,N),L,L);break;case"structure":b=`(${N}='${d}' AND ${G} = 3)`,m!==null&&(b+=` AND ${x} = `+m.toString()),W.codefield=V,b="( "+b+" )",H=new ie($.findField(o.fields,D),L,he);break;case"attached":b=`(${D}='${d}' AND ${G} = 3)`,m!==null&&(b+=` AND ${O} = `+m.toString()),W.codefield=j,b="( "+b+" )",H=new ie($.findField(o.fields,N),L,he);break;default:throw new y(t,"InvalidParameter",r)}return E&&(b="1 <> 1"),new $({parentfeatureset:o,adaptedFields:[new ce($.findField(o.fields,Pe)),new ce($.findField(o.fields,Ze)),H,ge,W,Ie],extraFilter:b?T.create(b,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}):null})})},i.signatures.push({name:"featuresetbyassociation",min:2,max:6}),i.functions.groupby=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{if(k(e,3,3,t,r),!C(e[0]))throw new y(t,"InvalidParameter",r);const n=await e[0].load(),a=[],s=[];let p=!1,c=[];if(Z(e[1]))c.push(e[1]);else if(e[1]instanceof R)c.push(e[1]);else if(U(e[1]))c=e[1];else{if(!J(e[1]))throw new y(t,"InvalidParameter",r);c=e[1].toArray()}for(const l of c)if(Z(l)){const o=T.create(S(l),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),d=xe(o)===!0?S(l):"%%%%FIELDNAME";a.push({name:d,expression:o}),d==="%%%%FIELDNAME"&&(p=!0)}else{if(!(l instanceof R))throw new y(t,"InvalidParameter",r);{const o=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",d=l.hasField("expression")?l.field("expression"):"";if(o==="%%%%FIELDNAME"&&(p=!0),!o)throw new y(t,"InvalidParameter",r);a.push({name:o,expression:T.create(d||o,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(c=[],Z(e[2]))c.push(e[2]);else if(U(e[2]))c=e[2];else if(J(e[2]))c=e[2].toArray();else{if(!(e[2]instanceof R))throw new y(t,"InvalidParameter",r);c.push(e[2])}for(const l of c){if(!(l instanceof R))throw new y(t,"InvalidParameter",r);{const o=l.hasField("name")?l.field("name"):"",d=l.hasField("statistic")?l.field("statistic"):"",m=l.hasField("expression")?l.field("expression"):"";if(!(o&&d&&Z(d)&&m))throw new y(t,"InvalidParameter",r);s.push({name:o,statistic:d,expression:T.create(m,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const l={};for(const d of n.fields)l[d.name.toLowerCase()]=1;for(const d of a)d.name!=="%%%%FIELDNAME"&&(l[d.name.toLowerCase()]=1);for(const d of s)d.name!=="%%%%FIELDNAME"&&(l[d.name.toLowerCase()]=1);let o=0;for(const d of a)if(d.name==="%%%%FIELDNAME"){for(;l["field_"+o.toString()]===1;)o++;l["field_"+o.toString()]=1,d.name="FIELD_"+o.toString()}}for(const l of a)me(l.expression,i,t);for(const l of s)me(l.expression,i,t);return e[0].groupby(a,s)})},i.signatures.push({name:"groupby",min:3,max:3}),i.functions.distinct=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{if(C(e[0])){k(e,2,2,t,r);const n=await e[0].load(),a=[];let s=[];if(Z(e[1]))s.push(e[1]);else if(e[1]instanceof R)s.push(e[1]);else if(U(e[1]))s=e[1];else{if(!J(e[1]))throw new y(t,"InvalidParameter",r);s=e[1].toArray()}let p=!1;for(const c of s)if(Z(c)){const l=T.create(S(c),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),o=xe(l)===!0?S(c):"%%%%FIELDNAME";a.push({name:o,expression:l}),o==="%%%%FIELDNAME"&&(p=!0)}else{if(!(c instanceof R))throw new y(t,"InvalidParameter",r);{const l=c.hasField("name")?c.field("name"):"%%%%FIELDNAME",o=c.hasField("expression")?c.field("expression"):"";if(l==="%%%%FIELDNAME"&&(p=!0),!l)throw new y(t,"InvalidParameter",r);a.push({name:l,expression:T.create(o||l,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const c={};for(const o of n.fields)c[o.name.toLowerCase()]=1;for(const o of a)o.name!=="%%%%FIELDNAME"&&(c[o.name.toLowerCase()]=1);let l=0;for(const o of a)if(o.name==="%%%%FIELDNAME"){for(;c["field_"+l.toString()]===1;)l++;c["field_"+l.toString()]=1,o.name="FIELD_"+l.toString()}}for(const c of a)me(c.expression,i,t);return e[0].groupby(a,[])}return It(e)})},i.functions.getfeaturesetinfo=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{if(k(e,1,1,t,r),!C(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?R.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},De(t),!1,!1):null})},i.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),i.functions.filterbysubtypecode=function(t,r){return i.standardFunctionAsync(t,r,async(w,I,e)=>{if(k(e,2,2,t,r),C(e[0])){const n=await e[0].load(),a=e[1];if(!Ke(a))throw new y(t,"InvalidParameter",r);if(n.subtypeField){const p=T.create(`${n.subtypeField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new de({parentfeatureset:e[0],whereclause:p})}if(n.typeIdField===null||n.typeIdField==="")throw new y(t,"FeatureSetDoesNotHaveSubtypes",r);const s=T.create(`${n.typeIdField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new de({parentfeatureset:e[0],whereclause:s})}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{sn as registerFunctions};
