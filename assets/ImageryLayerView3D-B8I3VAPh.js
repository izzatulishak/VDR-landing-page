import{el as H,g as b,_ as n,b as c,f as $,m as h,s as I,fZ as V,bF as F,bs as P,a1 as v,e as z,K as D,N as M,a as O}from"./index-5QWH35TG.js";import{A as T,m as L}from"./DynamicLayerView3D-CiXIxHdT.js";import{w as A}from"./ImageHighlightHelper3D-KgGroLKI.js";import{x as C}from"./dataUtils-4b6eiycG.js";import{r as N}from"./FlowSubView3D-CFbLpP3I.js";import{a as G}from"./rasterFieldUtils-DVpxGvUo.js";import{i as j}from"./timeSupport-DZEurgRy.js";import{I as k,j as q}from"./rasterProjectionHelper-BTD0JZGn.js";import{n as B}from"./popupUtils-WPRNgm3z.js";import"./SubView3D-BnilmYNv.js";import"./ImageMaterial.glsl-C225Qf5S.js";import"./TriangleMaterial-Cne8T0HW.js";import"./DefaultLayouts-DRe9NdnC.js";import"./LayerView3D-D0PfsNOA.js";import"./LayerView-DVshPFuJ.js";import"./RefreshableLayerView-CNHppT11.js";import"./loadUtils-CC5lWWLx.js";import"./FeatureTileDescriptor-irS3eHEB.js";import"./line-CttzBRKr.js";import"./utils-Bj89K5D4.js";let y=class extends T{constructor(e){super(e),this.redrawDebounced=H(async t=>{this.redraw((i,a)=>this._redrawImage(i,a),t)},2e3)}initialize(){this.addHandles([b(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this.updatingHandles.addPromise(this.redrawDebounced()))])}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}async processResult(e,t,i){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,i))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||e.pixelData==null)throw new Error;const i=e.image,a=i.getContext("2d"),r=await this.layer.applyRenderer(e.pixelData,{signal:t}),s=this.layer.applyFilter(r).pixelBlock;if(s==null)throw new Error;i.width=s.width,i.height=s.height;const l=a.createImageData(s.width,s.height);l.data.set(s.getAsRGBA()),a.putImageData(l,0,0)}};y=n([c("esri.views.3d.layers.ImagerySubView3D")],y);let f=class extends N{constructor(e){super(e)}initialize(){this.updatingHandles.add(()=>this.renderedTiles,()=>this.triggerLoad()),this.updatingHandles.add(()=>this.elevationInfo.mode,e=>this._updatePopupDrapeSource(e),{initial:!0})}_updatePopupDrapeSource(e){if(e==="on-the-ground")return void this.removeHandles(w);if(this.hasHandles(w))return;const t={destroyed:!1,drapeSourceType:2,updatePolicy:0,layer:this.layer},i=this.layerView.view.overlayManager;i.registerGeometryDrapeSource(t),this.addHandles($(()=>i.unregisterDrapeSource(t)),w)}async fetchDataAndGenerateStreamlines(e,t){const{needsMagnitude:i,workerHandle:a}=this,r=this.getSimulationSettings(e),{size:s,extent:l,timeExtent:p}=e;if(r==null||a==null)return;const g=await C(this.layer,l,s[0],s[1],p,t);if(g==null)return null;const o={simulationSettings:r,flowExtentInfo:e.flowExtentInfo,flowData:g,needsMagnitude:i,startPositions:this.startPositions(e)},{streamlines:d}=await a.generateStreamlines(o,t);return d}};f=n([c("esri.views.3d.support.flow.FlowSubViewExtent3D")],f);const w=Symbol("popupDrapeSource"),U=e=>{const t=e;let i=class extends t{constructor(...a){super(...a),this.view=null}get timeExtent(){var a;return j(this.layer,(a=this.view)==null?void 0:a.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(a,r){const{layer:s}=this;if(!a)throw new I("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:l}=s,p=B(s,r);if(!l||p==null)return[];const g=await p.getRequiredFields(null,{index:new V(s.rasterFields),partitions:new Map([["$pixel",s.rasterFields.filter(u=>u.name.startsWith(G)).map(u=>u.name)],["$imageCollectionItem",s.fields.map(u=>u.name)]])});F(r);const o=new P;o.timeExtent=this.timeExtent,o.geometry=a,o.outFields=g,o.outSpatialReference=a.spatialReference;const{resolution:d,spatialReference:x}=this.view,_=this.view.type==="2d"?new v(d,d,x):new v(.5*d,.5*d,x),{returnTopmostRaster:R,showNoDataRecords:S}=p.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},E={returnDomainValues:!0,returnTopmostRaster:R,pixelSize:_,showNoDataRecords:S,signal:r==null?void 0:r.signal};return s.queryVisibleRasters(o,E)}async getSourceScale(){return await q(),await this.layer.load(),k(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){var a;return!!super.canResume()&&!((a=this.timeExtent)!=null&&a.isEmpty)}};return n([h()],i.prototype,"layer",void 0),n([h()],i.prototype,"suspended",void 0),n([h({readOnly:!0})],i.prototype,"timeExtent",null),n([h()],i.prototype,"view",void 0),i=n([c("esri.views.layers.ImageryLayerView")],i),i};let m=class extends U(L){constructor(){super(...arguments),this.type="imagery-3d"}get highlightOptions(){return null}get pixelData(){return null}initialize(){const e=()=>this._updatingHandles.addPromise(this.refreshDebounced());this._updatingHandles.add(()=>{var t,i;return(i=(t=this.layer)==null?void 0:t.exportImageServiceParameters)==null?void 0:i.version},e),this._updatingHandles.add(()=>{var t;return(t=this.layer)==null?void 0:t.renderer},e),this._updatingHandles.add(()=>this.timeExtent,e),this._highlightHelper=new A({view:this.view,layer:this.layer,updatingHandles:this._updatingHandles}),this.addHandles([z(this._highlightHelper),D(()=>this.suspended,t=>this._highlightHelper.suspended=t,M)])}_initSubView(){this.addHandles([D(()=>this.layer.renderer,e=>this._recreateSubView(e),O)])}_recreateSubView(e){var r;const t=(e==null?void 0:e.type)==="flow",i=((r=this.subView)==null?void 0:r.type)==="flow",a=this.subView;a&&t===i||(this.subView=t?new f({layerView:this}):new y({layerView:this}),a==null||a.destroy())}getFetchOptions(){return{timeExtent:this.timeExtent}}highlight(e,t){return this._highlightHelper.highlight(e,t)}isUpdating(){return super.isUpdating()||this._highlightHelper.updating}};n([h()],m.prototype,"highlightOptions",null),n([h()],m.prototype,"pixelData",null),m=n([c("esri.views.3d.layers.ImageryLayerView3D")],m);const me=m;export{me as default};
