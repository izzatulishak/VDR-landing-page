import{ax as tt,bO as Be,uX as V,l as T,x4 as se,Z as We,g5 as E,tp as rt,gb as g,x5 as st,x6 as oe,x7 as he,k3 as me,aM as it,bg as O,x8 as nt,x9 as at,bf as pe,bh as ge,lJ as ot,g7 as ht,o_ as dt,fZ as de,xa as ut,lw as G,aL as b,qV as $,xb as lt,xc as ct,tu as D,xd as ye,cS as ft,h_ as _t,xe as mt,c7 as Ce,P as pt,fd as gt,tC as De,cG as xe,ck as Ie,xf as yt,wy as ie,s4 as xt,a4 as It}from"./index-CeBxY8tu.js";import{r as bt}from"./parquet-B0w0tQsg.js";import{a as vt,l as Tt}from"./labelPoint-DWXYowOx.js";import{c as N}from"./FixedIntervalBinParameters-BgTdLRQm.js";function lr(n,e,t){var s;if(n==null)return null;const r=e.readArcadeFeature();e.contextTimeZone=(s=t.$view)==null?void 0:s.timeZone;try{return n.evaluate(r,t)}catch(i){return tt.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",i),null}}function $e(n){return n==null||n===1/0||n===-1/0||typeof n=="number"&&isNaN(n)}function cr(n,e,t,r){var a;if(n==null)return r??null;const s=e.readArcadeFeature();e.contextTimeZone=(a=t.$view)==null?void 0:a.timeZone;const i=n.evaluate(s,t);return $e(i)?r??null:i}let Mt=class R{static fromBuffer(e,t){return new R(e,t)}static create(e,t=4294967295){const r=new Uint32Array(Math.ceil(e/32));return new R(r,t)}constructor(e,t){this._mask=0,this._buf=e,this._mask=t}_getIndex(e){return Math.floor(e/32)}get usedMemory(){return Be(this._buf)}has(e){const t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}hasRange(e,t){let r=e,s=t;for(;r%32&&r!==s;){if(this.has(r))return!0;r++}for(;s%32&&r!==s;){if(this.has(r))return!0;s--}if(r===s)return!1;for(let i=r/32;i!==s/32;i++)if(this._buf[i])return!0;return!1}set(e){const t=this._mask&e,r=this._getIndex(t),s=1<<t%32;this._buf[r]|=s}setRange(e,t){let r=e,s=t;for(;r%32&&r!==s;)this.set(r++);for(;s%32&&r!==s;)this.set(s--);if(r!==s)for(let i=r/32;i!==s/32;i++)this._buf[i]=4294967295}unset(e){const t=this._mask&e,r=this._getIndex(t),s=1<<t%32;this._buf[r]&=4294967295^s}resize(e){const t=this._buf,r=new Uint32Array(Math.ceil(e/32));r.set(t),this._buf=r}or(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}and(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}xor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}ior(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}iand(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}ixor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}any(){for(let e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}copy(e){for(let t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}clone(){return new R(this._buf.slice(),this._mask)}clear(){for(let e=0;e<this._buf.length;e++)this._buf[e]=0;return this}forEachSet(e){for(let t=0;t<this._buf.length;t++){let r=this._buf[t],s=32*t;if(r)for(;r;)1&r&&e(s),r>>>=1,s++}}countSet(){let e=0;return this.forEachSet(t=>{e++}),e}},wt=class{constructor(e){this._valid=Mt.create(e),this._data=new Array(e)}get usedMemory(){let e=this._valid.usedMemory;if(this._data.length>0){const t=typeof this._data[0]=="string"?64:V;e+=this._data.length*t}return e}has(e){return this._valid.has(e)}set(e,t){this._valid.set(e),this._data[e]=t}get(e){return this._data[e]}};const Q=T("featurelayer-simplify-thresholds")??[.5,.5,.5,.5],Ft=Q[0],St=Q[1],kt=Q[2],At=Q[3],fe=T("featurelayer-simplify-payload-size-factors")??[1,2,4],Bt=fe[0],Wt=fe[1],Ct=fe[2],Dt=T("featurelayer-simplify-mobile-factor")??2,$t=T("esri-mobile"),be=4294967295;function Xt(n,e,t){if(!(n.length>e))for(;n.length<=e;)n.push(t)}class _e{constructor(e){this.metadata=e,this.type="FeatureSetReader",this._overrides=null,this._joined=[],this._objectIdToIndex=null,this._boundsBuffer=[],this._caches=new Map,this.arcadeDeclaredClass="esri.arcade.Feature",this._contextTimeZone=null}destroy(){}[Symbol.dispose](){this.destroy()}getAreaSimplificationThreshold(e,t){let r=1;const s=$t?Dt:1;t>4e6?r=Ct*s:t>1e6?r=Wt*s:t>5e5?r=Bt*s:t>1e5&&(r=s);let i=0;return e>4e3?i=At*r:e>2e3?i=kt*r:e>100?i=St:e>15&&(i=Ft),i}getBounds(e){Xt(this._boundsBuffer,4*this.getIndex()+4,0);const t=this.getBoundsXMin();if(t===be||!isFinite(t))return!1;if(this.getBoundsXMin()===0){const o=this.readGeometryWorldSpace();if(o!=null&&o.isPoint&&o.coords[0]===0&&o.coords[1]===0)return se(e,0,0,0,0),!0;if(!o)return this.setBoundsXMin(be),!1;let h=1/0,d=1/0,u=-1/0,l=-1/0;return o.forEachVertex((f,_)=>{h=Math.min(h,f),d=Math.min(d,_),u=Math.max(u,f),l=Math.max(l,_)}),this.setBoundsXMin(h),this.setBoundsYMin(d),this.setBoundsXMax(u),this.setBoundsYMax(l),se(e,h,d,u,l),!0}const r=this.getBoundsXMin(),s=this.getBoundsYMin(),i=this.getBoundsXMax(),a=this.getBoundsYMax();return se(e,r,s,i,a),!0}getBoundsXMin(){return this._boundsBuffer[4*this.getIndex()]}setBoundsXMin(e){this._boundsBuffer[4*this.getIndex()]=e}getBoundsYMin(){return this._boundsBuffer[4*this.getIndex()+1]}setBoundsYMin(e){this._boundsBuffer[4*this.getIndex()+1]=e}getBoundsXMax(){return this._boundsBuffer[4*this.getIndex()+2]}setBoundsXMax(e){this._boundsBuffer[4*this.getIndex()+2]=e}getBoundsYMax(){return this._boundsBuffer[4*this.getIndex()+3]}setBoundsYMax(e){this._boundsBuffer[4*this.getIndex()+3]=e}readAttributeAsTimestamp(e){const t=this.readAttribute(e);return typeof t=="string"?new Date(t).getTime():typeof t=="number"||t==null?t:null}readAttribute(e,t=!1){const r=this._readAttribute(e,t);if(r!==void 0)return r;for(const s of this._joined){s.setIndex(this.getIndex());const i=s._readAttribute(e,t);if(i!==void 0)return i}}readAttributes(){const e=this._readAttributes();for(const t of this._joined){t.setIndex(this.getIndex());const r=t._readAttributes();for(const s of Object.keys(r))e[s]=r[s]}return e}joinAttributes(e){this._joined.push(e)}registerOverrides(e){this._overrides=e}withoutOverrides(){const e=this.copy();return e._overrides=null,e}readOptimizedFeatureWorldSpace(){const e=this.readGeometryWorldSpace(),t=this.readAttributes(),r=this.readCentroidWorldSpace();return new We(e,t,r,this.getObjectId(),this.getDisplayId())}readLegacyFeatureForDisplay(){const e=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyFeatureWorldSpace(){const e=this.readCentroidWorldSpace();return{attributes:this.readAttributes(),geometry:this._readLegacyGeometryWorldSpace(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyGeometryForDisplay(){const e=this.readGeometryForDisplay();return E(e,this.geometryType,!1,!1)}readXForDisplay(){return this._readX()}readYForDisplay(){return this._readY()}readXWorldSpace(){const e=this._readX(),t=this.getInTransform();return t==null?e:e*t.scale[0]+t.translate[0]}readYWorldSpace(){const e=this._readY(),t=this.getInTransform();return t==null?e:t.translate[1]-e*t.scale[1]}readGeometryForDisplay(){const e=this._readGeometryDeltaDecoded(!0);if(!e){const t=this._createDeltaQuantizedGeometryFromServerCentroid();return t?t.deltaDecode():null}return e}readGeometryForDisplayTransformed(e){let t=this.readGeometryForDisplay();if(t&&this.metadata.geometryType==="esriGeometryPolyline"&&(t=rt(new g,t,this.hasZ,this.hasM,this.metadata.geometryType,e.scale[0])),t&&(t=st(t,e,this.metadata.geometryType,this.hasZ,this.hasM)),!t){const r=this.readCentroidForDisplay();if(!r)return null;const s=oe(e,r.coords[0]),i=he(e,r.coords[1]);return this._createDeltaQuantizedExtrudedGeometry(s,i).deltaDecode()}return t}readGeometryWorldSpace(){let e=this._readGeometry();if(e||(e=this._createDeltaQuantizedGeometryFromServerCentroid()),!e)return null;const t=e.clone(),r=this.getInTransform();return r!=null&&me(t,t,this.hasZ,this.hasM,r),t}readCentroidForDisplay(){const e=this.readGeometryForDisplay();return e?this._computeDisplayCentroid(e):this._readServerCentroid()}readCentroidWorldSpace(){const e=this.readGeometryForDisplay(),t=e?this._computeDisplayCentroid(e):this._readServerCentroid();if(!t)return null;const r=t.clone(),s=this.getInTransform();return s!=null&&me(r,r,this.hasZ,this.hasM,s),r}setCache(e){let t=this._caches.get(e);t==null&&(t=new wt(this.getSize()),this._caches.set(e,t)),this._activeCache=t}setCachedValue(e){this._activeCache.set(this.getIndex(),e)}hasCachedValue(){return this._activeCache.has(this.getIndex())}getCachedValue(){return this._activeCache.get(this.getIndex())}get underlyingMemory(){let e=0;e+=Be(this._boundsBuffer);for(const t of this._caches.values())e+=t.usedMemory;return e}_readGeometryDeltaDecoded(e){const t=this._readGeometry(e);return this.geometryType!=="esriGeometryPoint"&&t&&this.getInTransform()?t.deltaDecode():t}get contextTimeZone(){return this._contextTimeZone}set contextTimeZone(e){this._contextTimeZone=e}readArcadeFeature(){return this}hasField(e){return this.fields.has(e)||this._joined.some(t=>t.hasField(e))}geometry(){const e=this.readGeometryWorldSpace(),t=E(e,this.geometryType,this.hasZ,this.hasM),r=it(t);if(r){if(!this.metadata.outSpatialReference)throw new Error("InternalError: Expected spatial reference to be defined");r.spatialReference=this.metadata.outSpatialReference}return r}autocastArcadeDate(e,t){return t&&t instanceof Date?this.isUnknownDateTimeField(e)?O.unknownDateJSToArcadeDate(t):O.dateJSAndZoneToArcadeDate(t,this.contextTimeZone??nt):t}isUnknownDateTimeField(e){return this.metadata.fieldsIndex.getTimeZone(e)===at}field(e){let t=this.fields.get(e);if(t)switch(t.type){case"date-only":case"esriFieldTypeDateOnly":return ge.fromReader(this.readAttribute(e,!1));case"time-only":case"esriFieldTypeTimeOnly":return pe.fromReader(this.readAttribute(e,!1));case"esriFieldTypeTimestampOffset":case"timestamp-offset":return O.fromReaderAsTimeStampOffset(this.readAttribute(e,!1));case"date":case"esriFieldTypeDate":return this.autocastArcadeDate(e,this.readAttribute(e,!0));default:return this.readAttribute(e,!1)}for(const r of this._joined)if(r.setIndex(this.getIndex()),t=r.fields.get(e),t)switch(t.type){case"date-only":case"esriFieldTypeDateOnly":return ge.fromReader(r._readAttribute(e,!1));case"time-only":case"esriFieldTypeTimeOnly":return pe.fromReader(r._readAttribute(e,!1));case"esriFieldTypeTimestampOffset":case"timestamp-offset":return O.fromReaderAsTimeStampOffset(r._readAttribute(e,!1));case"date":case"esriFieldTypeDate":return this.autocastArcadeDate(e,r._readAttribute(e,!0));default:return this.readAttribute(e,!1)}throw new Error(`Field ${e} does not exist`)}setField(e,t){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.fields.fields.map(e=>e.name)}isEmpty(){return this.fields.fields.length<=0&&this.geometry()==null}castToText(e=!1){if(!e)return JSON.stringify(this.readLegacyFeatureForDisplay());const t=this.readLegacyFeatureForDisplay();if(!t)return JSON.stringify(null);const r={geometry:t.geometry,attributes:{...t.attributes}};for(const s in r.attributes){const i=r.attributes[s];i instanceof Date&&(r.attributes[s]=i.getTime())}return JSON.stringify(r)}gdbVersion(){return null}fullSchema(){return this.metadata.arcadeSchema}castAsJson(e=null){var t;return{attributes:this._readAttributes(),geometry:(e==null?void 0:e.keepGeometryType)===!0?this.geometry():((t=this.geometry())==null?void 0:t.toJSON())??null}}castAsJsonAsync(e=null,t=null){return Promise.resolve(this.castAsJson(t))}_getExists(){if(this._overrides){const e=this.getObjectId();return!this._overrides.hasOverride(e)}return!0}_computeDisplayCentroid(e){if(this.getInTransform()==null)return ot(new g,e,this.hasM,this.hasZ);const t=vt.fromOptimized(e,this.geometryType);t.yFactor*=-1;const r=Tt(t);return r?(r[1]*=-1,new g([],r)):null}copyInto(e){e._joined=this._joined,e._overrides=this._overrides,e._objectIdToIndex=this._objectIdToIndex,e._boundsBuffer=this._boundsBuffer,e._activeCache=this._activeCache,e._caches=this._caches,e._contextTimeZone=this._contextTimeZone}_readLegacyGeometryWorldSpace(){const e=this.readGeometryWorldSpace();return E(e,this.geometryType,!1,!1)}_createDeltaQuantizedGeometryFromServerCentroid(){const e=this._readServerCentroid();if(!e)return null;const[t,r]=e.coords;return this._createDeltaQuantizedExtrudedGeometry(t,r)}_createDeltaQuantizedExtrudedGeometry(e,t){return this.geometryType==="esriGeometryPolyline"?this._createDeltaQuantizedExtrudedLine(e,t):this._createDeltaQuantizedExtrudedQuad(e,t)}_createDeltaQuantizedExtrudedQuad(e,t){return new g([5],[e-1,t,1,-1,1,1,-1,1,-1,-1])}_createDeltaQuantizedExtrudedLine(e,t){return new g([2],[e-1,t+1,1,-1])}}let Xe=class v extends _e{static fromFeatures(e,t){const{geometryType:r}=t,s=ht([],e,r,!1,!1,t.featureIdInfo);for(let i=0;i<s.length;i++)s[i].displayId=e[i].displayId;return v.fromOptimizedFeatures(s,t)}static fromFeatureSet(e,t){const r=dt(e,t.featureIdInfo);return v.fromOptimizedFeatureSet(r,t)}static fromOptimizedFeatureSet(e,t){const r=v.fromOptimizedFeatures(e.features,t);return r._exceededTransferLimit=e.exceededTransferLimit,r._transform=e.transform,r._fieldsIndex=new de(e.fields),r}static fromOptimizedFeatures(e,t,r){const s=new v(e,t);return s._fieldsIndex=t.fieldsIndex,s._transform=r,s}static empty(e){return new v([],e)}constructor(e,t){super(t),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=t.geometryType,this._features=e}get fields(){return this._fieldsIndex}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}get _current(){return this._features[this._featureIndex]}get usedMemory(){return this._current.usedMemory}getSize(){return this._features.length}getCursor(){return this.copy()}getInTransform(){return this._transform}getAttributeHash(){let e="";for(const t in this._current.attributes)e+=this._current.attributes[t];return e}getIndex(){return this._featureIndex}setIndex(e){this._featureIndex=e}getObjectId(){var e;return(e=this._current)==null?void 0:e.objectId}getDisplayId(){return this._current.displayId}setDisplayId(e){this._current.displayId=e}copy(){const e=new v(this._features,this.metadata);return this.copyInto(e),e}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readGeometryArea(){return G(this._current)?ut(this._current.geometry,2):0}_readX(){return G(this._current)?this._current.geometry.coords[0]:0}_readY(){return G(this._current)?this._current.geometry.coords[1]:0}_readGeometry(){return G(this._current)?this._current.geometry??null:null}_readServerCentroid(){return this._current.centroid}_readAttribute(e,t){if(!this._fieldsIndex){const i=this._current.attributes[e];if(i!==void 0)return i;const a=e.toLowerCase();for(const o in this._current.attributes)if(o.toLowerCase()===a)return this._current.attributes[o];return}const r=this._fieldsIndex.get(e);if(!r)return;const s=this._current.attributes[r.name];return s==null?s:t&&this.fields.isDateField(e)?new Date(s):s}_readAttributes(){return this._current.attributes}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._fieldsIndex=this._fieldsIndex}};var M;let Ot=(M=class{getObjectId(e){return e.getObjectId()}getAttributes(e){return e.readAttributes()}getAttribute(e,t){return e.readAttribute(t)}getAttributeAsTimestamp(e,t){return e.readAttributeAsTimestamp(t)}cloneWithGeometry(e,t){const r=e.readAttributes(),s=new We(t,r,null,e.getObjectId(),e.getDisplayId()),i=Xe.fromOptimizedFeatures([s],e.metadata);return i.setIndex(0),i}getGeometry(e){return e.readGeometryWorldSpace()}getCentroid(e,t){return e.readCentroidForDisplay()}},M.Shared=new M,M),_r=class L{static minimal(e,t,r=[]){return new L({geometryType:e,fieldsIndex:new de(r).toJSON(),featureIdInfo:{type:"object-id",fieldName:t},subtypes:null,subtypeField:null,types:null,globalIdField:null,spatialReference:null,outSpatialReference:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null})}static createFeature(e){return new L(e)}constructor(e){let t;this._options=e,this._fieldsIndex=de.fromJSON(e.fieldsIndex),e.spatialReference&&(e.spatialReference instanceof b?this._spatialReference=e.spatialReference:this._spatialReference=b.fromJSON(e.spatialReference)),e.outSpatialReference&&(e.outSpatialReference instanceof b?this._outSpatialReference=e.outSpatialReference:this._outSpatialReference=b.fromJSON(e.outSpatialReference)),e.featureIdInfo.type==="object-id"&&(t=e.featureIdInfo.fieldName),this._arcadeSchema={fields:this.fieldsIndex.fields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,objectIdField:t,globalIdField:this._options.globalIdField,spatialReference:this._spatialReference,timeInfo:this._options.timeInfo,typeIdField:this._options.typeIdField??void 0,types:this._options.types??void 0,subtypeField:this._options.subtypeField,subtypes:this._options.subtypes??void 0,datesInUnknownTimezone:this._options.timeReferenceUnknownClient??void 0,dateFieldsTimeZone:this._options.dateFieldsTimeZone??void 0}}get fieldsIndex(){return this._fieldsIndex}get geometryType(){return this._options.geometryType==="esriGeometryMultiPatch"?"esriGeometryPolygon":this._options.geometryType}get serviceGeometryType(){return this._options.geometryType}get subtypeField(){return this._options.subtypeField}get timeInfo(){return this._options.timeInfo}get featureIdInfo(){return this._options.featureIdInfo}get globalIdField(){return this._options.globalIdField}get arcadeSchema(){return this._arcadeSchema}get spatialReference(){return this._spatialReference}get outSpatialReference(){return this._outSpatialReference}get timeReferenceUnknownClient(){return this._options.timeReferenceUnknownClient}weakCloneWithAdditionalFields(e){return new L({fieldsIndex:{fields:[...this._fieldsIndex.fields,...e],timeZoneByFieldName:null},geometryType:this.geometryType,globalIdField:this.globalIdField,featureIdInfo:this.featureIdInfo,spatialReference:this.spatialReference,outSpatialReference:this.outSpatialReference,subtypeField:this.subtypeField,subtypes:this._options.subtypes,timeInfo:this.timeInfo,timeReferenceUnknownClient:this.timeReferenceUnknownClient,dateFieldsTimeZone:this._options.dateFieldsTimeZone,typeIdField:this._options.typeIdField,types:this._options.types})}},Oe=class{constructor(e){this._statistics=e}get statistics(){return this._statistics}};const ve=Math.PI/180;let ue=class le{static create(e){return new le(e.map(t=>Gt(t)))}constructor(e){this._statistics=e}static get estimatedMemory(){return $+4*$}values(){return this._statistics.values()}insert(e,t){for(const r of this._statistics)r.insert(e,t)}merge(e){for(let t=0;t<this._statistics.length;t++){const r=this._statistics[t],s=e._statistics[t];if(r.field.name!==s.field.name)throw new Error("InternalError: Tried to merge incompatible statistics");r.merge(s)}}clone(){return new le(this._statistics.map(e=>e.clone()))}};function Gt(n){switch(n.statisticType){case"min":return new Yt(n);case"max":return new jt(n);case"avg":return new Et(n);case"avg_angle":return new Rt(n);case"sum":case"count":return new zt(n);case"mode":return new Lt(n)}}let k=class{constructor(e){this.field=e}insert(e,t){if(!this.field.computed)return;const r=this.field.computed.read(e,t);$e(r)||this._insertValue(r)}},Yt=class Ge extends k{constructor(){super(...arguments),this.type="min",this.value=Number.MAX_VALUE}_insertValue(e){this.value=Math.min(this.value,e)}merge(e){this.value=Math.min(this.value,e.value)}clone(){const e=new Ge(this.field);return e.value=this.value,e}},jt=class Ye extends k{constructor(){super(...arguments),this.type="max",this.value=Number.MIN_VALUE}_insertValue(e){this.value=Math.max(this.value,e)}merge(e){this.value=Math.max(this.value,e.value)}clone(){const e=new Ye(this.field);return e.value=this.value,e}},zt=class je extends k{constructor(){super(...arguments),this.type="sum",this.value=0}_insertValue(e){this.value+=e}merge(e){this.value+=e.value}clone(){const e=new je(this.field);return e.value=this.value,e}},Et=class ze extends k{constructor(){super(...arguments),this.type="avg",this._total=0,this._count=0}get value(){return this._total/this._count}_insertValue(e){this._total+=e,this._count+=1}merge(e){this._total+=e._total,this._count+=e._count}clone(){const e=new ze(this.field);return e._total=this._total,e._count=this._count,e}},Rt=class Ee extends k{constructor(){super(...arguments),this.type="avg_angle",this._x=0,this._y=0,this._count=0}get value(){const e=this._x/this._count,t=this._y/this._count,r=180/Math.PI;return Math.atan2(t,e)*r}_insertValue(e){this._x=this._x+Math.cos(e*ve),this._y=this._y+Math.sin(e*ve),this._count+=1}merge(e){this._x+=e._x,this._y+=e._y,this._count+=e._count}clone(){const e=new Ee(this.field);return e._x=this._x,e._y=this._y,e._count=this._count,e}},Lt=class Re extends k{constructor(){super(...arguments),this._frequencies=new Map}get value(){let e,t=0;for(const[r,s]of this._frequencies.entries())s>t&&(t=s,e=r);return e}_insertValue(e){const t=this._frequencies.get(e);t!=null?this._frequencies.set(e,t+1):this._frequencies.set(e,1)}merge(e){for(const[t,r]of e._frequencies.entries()){const s=this._frequencies.get(t);s!=null?this._frequencies.set(t,s+r):this._frequencies.set(t,r)}}clone(){const e=new Re(this.field);return e._frequencies=new Map(this._frequencies),e}},Te=class U extends Oe{static createId(e,t){return`${e}.${t}`}static create(e,t,r,s){return new U(e,t,ue.create(r),s)}constructor(e,t,r,s){super(r),this.gridX=e,this.gridY=t,this._worldUnitsPerCell=s,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._objectIds=new Set}get id(){return U.createId(this.gridX,this.gridY)}get containedObjectIds(){return this._objectIds}get count(){return this._count}get firstObjectId(){return this._objectIds.values().next().value}get centroidXWorld(){return this._xWorldTotal/this._count}get centroidYWorld(){return this._yWorldTotal/this._count}get usedMemory(){return 48}clone(){const e=new U(this.gridX,this.gridY,this._statistics.clone(),this._worldUnitsPerCell);return e._count=this._count,e._xWorldTotal=this._xWorldTotal,e._yWorldTotal=this._yWorldTotal,e._firstFeatureAttributes=this._firstFeatureAttributes,e._objectIds=new Set(this._objectIds),e}insert(e,t,r,s){this._count===0?this._firstFeatureAttributes=e.readAttributes():this._firstFeatureAttributes=null,this._count+=1,this._xWorldTotal+=r,this._yWorldTotal+=s,this._statistics.insert(e,t),this._objectIds.add(e.getObjectId())}merge(e){if(e._count!==0){this._count+=e._count,this._firstFeatureAttributes=e._firstFeatureAttributes,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(const t of e._objectIds.values())this._objectIds.add(t)}}getCentroidX(e){return e==null?this.centroidXWorld:lt(e,this.centroidXWorld)}getCentroidY(e){return e==null?this.centroidYWorld:ct(e,this.centroidYWorld)}getGeometry(e,t){const r=this.gridX*this._worldUnitsPerCell,s=this.gridY*this._worldUnitsPerCell,i=new g([4],[r,s,r+this._worldUnitsPerCell,s,r+this._worldUnitsPerCell,s+this._worldUnitsPerCell,r,s+this._worldUnitsPerCell]);if(t!=null){const a=new g;return D(a,i,!1,!1,"esriGeometryPolygon",t)}return i}getCentroid(e){const t=new g([],[this.centroidXWorld,this.centroidYWorld]);if(e!=null){const r=new g;return D(r,t,!1,!1,"esriGeometryPoint",e)}return t}getGeometricCentroid(e,t){const r=this.gridX*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,s=this.gridY*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,i=new g([],[r,s]);if(t!=null){const a=new g;return D(a,i,!1,!1,"esriGeometryPoint",t)}return i}getAttributes(){const e={aggregateId:this.id};for(const t of this._statistics.values())e[t.field.name]=t.value;return this._firstFeatureAttributes!=null?{...e,...this._firstFeatureAttributes}:e}};function Ut(n,{timeZone:e,timeExtent:t}){return{$view:{scale:n,timeZone:e,timeProperties:{currentStart:t==null?void 0:t.start,currentEnd:t==null?void 0:t.end}}}}let Le=class{constructor(e){this._options=e}insert(e,t){const r=e.getCursor(),{arcadeContextInfo:s,scale:i}=this._options,a=Ut(i,s);for(;r.next();)this._insertFeature(r,a,this._options.sqlOptions,t)}_insertFeature(e,t,r,s){const{featureFilter:i}=this._options;if(i!==null&&!i.check(e,r))return;let a=0,o=0;if(e.geometryType==="esriGeometryPoint")a=e.readXWorldSpace(),o=e.readYWorldSpace();else{if(s){const d=e.readCentroidForDisplay();if(d==null)return;const[u,l]=d.coords;if(u<0||u>ye||l<0||l>ye)return}const h=e.readCentroidWorldSpace();if(h==null)return;a=h.coords[0],o=h.coords[1]}this._insert(e,a,o,t)}};const Pt=96;function Nt(n,e){return ft(n)*_t*Pt/e}let Zt=class extends Le{constructor(e){super(e),this._cells=new Map,this._pixelsPerMapUnit=Nt(e.spatialReference,e.scale)}get usedMemory(){const e=this._cells.values().next().value;return e?(V+e.usedMemory)*this._cells.size:0}put(e){for(const t of this._cells.values()){const r=e.get(t.id);r?r.merge(t):e.set(t.id,t.clone())}}putBounded(e,t,r){const s=[t.xmin,t.ymin,t.xmax,t.ymax],[i,a,o,h]=s,d=Math.floor(i*this._pixelsPerMapUnit/this._options.cellSize),u=Math.floor(a*this._pixelsPerMapUnit/this._options.cellSize),l=Math.ceil(o*this._pixelsPerMapUnit/this._options.cellSize),f=Math.ceil(h*this._pixelsPerMapUnit/this._options.cellSize);for(let _=u;_<=f;_++)for(let c=d;c<=l;c++){const y=`${c}.${_}`,p=this._cells.get(y);if(!p)continue;const m=e.get(p.id);m?p&&!e.has(p.id)&&m.merge(p):e.set(p.id,p.clone())}}_insert(e,t,r,s){const i=t*this._pixelsPerMapUnit,a=r*this._pixelsPerMapUnit,o=Math.floor(i/this._options.cellSize),h=Math.floor(a/this._options.cellSize);this._getCellOrCreate(o,h).insert(e,s,t,r)}_getCellOrCreate(e,t){const r=Te.createId(e,t);let s=this._cells.get(r);if(!s){const i=1*this._options.cellSize/this._pixelsPerMapUnit;s=Te.create(e,t,this._options.fields,i),this._cells.set(r,s)}return s}};function Z(n,e){if(!(this instanceof Z))return new Z(n,e);this._maxEntries=Math.max(4,n||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&(typeof e=="function"?this.toBBox=e:this._initFormat(e)),this.clear()}function qt(n,e,t){if(!t)return e.indexOf(n);for(var r=0;r<e.length;r++)if(t(n,e[r]))return r;return-1}function w(n,e){W(n,0,n.children.length,e,n)}function W(n,e,t,r,s){s||(s=F(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(var i,a=e;a<t;a++)i=n.children[a],C(s,n.leaf?r(i):i);return s}function C(n,e){return n.minX=Math.min(n.minX,e.minX),n.minY=Math.min(n.minY,e.minY),n.maxX=Math.max(n.maxX,e.maxX),n.maxY=Math.max(n.maxY,e.maxY),n}function Me(n,e){return n.minX-e.minX}function we(n,e){return n.minY-e.minY}function ne(n){return(n.maxX-n.minX)*(n.maxY-n.minY)}function Y(n){return n.maxX-n.minX+(n.maxY-n.minY)}function Jt(n,e){return(Math.max(e.maxX,n.maxX)-Math.min(e.minX,n.minX))*(Math.max(e.maxY,n.maxY)-Math.min(e.minY,n.minY))}function Vt(n,e){var t=Math.max(n.minX,e.minX),r=Math.max(n.minY,e.minY),s=Math.min(n.maxX,e.maxX),i=Math.min(n.maxY,e.maxY);return Math.max(0,s-t)*Math.max(0,i-r)}function ae(n,e){return n.minX<=e.minX&&n.minY<=e.minY&&e.maxX<=n.maxX&&e.maxY<=n.maxY}function j(n,e){return e.minX<=n.maxX&&e.minY<=n.maxY&&e.maxX>=n.minX&&e.maxY>=n.minY}function F(n){return{children:n,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Fe(n,e,t,r,s){for(var i,a=[e,t];a.length;)(t=a.pop())-(e=a.pop())<=r||(i=e+Math.ceil((t-e)/r/2)*r,mt(n,i,e,t,s),a.push(e,i,i,t))}Z.prototype={all:function(){return this._all(this.data,[])},search:function(n){var e=this.data,t=[],r=this.toBBox;if(!j(n,e))return t;for(var s,i,a,o,h=[];e;){for(s=0,i=e.children.length;s<i;s++)a=e.children[s],j(n,o=e.leaf?r(a):a)&&(e.leaf?t.push(a):ae(n,o)?this._all(a,t):h.push(a));e=h.pop()}return t},collides:function(n){var e=this.data,t=this.toBBox;if(!j(n,e))return!1;for(var r,s,i,a,o=[];e;){for(r=0,s=e.children.length;r<s;r++)if(i=e.children[r],j(n,a=e.leaf?t(i):i)){if(e.leaf||ae(n,a))return!0;o.push(i)}e=o.pop()}return!1},load:function(n){if(!n||!n.length)return this;if(n.length<this._minEntries){for(var e=0,t=n.length;e<t;e++)this.insert(n[e]);return this}var r=this._build(n.slice(),0,n.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var s=this.data;this.data=r,r=s}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},insert:function(n){return n!=null&&this._insert(n,this.data.height-1),this},clear:function(){return this.data=F([]),this},remove:function(n,e){if(n==null)return this;for(var t,r,s,i,a=this.data,o=this.toBBox(n),h=[],d=[];a||h.length;){if(a||(a=h.pop(),r=h[h.length-1],t=d.pop(),i=!0),a.leaf&&(s=qt(n,a.children,e))!==-1)return a.children.splice(s,1),h.push(a),this._condense(h),this;i||a.leaf||!ae(a,o)?r?(t++,a=r.children[t],i=!1):a=null:(h.push(a),d.push(t),t=0,r=a,a=a.children[0])}return this},toBBox:function(n){return n},compareMinX:Me,compareMinY:we,toJSON:function(){return this.data},fromJSON:function(n){return this.data=n,this},_all:function(n,e){for(var t=[];n;)n.leaf?e.push.apply(e,n.children):t.push.apply(t,n.children),n=t.pop();return e},_build:function(n,e,t,r){var s,i=t-e+1,a=this._maxEntries;if(i<=a)return w(s=F(n.slice(e,t+1)),this.toBBox),s;r||(r=Math.ceil(Math.log(i)/Math.log(a)),a=Math.ceil(i/Math.pow(a,r-1))),(s=F([])).leaf=!1,s.height=r;var o,h,d,u,l=Math.ceil(i/a),f=l*Math.ceil(Math.sqrt(a));for(Fe(n,e,t,f,this.compareMinX),o=e;o<=t;o+=f)for(Fe(n,o,d=Math.min(o+f-1,t),l,this.compareMinY),h=o;h<=d;h+=l)u=Math.min(h+l-1,d),s.children.push(this._build(n,h,u,r-1));return w(s,this.toBBox),s},_chooseSubtree:function(n,e,t,r){for(var s,i,a,o,h,d,u,l;r.push(e),!e.leaf&&r.length-1!==t;){for(u=l=1/0,s=0,i=e.children.length;s<i;s++)h=ne(a=e.children[s]),(d=Jt(n,a)-h)<l?(l=d,u=h<u?h:u,o=a):d===l&&h<u&&(u=h,o=a);e=o||e.children[0]}return e},_insert:function(n,e,t){var r=this.toBBox,s=t?n:r(n),i=[],a=this._chooseSubtree(s,this.data,e,i);for(a.children.push(n),C(a,s);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(s,i,e)},_split:function(n,e){var t=n[e],r=t.children.length,s=this._minEntries;this._chooseSplitAxis(t,s,r);var i=this._chooseSplitIndex(t,s,r),a=F(t.children.splice(i,t.children.length-i));a.height=t.height,a.leaf=t.leaf,w(t,this.toBBox),w(a,this.toBBox),e?n[e-1].children.push(a):this._splitRoot(t,a)},_splitRoot:function(n,e){this.data=F([n,e]),this.data.height=n.height+1,this.data.leaf=!1,w(this.data,this.toBBox)},_chooseSplitIndex:function(n,e,t){var r,s,i,a,o,h,d,u;for(h=d=1/0,r=e;r<=t-e;r++)a=Vt(s=W(n,0,r,this.toBBox),i=W(n,r,t,this.toBBox)),o=ne(s)+ne(i),a<h?(h=a,u=r,d=o<d?o:d):a===h&&o<d&&(d=o,u=r);return u},_chooseSplitAxis:function(n,e,t){var r=n.leaf?this.compareMinX:Me,s=n.leaf?this.compareMinY:we;this._allDistMargin(n,e,t,r)<this._allDistMargin(n,e,t,s)&&n.children.sort(r)},_allDistMargin:function(n,e,t,r){n.children.sort(r);var s,i,a=this.toBBox,o=W(n,0,e,a),h=W(n,t-e,t,a),d=Y(o)+Y(h);for(s=e;s<t-e;s++)i=n.children[s],C(o,n.leaf?a(i):i),d+=Y(o);for(s=t-e-1;s>=e;s--)i=n.children[s],C(h,n.leaf?a(i):i),d+=Y(h);return d},_adjustParentBBoxes:function(n,e,t){for(var r=t;r>=0;r--)C(e[r],n)},_condense:function(n){for(var e,t=n.length-1;t>=0;t--)n[t].children.length===0?t>0?(e=n[t-1].children).splice(e.indexOf(n[t]),1):this.clear():w(n[t],this.toBBox)},_initFormat:function(n){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(n[0])),this.compareMinY=new Function("a","b",e.join(n[1])),this.toBBox=new Function("a","return {minX: a"+n[0]+", minY: a"+n[1]+", maxX: a"+n[2]+", maxY: a"+n[3]+"};")}};let Qt=class Ue{static fromReader(e){const t=[],r=e.copy(),s=Ce();for(;r.next();)r.getBounds(s)&&t.push(r.getIndex());const i=Z(9,a=>(r.setIndex(a),{minX:r.getBoundsXMin(),minY:r.getBoundsYMin(),maxX:r.getBoundsXMax(),maxY:r.getBoundsYMax()}));return i.load(t),new Ue(i,t.length)}constructor(e,t){this._index=e,this._size=t}get usedMemory(){return this._size*V}search(e){const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}};const Ht=64;function Kt(n,e,t,r){const s=[n.xmin,n.ymin,n.xmax,n.ymax],i=pt.fromExtent(gt(s,r)),a=N(i,r,b.WGS84,{extendedParams:{densificationStep:e*Ht}});if(!a)return null;const o=De(new g,a,!1,!1),h=o.coords.filter((p,m)=>!(m%2)),d=o.coords.filter((p,m)=>m%2),u=Math.min(...h),l=Math.min(...d),f=Math.max(...h),_=Math.max(...d),c=ce(u,l,t,b.WGS84),y=ce(f,_,t,b.WGS84);return c&&y?{bounds:s,geohashBounds:{xLL:c[0],yLL:c[1],xTR:y[0],yTR:y[1]},level:t}:null}function ce(n,e,t,r){if(r.isWebMercator){const a=xe(n/Ie.radius),o=a-360*Math.floor((a+180)/360),h=[0,0];return Se(h,0,xe(Math.PI/2-2*Math.atan(Math.exp(-e/Ie.radius))),o,t),h}const s=N({x:n,y:e},r,b.WGS84);if(!s)return null;const i=[0,0];return Se(i,0,s.y,s.x,t),i}function er(n,e){let t=-90,r=90,s=-180,i=180;for(let a=0;a<e;a++){const o=Math.ceil((a+1)/2),h=Math.floor((a+1)/2),d=1-a%2,u=30-(3*o+2*h),l=30-(2*o+3*h),f=3*d+2*(1-d),_=2*d+3*(1-d),c=3*d+7*(1-d)<<l,y=(7*d+3*(1-d)<<u&n.geohashX)>>u,p=(c&n.geohashY)>>l;for(let m=f-1;m>=0;m--){const I=(s+i)/2,x=y&1<<m?1:0;s=(1-x)*s+x*I,i=(1-x)*I+x*i}for(let m=_-1;m>=0;m--){const I=(t+r)/2,x=p&1<<m?1:0;t=(1-x)*t+x*I,r=(1-x)*I+x*r}}return[s,t,i,r]}function Se(n,e,t,r,s){s%2&&(s+=1);let i=0,a=0,o=-90,h=90,d=-180,u=180;for(let l=0;l<s/2;l++){for(let f=0;f<5;f++){const _=(d+u)/2,c=r>_?1:0;i|=c<<29-(f+5*l),d=(1-c)*d+c*_,u=(1-c)*_+c*u}for(let f=0;f<5;f++){const _=(o+h)/2,c=t>_?1:0;a|=c<<29-(f+5*l),o=(1-c)*o+c*_,h=(1-c)*_+c*h}}n[2*e]=i,n[2*e+1]=a}const ke=32;class S extends Oe{static create(e,t,r,s){const i=ue.create(e),a=new Array(ke);for(let o=0;o<a.length;o++)a[o]=null;return new S(i,t,r,s,a)}constructor(e,t,r,s,i){super(e),this.xNode=t,this.yNode=r,this.depth=s,this.children=i,this._objectIds=new Set,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._xGeohashTotal=0,this._yGeohashTotal=0,this.next=null}static get estimatedMemory(){let e=0;return e+=2*$,e+=V*ke,e+=ue.estimatedMemory,e}get id(){return`${this.xNode}.${this.yNode}`}get containedObjectIds(){return this._objectIds}get count(){return this._count}clone(){const e=new S(this._statistics.clone(),this.xNode,this.yNode,this.depth,this.children);return e._count=this._count,e._xWorldTotal=this._xWorldTotal,e._yWorldTotal=this._yWorldTotal,e._xGeohashTotal=this._xGeohashTotal,e._yGeohashTotal=this._yGeohashTotal,e.next=this.next,e._objectIds=new Set(this._objectIds),e}insert(e,t,r,s,i,a){this._count+=1,this._xWorldTotal+=t,this._yWorldTotal+=r,this._xGeohashTotal+=s,this._yGeohashTotal+=i,this._statistics.insert(e,a),this._objectIds.add(e.getObjectId())}merge(e){if(e._count!==0){this._count+=e._count,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._xGeohashTotal+=e._xWorldTotal,this._yGeohashTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(const t of e._objectIds.values())this._objectIds.add(t)}}getCentroid(e){throw new Error("getCentroid not supported for GeohashNode")}getGeometry(e,t){const r=this._getLngLatBounds(),[s,i,a,o]=r,h=N({rings:[[[s,i],[s,o],[a,o],[a,i],[s,i]]]},b.WGS84,e),d=De(new g,h,!1,!1);return t!=null?D(new g,d,!1,!1,"esriGeometryPolygon",t,!1,!1):d}getGeometricCentroid(e,t){const r=this._getLngLatBounds(),[s,i,a,o]=r,h=N({x:(s+a)/2,y:(i+o)/2},b.WGS84,e),d=yt(new g,h);return t!=null?D(new g,d,!1,!1,"esriGeometryPoint",t,!1,!1):d}getAttributes(){const e={aggregateId:this.id};for(const t of this._statistics.values())e[t.field.name]=t.value;return e.aggregateCount=this._count,e}find(e,t,r,s,i,a){if(s>=r)return this;const o=1-s%2,h=3*o+2*(1-o),d=2*o+3*(1-o),u=30-i-h,l=30-a-d,f=((e&7*o+3*(1-o)<<u)>>u)+((t&3*o+7*(1-o)<<l)>>l)*(8*o+4*(1-o)),_=this.children[f];return _==null?null:_.find(e,t,r,s+1,i+h,a+d)}_getLngLatBounds(){const e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2),s=30-(3*t+2*r),i=30-(2*t+3*r),a=this.xNode<<s,o=this.yNode<<i;return er({geohashX:a,geohashY:o},this.depth)}}class tr{constructor(e){this._fields=e,this._size=0,this._depth=0,this._root=S.create(this._fields,0,0,0)}destroy(){}get size(){return this._size}get depth(){return this._depth}get usedMemory(){return this._size*S.estimatedMemory}find(e,t,r){return this._root.find(e,t,r,0,0,0)}insert(e,t,r,s,i,a,o){let h=this._root,d=0,u=0,l=0;for(;h!==null;){if(h.insert(e,t,r,s,i,o),d>=a)return;const f=Math.ceil((d+1)/2),_=Math.floor((d+1)/2),c=1-d%2,y=30-(3*f+2*_),p=30-(2*f+3*_),m=(s&7*c+3*(1-c)<<y)>>y,I=(i&3*c+7*(1-c)<<p)>>p,x=m+I*(8*c+4*(1-c));u=u<<3*c+2*(1-c)|m,l=l<<2*c+3*(1-c)|I,h.children[x]==null&&(h.children[x]=S.create(this._fields,u,l,d+1),this._depth=Math.max(this._depth,d+1),this._size+=1),d+=1,h=h.children[x]}}putBins(e,t){for(const r of this.getNodes(t)){const s=e.get(r.id);s?s.merge(r):e.set(r.id,r.clone())}}getNodes(e){const t=[],{geohashBounds:r,level:s}=e;let i=this._root;for(;i!==null;){const a=i.depth,o=i.xNode,h=i.yNode;if(a>=s){t.push(i),i=i.next;continue}const d=Math.ceil((a+1)/2),u=Math.floor((a+1)/2),l=1-a%2,f=30-(3*d+2*u),_=30-(2*d+3*u),c=~((1<<f)-1),y=~((1<<_)-1),p=(r.xLL&c)>>f,m=(r.yLL&y)>>_,I=(r.xTR&c)>>f,x=(r.yTR&y)>>_,H=o<<3*l+2*(1-l),K=h<<2*l+3*(1-l),qe=H+8*l+4*(1-l),Je=K+4*l+8*(1-l),Ve=Math.max(H,p),Qe=Math.max(K,m),He=Math.min(qe,I),Ke=Math.min(Je,x);let X=null,ee=null;for(let te=Qe;te<=Ke;te++)for(let re=Ve;re<=He;re++){const et=re-H+(te-K)*(8*l+4*(1-l)),A=i.children[et];A&&(X||(X=A,X.next=i.next),ee&&(ee.next=A),ee=A,A.next=i.next)}i=X||i.next}return t}}let rr=class extends Le{constructor(e){super(e),this._tree=new tr(this._options.fields)}get usedMemory(){return this._tree.usedMemory}put(e){throw new Error("Geohash tree does not support put")}putBounded(e,t,r){const{geohashLevel:s,spatialReference:i}=this._options,a=Kt(t,r,s,i);a!=null&&this._tree.putBins(e,a)}_insert(e,t,r,s){const{geohashLevel:i,spatialReference:a}=this._options,o=ce(t,r,i,a);o&&this._tree.insert(e,t,r,o[0],o[1],i,s)}},sr=class P extends _e{static from(e,t){if(e instanceof this){const r=new Set(t),s=e._indices.filter(i=>r.has(i));return new P(e._reader,s)}return new P(e.copy(),t)}constructor(e,t){super(e.metadata),this._currentIndex=-1,this._displayTransform=null,this._reader=e,this._indices=t}setTransformForDisplay(e){const t=this._reader.getInTransform();if(t==null)return void(this._displayTransform=ie(e));const r=ie(t),s=ie(e),[i,a]=r.scale,[o,h]=r.translate,[d,u]=s.scale,[l,f]=s.translate,_=i/d,c=a/u,y=(o-l)/d,p=(h-f)/u;this._displayTransform={originPosition:"lowerLeft",scale:[1/_,1/c,1,1],translate:[-y/_,-p/c,0,0]}}getInTransform(){return this._reader.getInTransform()}get fields(){return this._reader.fields}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const e=new P(this._reader.copy(),this._indices);return e._currentIndex=this._currentIndex,e._displayTransform=this._displayTransform,e._processorAttributes=this._processorAttributes,e}get contextTimeZone(){return this._reader.contextTimeZone}set contextTimeZone(e){this._reader.contextTimeZone=e}get usedMemory(){return $+this._reader.usedMemory}setProcessorAttributes(e){this._processorAttributes=Object.assign(this._processorAttributes??{},e)}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}readXForDisplay(){return this._displayTransform?oe(this._displayTransform,this._reader.readXForDisplay()):this._reader.readXForDisplay()}readYForDisplay(){return this._displayTransform?he(this._displayTransform,this._reader.readYForDisplay()):this._reader.readYForDisplay()}readGeometryForDisplay(){return this._displayTransform?this._reader.readGeometryForDisplayTransformed(this._displayTransform):this._reader.readGeometryForDisplay()}readCentroidForDisplay(){var t;const e=(t=this._reader.readCentroidForDisplay())==null?void 0:t.clone();if(e){const[r,s]=e.coords;this._displayTransform?(e.coords[0]=oe(this._displayTransform,r),e.coords[1]=he(this._displayTransform,s)):(e.coords[0]=r,e.coords[1]=s)}return e}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}readAttribute(e,t=!1){const r=this._reader.readAttribute(e,t);return r==null&&this._processorAttributes?this._processorAttributes[e]:r}readAttributes(){return{...this._processorAttributes,...this._reader.readAttributes()}}joinAttributes(e){return this._reader.joinAttributes(e)}getBounds(e){return this._reader.getBounds(e)}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(e){return this._reader.setDisplayId(e)}setIndex(e){return this._reader.setIndex(e)}getIndex(){return this._reader.getIndex()}readXWorldSpace(){return this._reader.readXWorldSpace()}readYWorldSpace(){return this._reader.readYWorldSpace()}_readX(){return this._reader.readXForDisplay()}_readY(){return this._reader.readYForDisplay()}_readServerCentroid(){return this._reader._readServerCentroid()}readLegacyFeatureForDisplay(){const e=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyGeometryForDisplay(){const e=this.readGeometryForDisplay();return E(e,this.geometryType,!1,!1)}readGeometryArea(){var e;return this._displayTransform?((e=this._reader.readGeometryForDisplayTransformed(this._displayTransform))==null?void 0:e.area())??0:this._reader.readGeometryArea()}readGeometryWorldSpace(){return this._reader.readGeometryWorldSpace()}_readGeometry(){return this._reader._readGeometry()}_readAttribute(e,t){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(e){return this._reader.field(e)}hasField(e){return this._reader.hasField(e)}setField(e,t){return this._reader.setField(e,t)}keys(){return this._reader.keys()}castToText(e=!1){return this._reader.castToText(e)}},Pe=class{size(){return this.reader.getSize()}get fields(){return this.reader.fields}invalidate(){this._aggregateIndex=null,this._aggregateIndexHash=null,this._spatialIndex=null}get usedMemory(){let e=0;return e+=this.reader.underlyingMemory,this._aggregateIndex&&(e+=this._aggregateIndex.usedMemory),this._spatialIndex&&(e+=this._spatialIndex.usedMemory),e}registerOverrides(e){this.reader.registerOverrides(e),this.invalidate()}queryFeaturesInBounds(e){const t=this._getSpatialIndex().search(e);return sr.from(this.reader,t)}getAggregateIndex(e){const t=JSON.stringify(e);if(t!==this._aggregateIndexHash){switch(this._aggregateIndexHash=t,e.type){case"grid":this._aggregateIndex=new Zt(e);break;case"geohash":this._aggregateIndex=new rr(e)}this._aggregateIndex.insert(this.reader,this.isTiled)}return this._aggregateIndex}_getSpatialIndex(){return this._spatialIndex||(this._spatialIndex=Qt.fromReader(this.reader)),this._spatialIndex}};const Ae=1e4,ir=1e3;class q{static async create(e){const{metadata:t,definitionExpression:r}=e,s=r?await xt(r,t.fieldsIndex):null;return new q(t,s,r)}constructor(e,t,r){this.metadata=e,this._clause=t,this._definitionExpression=r}get hash(){return this._definitionExpression}testFeature(e){return this._clause==null||this._clause.testFeature(e)}}class J{constructor(){this.modified=new Map,this.removed=new Set}modify(e){this.modified.set(e.objectId,e),this.removed.has(e.objectId)&&this.removed.delete(e.objectId)}remove(e){this.modified.delete(e),this.removed.add(e)}get isEmpty(){return this.modified.size===0&&this.removed.size===0}applyWhereClause(e){const t=new J;for(const[r,s]of this.modified)e.testFeature(s)?t.modified.set(r,s):t.removed.add(s.objectId);for(const r of this.removed)t.removed.add(r);return t}}let nr=class Ne extends Pe{constructor(e){super(),this._reader=e,this.chunkId="override",this.normalizedChunkId="override"}static fromFeatures(e,t){const r=Xe.fromOptimizedFeatures(e,t);return new Ne(r)}get reader(){return this._reader}get queryInfo(){return{}}get first(){return!1}get end(){return!1}get isTiled(){return!1}getTileReader(e){if(!this._reader.getSize())return null;const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}};class z{constructor(e,t){this.inner=e,this.isWeak=t,this.lastWeak=null}get isStrong(){return!this.isWeak}}class ar{constructor(e){this._parameters=e,this._overrides=new Map,this._update=new J,this._lastCleanup=0}update(e){this._parameters=e}hasOverride(e){return this._overrides.has(e)}onChunkInsert(e){var t;if(this._overrides.size){const r=e.reader.getCursor();for(;r.next();){const s=r.getObjectId(),i=this._overrides.get(s);if(i!=null&&i.lastWeak&&(i.lastWeak=null),i==null?void 0:i.isWeak){const a=r.readOptimizedFeatureWorldSpace(),o=((t=i.inner)==null?void 0:t.attributes)??{};a.attributes={...o,...a.attributes},i.inner=a,this._update.modify(a),this.invalidate()}}}e.registerOverrides(this)}apply(e,t){const{updateWeak:r,removeWeak:s,update:i,remove:a,release:o}=e.commands;this.invalidate();for(const h of r){const d=new z(h,!0),u=this._overrides.get(h.objectId);u!=null&&u.isStrong?u.lastWeak=d:(this._overrides.set(h.objectId,d),this._update.modify(h))}for(const h of i){const d=new z(h,!1),u=this._overrides.get(h.objectId);d.lastWeak=u!=null&&u.isWeak?u:(u==null?void 0:u.lastWeak)??null,this._overrides.set(h.objectId,d),this._update.modify(h)}for(const h of s){const d=new z(null,!0),u=this._overrides.get(h);u!=null&&u.isStrong?u.lastWeak=d:(this._overrides.set(h,d),this._update.remove(h))}for(const h of a){const d=new z(null,!1),u=this._overrides.get(h);d.lastWeak=u!=null&&u.isWeak?u:(u==null?void 0:u.lastWeak)??null,this._overrides.set(h,d),this._update.remove(h)}if(o.length){const h=new Set;for(const d of o){const u=this._overrides.get(d);u!=null&&u.lastWeak?(this._overrides.set(d,u.lastWeak),u.lastWeak.inner==null?this._update.remove(d):this._update.modify(u.lastWeak.inner)):u&&!u.isWeak&&(this._overrides.delete(d),h.add(d))}t.forEachUnsafe(d=>{const u=d.getObjectId();h.has(u)&&(this._update.modify(d.readOptimizedFeatureWorldSpace()),h.delete(u))});for(const d of h.values())this._update.remove(d)}}clearWeakOverrides(){for(const[e,t]of this._overrides.entries())t.isWeak&&this._overrides.delete(e);this.invalidate()}cleanup(e){if(this._overrides.size<Ae)return;const t=performance.now();if(t-this._lastCleanup<ir)return;this._lastCleanup=t;const r=this._getWeakDeletions();if(!(r.size<Ae)){for(const s of e){const i=s.reader.withoutOverrides().getCursor();for(;i.next();){const a=i.getObjectId();r.delete(a)}}for(const s of r)this._overrides.delete(s);r.size&&this.invalidate()}}takeOverrideUpdate(){const e=this._update;return e.isEmpty?null:(this._update=new J,e.applyWhereClause(this._parameters))}asChunk(){const e=this._parameters;if(this._lastOverrideParametersHash!==e.hash&&(this._lastOverrideParametersHash=e.hash,this._chunk=null),!this._chunk){const t=[];for(const r of this._overrides.values())r.inner!=null&&e.testFeature(r.inner)&&t.push(r.inner);this._chunk=nr.fromFeatures(t,e.metadata)}return this._chunk}invalidate(){this._chunk=null}putWeakObjectIdsFromGlobalIds(e,t,r){for(const[s,i]of this._overrides.entries()){if(i.isWeak&&i.inner!=null){const a=i.inner.attributes[r];a&&t.has(a)&&!e.has(a)&&e.set(a,s);continue}if(i.lastWeak!=null&&i.lastWeak.inner!=null){const a=i.lastWeak.inner.attributes[r];a&&t.has(a)&&!e.has(a)&&e.set(a,s)}}}_getWeakDeletions(){const e=new Set;for(const[t,r]of this._overrides.entries())r.isWeak&&r.inner==null&&e.add(t);return e}}class br extends Pe{constructor(e,t,r,s,i=0){super(),this._reader=e,this._queryJSON=t,this._page=r,this._end=s,this._fileIndex=i,this.chunkId=`${this._fileIndex}.${this._page}${this.end?"e":""}`,this.normalizedChunkId=this.chunkId}get reader(){return this._reader}get first(){return this._page===0}get end(){return this._end}get queryInfo(){return{type:"snapshot",chunkId:this.chunkId,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}}let B;class Ze extends _e{constructor(e,t,r,s,i,a=new Uint32Array(r.size())){super(e),this._fields=t,this._inner=r,this._chunkId=s,this._fileIndex=i,this._displayIds=a,this._index=-1,this.usedMemory=$,this._size=this._inner.size(),e.featureIdInfo.type,this._chunkId>65535&&console.error("Exceeded max allowed parquet reader size")}destroy(){super.destroy(),this._inner.free()}get fields(){return this._fields}get geometryType(){return this.metadata.geometryType}get hasFeatures(){return!0}get hasNext(){throw new Error("Method not implemented.")}get exceededTransferLimit(){return!1}get hasZ(){return!1}get hasM(){return!1}getInTransform(){return null}getSize(){return this._size}getCursor(){return this.copy()}getAttributeHash(){let e="";for(const t of this.fields.fields)e+=this._readAttribute(t.name,!1)+".";return e}getObjectId(){return this._fileIndex<<24|this._inner.rowId(this._index)}getDisplayId(){return this._displayIds[this._index]}setDisplayId(e){this._displayIds[this._index]=e}setIndex(e){this._index=e}getBoundsXMin(){return this._inner.boundsXMin(this._index)}getBoundsYMin(){return this._inner.boundsYMin(this._index)}getBoundsXMax(){return this._inner.boundsXMax(this._index)}getBoundsYMax(){return this._inner.boundsYMax(this._index)}setBoundsXMin(e){throw new Error("InternalError: Setting bounds is unsupported")}setBoundsYMin(e){throw new Error("InternalError: Setting bounds is unsupported")}setBoundsXMax(e){throw new Error("InternalError: Setting bounds is unsupported")}setBoundsYMax(e){throw new Error("InternalError: Setting bounds is unsupported")}getIndex(){return this._index}next(){for(;++this._index<this._size&&!this._getExists(););return this._index<this._size}readGeometryArea(){var e;return((e=this.readGeometryForDisplay())==null?void 0:e.area())??0}copy(){const e=new Ze(this.metadata,this._fields,this._inner,this._chunkId,this._fileIndex,this._displayIds);return this.copyInto(e),e}copyInto(e){super.copyInto(e),e._index=this._index}readGeometryForDisplayTransformed(e){const[t,r]=e.translate,[s,i]=e.scale;return B||(B=bt.new()),this._inner.transformGeometry(B,t,r,s,i,this._index)?new g(B.readLengthsUnsafe(),B.readCoordsUnsafe()):null}_readGeometry(e){const t=this._inner.readCoords(this._index),r=this._inner.readLengths(this._index);return t&&r?new g(r,t):null}_readX(){return this._inner.readX(this._index)}_readY(){return this._inner.readY(this._index)}_readServerCentroid(){return null}_readAttribute(e,t){const r=this.fields.get(e);if(!r)return;if(r.column==null)return this.getObjectId();const s=this._inner.readAttribute(this._index,r.column);if(s==null)return s;const i=this.fields.isDateField(r.name);return t?s==null?s:i?new Date(s):s:s}_readAttributes(){const e={};for(const t of this._fields.fields)t.column!=null&&(this._inner.isEmpty(t.column)||(e[t.name]=this._readAttribute(t.name,!1)));return e.__OBJECTID=this.getObjectId(),e}}class vr{constructor(){this._chunks=new Map,this._chunksToRemove=[],this.events=new It,this.featureAdapter=new Ot}destroy(){this.clear()}clear(){var e;for(const t of this._chunks.values())this._chunksToRemove.push(t);this._chunks.clear(),(e=this._overrides)==null||e.clearWeakOverrides()}get usedMemory(){let e=0;for(const t of this._chunks.values())e+=t.usedMemory;return e}async update(e){if(this._overrides){const t=await q.create(e);this._overrides.update(t)}this._schema=e}*chunks(){this._overrides&&(yield this._overrides.asChunk()),yield*this._chunks.values()}insert(e){var t;T("esri-2d-update-debug")&&console.debug(`Chunk[${e.chunkId}] SourceChunkStore.insert`),(t=this._overrides)==null||t.onChunkInsert(e),this._chunks.set(e.chunkId,e),this.events.emit("changed")}remove(e){T("esri-2d-update-debug")&&console.debug(`Chunk[${e.chunkId}] SourceChunkStore.remove`),this._chunks.delete(e.chunkId),this._chunksToRemove.push(e)}removeById(e){T("esri-2d-update-debug")&&console.debug(`Chunk[${e}] SourceChunkStore.remove`);const t=this._chunks.get(e);this._chunks.delete(e),t&&this._chunksToRemove.push(t)}cleanup(){var t;const e=this._chunksToRemove;return this._chunksToRemove=[],(t=this._overrides)==null||t.cleanup(this._chunks.values()),e}async applyOverride(e){if(this._overrides==null){const t=await q.create(this._schema);this._overrides=new ar(t);for(const r of this._chunks.values())this._overrides.onChunkInsert(r)}this._overrides.apply(e,this),this.events.emit("changed");for(const t of this._chunks.values())t.invalidate()}takeOverrideUpdate(){var e;return(e=this._overrides)==null?void 0:e.takeOverrideUpdate()}refresh(){this.events.emit("refresh")}forEach(e){const t=new Set;for(const r of this.chunks()){const s=r.reader.getCursor();for(;s.next();){const i=s.getObjectId();t.has(i)||(e(s.copy()),t.add(i))}}}forEachUnsafe(e){const t=new Set;for(const r of this.chunks()){const s=r.reader.getCursor();for(;s.next();){const i=s.getObjectId();t.has(i)||(e(s),t.add(i))}}}mapObjectIdsFromGlobalIds(e,t){var i;const r=new Map,s=new Set(e);return(i=this._overrides)==null||i.putWeakObjectIdsFromGlobalIds(r,s,t),this._forEachUnsafeIgnoreOverrides(a=>{const o=a.readAttribute(t);if(o&&s.has(o)&&!r.has(o)){const h=a.getObjectId();r.set(o,h)}}),r}forEachInBounds(e,t){const r=new Set;for(const s of this.chunks()){const i=s.queryFeaturesInBounds(e);for(;i.next();){const a=i.getObjectId();r.has(a)||(t(i.copy()),r.add(a))}}}forEachBounds(e,t){const r=Ce();for(const s of e)s.getBounds(r)&&t(r)}_forEachUnsafeIgnoreOverrides(e){const t=new Set;for(const r of this._chunks.values()){const s=r.reader.withoutOverrides().getCursor();for(;s.next();){const i=s.getObjectId();t.has(i)||(e(s),t.add(i))}}}}export{_e as O,Ze as a,lr as b,cr as c,$e as d,Mt as e,Nt as f,Ut as g,nr as h,_r as i,sr as j,ue as k,Te as l,wt as m,vr as n,Pe as o,Ot as r,br as t,Xe as u};
