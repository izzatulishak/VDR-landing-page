const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BiSWWdHA.js","assets/index-CUvnBExu.css"])))=>i.map(i=>d[i]);
import{g6 as X,hZ as Y,hY as ee,cd as T,aH as Q,gX as te,_ as n,m as p,aM as re,aN as ie,bx as B,$ as J,aL as se,O as ae,aQ as oe,b as N,w as q,nU as ne,bw as le,br as pe,av as ue,gW as he,gV as ye,ce,q as z,el as de,c2 as fe,s as L,hk as A,c as me,x as ge,fQ as we,cS as be,l as ve,qL as U,mM as xe,bF as M,qM as $e,bB as _e,ek as D,b5 as Se,oJ as Ve,e as Fe,g as Pe,K as Ge,a as He,N as Oe}from"./index-BiSWWdHA.js";import{w as Ee}from"./ImageHighlightHelper3D-il7lCjEH.js";import{n as R}from"./floorFilterUtils-DZ5C6FQv.js";import{e as Ne}from"./sublayerUtils-CLrdRyiA.js";import{p as je,n as Ie}from"./popupUtils-CqQiS61M.js";function Re(t,e){const{dpi:r,gdbVersion:a,geometry:i,geometryPrecision:o,height:s,historicMoment:c,layerOption:y,mapExtent:l,maxAllowableOffset:u,returnFieldName:h,returnGeometry:m,returnUnformattedValues:x,returnZ:_,spatialReference:P,timeExtent:f,tolerance:F,width:b}=t.toJSON(),{dynamicLayers:w,layerDefs:v,layerIds:H}=Le(t),G=(e==null?void 0:e.geometry)!=null?e.geometry:null,g={historicMoment:c,geometryPrecision:o,maxAllowableOffset:u,returnFieldName:h,returnGeometry:m,returnUnformattedValues:x,returnZ:_,tolerance:F},$=(G==null?void 0:G.toJSON())||i;g.imageDisplay=`${b},${s},${r}`,a&&(g.gdbVersion=a),$&&(delete $.spatialReference,g.geometry=JSON.stringify($),g.geometryType=X($));const E=P??($==null?void 0:$.spatialReference)??(l==null?void 0:l.spatialReference);if(E&&(g.sr=Y(E)),g.time=f?[f.start,f.end].join(","):null,l){const{xmin:C,ymin:Z,xmax:W,ymax:K}=l;g.mapExtent=`${C},${Z},${W},${K}`}return v&&(g.layerDefs=v),w&&!v&&(g.dynamicLayers=w),g.layers=y==="popup"?"visible":y,H&&!w&&(g.layers+=`:${H.join(",")}`),g}function Le(t){var _,P;const{mapExtent:e,floors:r,width:a,sublayers:i,layerIds:o,layerOption:s,gdbVersion:c}=t,y=(P=(_=i==null?void 0:i.find(f=>f.layer!=null))==null?void 0:_.layer)==null?void 0:P.serviceSublayers,l=s==="popup",u={},h=ee({extent:e,width:a,spatialReference:e==null?void 0:e.spatialReference}),m=[],x=f=>{const F=h===0,b=f.minScale===0||h<=f.minScale,w=f.maxScale===0||h>=f.maxScale;if(f.visible&&(F||b&&w))if(f.sublayers)f.sublayers.forEach(x);else{if((o==null?void 0:o.includes(f.id))===!1||l&&(!f.popupTemplate||!f.popupEnabled))return;m.unshift(f)}};if(i==null||i.forEach(x),i&&!m.length)u.layerIds=[];else{const f=Ne(m,y,c),F=m.map(b=>{const w=R(r,b);return b.toExportImageJSON(w)});if(f)u.dynamicLayers=JSON.stringify(F);else{if(i){let w=m.map(({id:v})=>v);o&&(w=w.filter(v=>o.includes(v))),u.layerIds=w}else o!=null&&o.length&&(u.layerIds=o);const b=Ae(r,m);if(b!=null&&b.length){const w={};for(const v of b)v.definitionExpression&&(w[v.id]=v.definitionExpression);Object.keys(w).length&&(u.layerDefs=JSON.stringify(w))}}}return u}function Ae(t,e){const r=!!(t!=null&&t.length),a=e.filter(i=>i.definitionExpression!=null||r&&i.floorInfo!=null);return a.length?a.map(i=>{const o=R(t,i),s=T(o,i.definitionExpression);return{id:i.id,definitionExpression:s??void 0}}):null}var I;let d=I=class extends Q{static from(t){return te(I,t)}constructor(t){super(t),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(t,e){e.historicMoment=t&&t.getTime()}};n([p({type:Number,json:{write:!0}})],d.prototype,"dpi",void 0),n([p()],d.prototype,"floors",void 0),n([p({type:String,json:{write:!0}})],d.prototype,"gdbVersion",void 0),n([p({types:ie,json:{read:re,write:!0}})],d.prototype,"geometry",void 0),n([p({type:Number,json:{write:!0}})],d.prototype,"geometryPrecision",void 0),n([p({type:Number,json:{write:!0}})],d.prototype,"height",void 0),n([p({type:Date})],d.prototype,"historicMoment",void 0),n([B("historicMoment")],d.prototype,"writeHistoricMoment",null),n([p({type:[Number],json:{write:!0}})],d.prototype,"layerIds",void 0),n([p({type:["top","visible","all","popup"],json:{write:!0}})],d.prototype,"layerOption",void 0),n([p({type:J,json:{write:!0}})],d.prototype,"mapExtent",void 0),n([p({type:Number,json:{write:!0}})],d.prototype,"maxAllowableOffset",void 0),n([p({type:Boolean,json:{write:!0}})],d.prototype,"returnFieldName",void 0),n([p({type:Boolean,json:{write:!0}})],d.prototype,"returnGeometry",void 0),n([p({type:Boolean,json:{write:!0}})],d.prototype,"returnM",void 0),n([p({type:Boolean,json:{write:!0}})],d.prototype,"returnUnformattedValues",void 0),n([p({type:Boolean,json:{write:!0}})],d.prototype,"returnZ",void 0),n([p({type:se,json:{write:!0}})],d.prototype,"spatialReference",void 0),n([p({type:ae})],d.prototype,"sublayers",void 0),n([p({type:oe,json:{write:!0}})],d.prototype,"timeExtent",void 0),n([p({type:Number,json:{write:!0}})],d.prototype,"tolerance",void 0),n([p({type:Number,json:{write:!0}})],d.prototype,"width",void 0),d=I=n([N("esri.rest.support.IdentifyParameters")],d);const k=d;let S=class extends Q{constructor(t){super(t),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(t,e){return q.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(t,e){if(!t)return;const{attributes:r,geometry:a}=t;r&&(e.attributes={...r}),a!=null&&(e.geometry=a.toJSON(),e.geometryType=ne.toJSON(a.type))}};n([p({type:String,json:{write:!0}})],S.prototype,"displayFieldName",void 0),n([p({type:q})],S.prototype,"feature",void 0),n([le("feature",["attributes","geometry"])],S.prototype,"readFeature",null),n([B("feature")],S.prototype,"writeFeature",null),n([p({type:Number,json:{write:!0}})],S.prototype,"layerId",void 0),n([p({type:String,json:{write:!0}})],S.prototype,"layerName",void 0),S=n([N("esri.rest.support.IdentifyResult")],S);const Ue=S;async function Me(t,e,r){const a=(e=Qe(e)).geometry?[e.geometry]:[],i=pe(t);return i.path+="/identify",ue(a).then(o=>{const s=Re(e,{geometry:o==null?void 0:o[0]}),c=he({...i.query,f:"json",...s}),y=ye(c,r);return ce(i.path,y).then(Te).then(l=>Be(l,e.sublayers))})}function Te(t){const e=t.data;return e.results=e.results||[],e.exceededTransferLimit=!!e.exceededTransferLimit,e.results=e.results.map(r=>Ue.fromJSON(r)),e}function Qe(t){return t=k.from(t)}function Be(t,e){if(!(e!=null&&e.length))return t;const r=new Map;function a(i){r.set(i.id,i),i.sublayers&&i.sublayers.forEach(a)}e.forEach(a);for(const i of t.results)i.feature.sourceLayer=r.get(i.layerId);return t}let j=null;function Xe(t,e){return e.type==="tile"||e.type==="map-image"}let V=class extends z{constructor(t){super(t),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=de(async e=>{this.destroyed||await this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))})}initialize(){const t=e=>{var r;for(const a of e){const{sourceLayer:i}=a;i!=null&&"geometryType"in i&&i.geometryType==="point"&&a.visible&&(a.visible=!1,(r=this.highlightGraphicUpdated)==null||r.call(this,{graphic:a,property:"visible",oldValue:!0,newValue:!1}))}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch(()=>{})),D(this.updateHighlightedFeatures(this._highlightGeometriesResolution))};this.addHandles([fe(()=>this.highlightGraphics,"change",e=>t(e.added),{onListenerAdd:e=>t(e)})])}async fetchPopupFeaturesAtLocation(t,e){var s,c;const{layerView:{layer:r,view:{scale:a}}}=this;if(!t)throw new L("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:r});const i=Je(r.sublayers,a,e);if(!i.length)return[];const o=await ze(r,i);if(!((((c=(s=r.capabilities)==null?void 0:s.operations)==null?void 0:c.supportsIdentify)??!0)&&r.version>=10.5)&&!o)throw new L("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:r});return o?this._fetchPopupFeaturesUsingQueries(t,i,e):this._fetchPopupFeaturesUsingIdentify(t,i,e)}clearHighlights(){var t;(t=this.highlightGraphics)==null||t.removeAll()}async _updateHighlightedFeaturesSymbols(t){for(const e of t)this._updateSymbology(e)}_updateSymbology(t){var e;if(((e=t.geometry)==null?void 0:e.type)==="point")return this._updatePointSymbology(t)}_setGraphicSymbol(t,e){var a;if(!e)return;const r=t.symbol;t.symbol=e,(a=this.highlightGraphicUpdated)==null||a.call(this,{graphic:t,property:"symbol",oldValue:r,newValue:e})}_updatePointSymbology(t){const e=t.sourceLayer&&"renderer"in t.sourceLayer&&t.sourceLayer.renderer,{highlightGraphicUpdated:r,highlightGraphics:a,layerView:{view:i}}=this,o=s=>{s.visible||(s.visible=!0,r==null||r({graphic:s,property:"visible",oldValue:!1,newValue:!0}))};e&&"getSymbolAsync"in e?e.getSymbolAsync(t).then(async s=>{var l;s||(s=new A);let c=null;const y="visualVariables"in e?(l=e.visualVariables)==null?void 0:l.find(u=>u.type==="size"):void 0;y&&(j||(j=(await me(async()=>{const{getSize:u}=await import("./index-BiSWWdHA.js").then(h=>h.E5);return{getSize:u}},__vite__mapDeps([0,1]))).getSize),c=j(y,t,{view:i.type,scale:i.scale,shape:s.type==="simple-marker"?s.style:null})),c||(c="width"in s&&"height"in s&&s.width!=null&&s.height!=null?Math.max(s.width,s.height):"size"in s?s.size:16),a!=null&&a.includes(t)&&(this._setGraphicSymbol(t,new A({style:"square",size:c,color:new ge([255,255,255,1/255]),xoffset:"xoffset"in s?s.xoffset:0,yoffset:"yoffset"in s?s.yoffset:0})),o(t))}):o(t)}get _updateContext(){const{layerView:{layer:t},highlightGraphics:e,highlightGraphicUpdated:r}=this;return r&&(e!=null&&e.length)&&t.capabilities.operations.supportsQuery?{highlightGraphicUpdated:r,highlightGraphics:e}:null}get highlightFeaturesActive(){return!!this._updateContext}async _updateHighlightedFeaturesGeometries(t){this._highlightGeometriesResolution=t;const e=this._updateContext;if(!e)return;const r=this._getTargetResolution(t),a=new Map,{highlightGraphics:i,highlightGraphicUpdated:o}=e;for(const l of i)if(!this._featuresResolutions.has(l)||this._featuresResolutions.get(l)>r){const u=l.sourceLayer;we(a,u,()=>new Map).set(l.getObjectId(),l)}const{layerView:{view:s}}=this,c=Array.from(a,([l,u])=>{const h=l.createQuery();return h.objectIds=[...u.keys()],h.outFields=[l.objectIdField],h.returnGeometry=!0,h.maxAllowableOffset=r,h.outSpatialReference=s.spatialReference,l.queryFeatures(h)}),y=await Promise.all(c);if(!this.destroyed)for(const{features:l}of y)for(const u of l){const h=u.sourceLayer,m=a.get(h).get(u.getObjectId());if(m&&i.includes(m)){const x=m.geometry;m.geometry=u.geometry,o({graphic:m,property:"geometry",oldValue:x,newValue:m.geometry}),this._featuresResolutions.set(m,r)}}}_getTargetResolution(t){const e=t*be(this.layerView.view.spatialReference),r=e/16;return r<=10?0:t/e*r}async _fetchPopupFeaturesUsingIdentify(t,e,r){const a=await this._createIdentifyParameters(t,e,r);if(a==null)return[];const{results:i}=await Me(this.layerView.layer.parsedUrl,a,r);return i.map(o=>o.feature)}async _createIdentifyParameters(t,e,r){const{floors:a,layer:i,timeExtent:o,view:{spatialReference:s,scale:c}}=this.layerView;if(!e.length)return null;await Promise.all(e.map(({sublayer:x})=>x.load(r).catch(()=>{})));const y=Math.min(ve("mapservice-popup-identify-max-tolerance"),i.allSublayers.reduce((x,_)=>_.renderer?U({renderer:_.renderer,pointerType:r==null?void 0:r.pointerType}):x,2)),l=this.createFetchPopupFeaturesQueryGeometry(t,y),u=xe(c,s),h=Math.round(l.width/u),m=new J({xmin:l.center.x-u*h,ymin:l.center.y-u*h,xmax:l.center.x+u*h,ymax:l.center.y+u*h,spatialReference:l.spatialReference});return new k({floors:a,gdbVersion:"gdbVersion"in i?i.gdbVersion:void 0,geometry:t,height:h,layerOption:"popup",mapExtent:m,returnGeometry:!0,spatialReference:s,sublayers:i.sublayers,timeExtent:o,tolerance:y,width:h})}async _fetchPopupFeaturesUsingQueries(t,e,r){const{layerView:{floors:a,timeExtent:i}}=this,o=e.map(async({sublayer:s,popupTemplate:c})=>{var v,H,G;if(await s.load(r).catch(()=>{}),s.capabilities&&!s.capabilities.operations.supportsQuery)return[];const y=s.createQuery(),l=U({renderer:s.renderer,pointerType:r==null?void 0:r.pointerType}),u=this.createFetchPopupFeaturesQueryGeometry(t,l),h=new Set,[m]=await Promise.all([je(s,c),(v=s.renderer)==null?void 0:v.collectRequiredFields(h,s.fieldsIndex)]);M(r),$e(h,s.fieldsIndex,m);const x=Array.from(h).sort();y.geometry=u,y.outFields=x,y.timeExtent=i;const _=R(a,s);if(y.where=T(y.where,_),((H=s.capabilities)==null?void 0:H.query.supportsOrderBy)&&((G=s.orderBy)==null?void 0:G[0])){const g=s.orderBy[0],$=!g.valueExpression&&g.field,E=g.order==="ascending"?"asc":"desc";$&&(y.orderByFields=[`${$} ${E}`])}const P=this._getTargetResolution(u.width/l),f=await qe(c);M(r);const F=s.geometryType==="point"||f&&f.arcadeUtils.hasGeometryOperations(c);F||(y.maxAllowableOffset=P);let{features:b}=await s.queryFeatures(y,r);const w=F?0:P;b=await De(s,b,r);for(const g of b)this._featuresResolutions.set(g,w);return b});return(await Promise.allSettled(o)).reduce((s,c)=>c.status==="fulfilled"?[...s,...c.value]:s,[]).filter(_e)}};function Je(t,e,r){const a=[];if(!t)return a;const i=o=>{const s=o.minScale===0||e<=o.minScale,c=o.maxScale===0||e>=o.maxScale;if(o.visible&&s&&c){if(o.sublayers)o.sublayers.forEach(i);else if(o.popupEnabled){const y=Ie(o,{...r,defaultPopupTemplateEnabled:!1});y!=null&&a.unshift({sublayer:o,popupTemplate:y})}}};return t.map(i),a}function qe(t){var e;return(e=t.expressionInfos)!=null&&e.length||Array.isArray(t.content)&&t.content.some(r=>r.type==="expression")?Se():Promise.resolve()}async function ze(t,e){var r,a;if((a=(r=t.capabilities)==null?void 0:r.operations)!=null&&a.supportsQuery)return!0;try{return await Promise.any(e.map(({sublayer:i})=>i.load().then(()=>i.capabilities.operations.supportsQuery)))}catch{return!1}}async function De(t,e,r){const a=t.renderer;return a&&"defaultSymbol"in a&&!a.defaultSymbol&&(e=a.valueExpression?await Promise.all(e.map(i=>a.getSymbolAsync(i,r).then(o=>o?i:null))).then(i=>i.filter(o=>o!=null)):e.filter(i=>a.getSymbol(i)!=null)),e}n([p({constructOnly:!0})],V.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),n([p({constructOnly:!0})],V.prototype,"layerView",void 0),n([p({constructOnly:!0})],V.prototype,"highlightGraphics",void 0),n([p({constructOnly:!0})],V.prototype,"highlightGraphicUpdated",void 0),n([p({constructOnly:!0})],V.prototype,"updatingHandles",void 0),n([p()],V.prototype,"_updateContext",null),V=n([N("esri.views.layers.support.MapServiceLayerViewHelper")],V);let O=class extends z{constructor(t){super(t)}initialize(){this._highlightHelper=new Ee({layer:this.layerView.layer,view:this.view,updatingHandles:this.updatingHandles}),this._mapServiceLayerViewHelper=new V({createFetchPopupFeaturesQueryGeometry:(t,e)=>Ve(t,e,this.view),layerView:this.layerView,updatingHandles:this.updatingHandles,highlightGraphics:this._highlightHelper.graphics,highlightGraphicUpdated:t=>{var e;return(e=this._highlightHelper.graphicsView)==null?void 0:e.graphicChanged(t)}}),this.addHandles([Fe(this._mapServiceLayerViewHelper),Pe(()=>{var t;return this._mapServiceLayerViewHelper.highlightFeaturesActive&&((t=this.view)==null?void 0:t.stationary)},()=>D(this._mapServiceLayerViewHelper.updateHighlightedFeatures(this.view.resolution)),He),Ge(()=>this.layerView.suspended,t=>this._highlightHelper.suspended=t,Oe)])}fetchPopupFeaturesAtLocation(t,e){return this._highlightHelper.preload(),this._mapServiceLayerViewHelper.fetchPopupFeaturesAtLocation(t,e)}highlight(t,e){return this._highlightHelper.highlight(t,e)}};n([p()],O.prototype,"view",void 0),n([p()],O.prototype,"layerView",void 0),n([p()],O.prototype,"updatingHandles",void 0),O=n([N("esri.views.3d.layers.support.SublayerPopupHighlightHelper3D")],O);export{Xe as S,O as m};
