import{eg as b,K as F,cF as L,eh as A,ei as D,dE as M,ej as N,ek as K,el as j}from"./index-DfdgIpb3.js";import{a as q}from"./dehydratedFeatureComparison-etbjZifi.js";import{D as B}from"./InteractiveToolBase-BH3EjUBz.js";import{e as J}from"./SnappingContext-BdU545yp.js";function te({predicate:e=()=>!0,snappingManager:n,snappingContext:o,updatingHandles:a,useZ:t=!0}){const i=new B;if(n==null)return{snappingStep:[z,i],cancelSnapping:z};let p,u=null,l=null,c=null;const f=()=>{u=L(u),n.doneSnapping(),l==null||l.frameTask.remove(),l=null,p=A(p),c=null},m=Q(n,t,i);let d=null,s=null,Z=null;return{snappingStep:[r=>{if(!e(r))return r;const{action:P}=r;if(P==="start"){const{info:x}=r,S=R(n.view);if(l=V(o,r,S),l.context.selfSnappingZ=null,!t&&x!=null){const g=X(o.coordinateHelper,x.handle.part);g!=null&&(l.context.selfSnappingZ={value:g,elevationInfo:o.elevationInfo??b})}}if(l!=null){const{context:x,originalScenePos:S,originalPos:g}=l,{mapEnd:T,mapStart:k,scenePoints:U}=r,v=I(g,y(T,k)),$=y(k,g),C={...r,action:"update"},G=l.context,h=W(S,U),w=n.update({point:v,scenePoint:h,context:x});if(Z=w,E(T,w,$,t),d=v,s=h,P!=="end"){const{frameTask:H}=l;u==null&&(u=new AbortController),c=O=>{a.addPromise(K(m({frameTask:H,event:C,context:G,point:v,scenePoint:h,delta:$,getLastState:()=>({point:d,scenePoint:s,updatePoint:O.forceUpdate?null:Z})},u.signal)))},c({forceUpdate:!1}),p==null&&(p=F(()=>n.options.effectiveEnabled,()=>c==null?void 0:c({forceUpdate:!0})))}}return P==="end"&&f(),r},i],cancelSnapping:r=>(f(),r)}}function Q(e,n,o){return j(async({frameTask:a,point:t,scenePoint:i,context:p,event:u,delta:l,getLastState:c},f)=>{const m=await a.schedule(()=>e.snap({point:t,scenePoint:i,context:p,signal:f}),f);if(m.valid){let d=await a.schedule(()=>m.apply(),f);const s=c();s.point!=null&&t!==s.point&&(d=e.update({point:s.point,scenePoint:s.scenePoint,context:p})),s.updatePoint!=null&&q(d,s.updatePoint)||(E(u.mapEnd,d,l,n),o.execute(u))}})}function R(e){return e.type==="3d"?e.resourceController.scheduler.registerTask(M.SNAPPING):D}function V(e,n,o){return{context:new J({editGeometryOperations:e.editGeometryOperations,elevationInfo:e.elevationInfo,pointer:e.pointer,vertexHandle:n.info!=null?n.info.handle:null,excludeFeature:e.excludeFeature,feature:e.feature,visualizer:e.visualizer}),originalPos:n.snapOrigin!=null?e.coordinateHelper.vectorToDehydratedPoint(n.snapOrigin):n.mapStart,originalScenePos:n.scenePoints!=null?n.scenePoints.sceneStart:null,frameTask:o}}function I(e,[n,o,a]){const t=N(e);return t.x+=n,t.y+=o,t.hasZ&&(t.z+=a),t}function W(e,n){return e==null||n==null?null:I(e,y(n.sceneEnd,n.sceneStart))}function y(e,n){const o=e.hasZ&&n.hasZ?e.z-n.z:0;return[e.x-n.x,e.y-n.y,o]}function E(e,n,[o,a,t],i){e.x=n.x+o,e.y=n.y+a,i&&e.hasZ&&n.hasZ&&(e.z=n.z+t)}function X(e,n){if(!e.hasZ())return null;const o=n.vertices;let a=null;for(const t of o){const i=e.getZ(t.pos);if(a!=null&&i!=null&&Math.abs(i-a)>1e-6)return null;a==null&&(a=i)}return a}function z(e){return e}export{te as f};
