import{l9 as O,la as $,lb as G,d4 as k,d3 as T}from"./index-5QWH35TG.js";import{Y as F,a as j,m as q}from"./CIMSymbolHelper-VnRg_axk.js";import{OverrideHelper as A}from"./OverrideHelper-jslHx691.js";import{T as S,R as D}from"./rasterizingUtils-DmccrIuA.js";import"./BidiEngine-BvER9tXK.js";import"./labelPoint-DsLinSRF.js";import"./mat2d-Dk-wCGIn.js";import"./mat2df32-Dpt2CT5P.js";import"./callExpressionWithFeature-CqAeJ4tc.js";class B{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(t){return this._resourceMap.get(t)??null}async fetchResource(t,a){const n=this._resourceMap.get(t);if(n)return{width:n.width,height:n.height};let c=this._inFlightResourceMap.get(t);return c?c.then(m=>({width:m.width,height:m.height})):(c=O(t,a),this._inFlightResourceMap.set(t,c),c.then(m=>(this._inFlightResourceMap.delete(t),this._resourceMap.set(t,m),{width:m.width,height:m.height}),()=>({width:0,height:0})))}deleteResource(t){this._inFlightResourceMap.delete(t),this._resourceMap.delete(t)}loadFont(t){return $(t)}}const H=96/72;class Z{constructor(t){this._spatialReference=t,this._imageDataCanvas=null,this._cimResourceManager=new B}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,a,n,c,m,o,d,g,w,R){if(!t)return null;const{data:p}=t;if(!p||p.type!=="CIMSymbolReference"||!p.symbol)return null;const{symbol:C}=p;o||(o=G(C));const l=await A.resolveSymbolOverrides(p,a,this._spatialReference,m,o,d,g),M=this._cimResourceManager,_=[];F.fetchResources(l,M,_),F.fetchFonts(l,M,_),_.length>0&&await Promise.all(_);const{width:i,height:r}=n;let y=z(o,i,r,c,R);const e=F.getEnvelope(l,y,M);if(!e)return null;e.x===1/0&&(e.x=i+2),e.y===1/0&&(e.y=-r/2),e.width===-1/0&&(e.width=i),e.height===-1/0&&(e.height=r);let u=1,I=0,v=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let h=1;e.width>i&&(h=i/e.width);let s=1;e.height>r&&(s=r/e.height),c==="preview"&&(e.width<i&&(h=i/e.width),e.height<r&&(s=r/e.height)),u=Math.min(h,s),I=e.x+e.width/2,v=e.y+e.height/2}break;case"CIMLineSymbol":if(R){v=e.y+e.height/2,I=e.x+e.width/2;const h=e.width-i,s=e.height-r;y={paths:S(y.paths,{xmin:-1*e.width/2+h,xmax:e.width/2-h,ymin:-1*e.height/2+s,ymax:e.height/2-s,width:e.width-2*h,height:e.height-2*s})}}else{(w||e.height>r)&&(u=r/e.height),v=e.y+e.height/2;const h=e.x*u+i/2,s=(e.x+e.width)*u+i/2,b=k(y)?y.paths:T(y)?y.rings:null;if(b===null)throw new Error("Bad geometry, can't rasterise symbol!");b[0][0][0]-=h/u,b[0][2][0]-=(s-i)/u}break;case"CIMPolygonSymbol":if(R){v=e.y+e.height/2,I=e.x+e.width/2;const h=e.width-i,s=e.height-r;y={paths:S(y.rings,{xmin:-1*e.width/2+h,xmax:e.width/2-h,ymin:-1*e.height/2+s,ymax:e.height/2-s,width:e.width-2*h,height:e.height-2*s})}}else{I=e.x+e.width/2,v=e.y+e.height/2;const h=e.x*u+i/2,s=(e.x+e.width)*u+i/2,b=e.y*u+r/2,P=(e.y+e.height)*u+r/2,{rings:f}=y;h<0&&(f[0][0][0]-=h,f[0][3][0]-=h,f[0][4][0]-=h),b<0&&(f[0][0][1]+=b,f[0][1][1]+=b,f[0][4][1]+=b),s>i&&(f[0][1][0]-=s-i,f[0][2][0]-=s-i),P>r&&(f[0][2][1]+=P-r,f[0][3][1]+=P-r)}}const E={type:"cim",data:{type:"CIMSymbolReference",symbol:l}};return this.rasterize(E,i,r,I,v,u,o,1,y)}rasterize(t,a,n,c,m,o,d,g=0,w=null,R=window.devicePixelRatio||1){const{data:p}=t;if(!p||p.type!=="CIMSymbolReference"||!p.symbol)return null;const{symbol:C}=p,l=this._canvas,M=R*H;l.width=a*M,l.height=n*M,d||(d=G(C)),w||(w=z(d,a,n,"legend")),l.width+=2*g,l.height+=2*g;const _=l.getContext("2d",{willReadFrequently:!0}),i=j.createIdentity();return i.translate(-c,-m),i.scale(o*M,-o*M),i.translate(a*M/2+g,n*M/2+g),_.clearRect(0,0,l.width,l.height),new q(_,this._cimResourceManager,i,!0).drawSymbol(C,w),_.getImageData(0,0,l.width,l.height)}}function L(x,t,a,n){return t==="esriGeometryPolygon"?{rings:D(S(x.rings,{xmin:0,ymin:0,width:a,height:n}),-1*a/2,-1*n/2)}:t==="esriGeometryPolyline"?{paths:D(S(x.paths,{xmin:0,ymin:0,width:a,height:n}),-1*a/2,-1*n/2)}:null}function z(x,t,a,n,c){const o=-t/2+1,d=t/2-1,g=a/2-1,w=-a/2+1;if(c&&(x==="esriGeometryPolygon"||x==="esriGeometryPolyline")){const R=L(c,x,t,a);if(R)return R}switch(x){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[o,0],[0,0],[d,0]]]};default:return n==="legend"?{rings:[[[o,g],[d,0],[d,w],[o,w],[o,g]]]}:{rings:[[[o,g],[d,g],[d,w],[o,w],[o,g]]]}}}export{Z as CIMSymbolRasterizer};
